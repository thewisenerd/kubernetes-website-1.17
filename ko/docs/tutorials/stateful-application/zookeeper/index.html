<!DOCTYPE html>
<html id="docs" lang="ko" class="">
	<head>
	

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-36037335-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-36037335-10');
</script>
<meta charset="utf-8">
<title>분산 시스템 코디네이터 ZooKeeper 실행하기 - Kubernetes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#326ce5">
<link rel="shortcut icon" type="image/png" href="/images/favicon.png">









<link rel="stylesheet" href="/css/style.b7b8403eb5b1fddd0a2da2a8383d5b53e6ef81c23e4b0e292e6103bd91f9502d.css" integrity="sha256-t7hAPrWx/d0KLaKoOD1bU&#43;bvgcI&#43;Sw4pLmEDvZH5UC0=">


<link rel="stylesheet" href="/css/base_fonts.css">
<link rel="stylesheet" href="/css/jquery-ui.min.css">
<link rel="stylesheet" href="/css/callouts.css">
<link rel="stylesheet" href="/css/custom-jekyll/tags.css">



<meta name="description" content="">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:url" content="https://kubernetes.io/ko/docs/tutorials/stateful-application/zookeeper/">
<meta property="og:title" content="분산 시스템 코디네이터 ZooKeeper 실행하기">
<meta name="twitter:title" content="분산 시스템 코디네이터 ZooKeeper 실행하기">
<meta name="twitter:image" content="https://kubernetes.io/images/favicon.png" />

<meta name="twitter:image:alt" content="Kubernetes">

<meta property="og:image" content="/images/kubernetes-horizontal-color.png">

<meta property="og:type" content="article">
<script src="/js/anchor-4.1.1.min.js"></script>
<script src="/js/jquery-3.2.1.min.js"></script>
<script src="/js/jquery-ui-1.12.1.min.js"></script>
<script src="/js/bootstrap-4.3.1.min.js"></script>
<script src="/js/sweetalert-2.1.2.min.js"></script>

<script src="/js/script.js"></script>
<script src="/js/custom-jekyll/tags.js"></script>


	</head>
	<body>
		<div id="cellophane" onclick="kub.toggleMenu()"></div>

<header>
    <a href="/ko/" class="logo" title="운영 수준의 컨테이너 오케스트레이션 - Kubernetes" aria-label="Kubernetes website"></a>

    <div class="nav-buttons" data-auto-burger="primary">
        <ul class="global-nav">
            
            
            <li><a href="/ko/docs/" class="active">문서</a></li>
            
            
            
            <li><a href="/ko/training/">교육</a></li>
            
            
            
            
            
            <li><a href="/ko/case-studies/">사례 연구</a></li>
            
            
            
             <li>
                <a href="#">
                    한국어 Korean <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                    <li><a href="/docs/tutorials/stateful-application/zookeeper/">English</a></li>
                
                    <li><a href="/zh/docs/tutorials/stateful-application/zookeeper/">中文 Chinese</a></li>
                
                </ul>
            </li>

            <li>
                <a href="#">
                    v1.17 <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                    <li><a href="https://kubernetes.io/ko/docs/tutorials/stateful-application/zookeeper/">v1.21</a></li>
                
                    <li><a href="https://v1-20.docs.kubernetes.io/ko/docs/tutorials/stateful-application/zookeeper/">v1.20</a></li>
                
                    <li><a href="https://v1-19.docs.kubernetes.io/ko/docs/tutorials/stateful-application/zookeeper/">v1.19</a></li>
                
                    <li><a href="https://v1-18.docs.kubernetes.io/ko/docs/tutorials/stateful-application/zookeeper/">v1.18</a></li>
                
                    <li><a href="https://v1-17.docs.kubernetes.io/ko/docs/tutorials/stateful-application/zookeeper/">v1.17</a></li>
                
                </ul>
            </li>
        </ul>
        
        <a href="/ko/docs/tutorials/kubernetes-basics/" class="button" id="tryKubernetes" data-auto-burger-exclude>쿠버네티스 기초 학습</a>
        

        <button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
    </div>

    <nav id="mainNav">
        <div class="main-section" data-auto-burger="primary">
         
           <div class="nav-box">
            <h3><a href="/ko/docs/tutorials/hello-minikube/">Get Started</a></h3>
           <p>Ready to get your hands dirty? Build a simple Kubernetes cluster that runs "Hello World" for Node.js.</p>

            </div>
         
           <div class="nav-box">
            <h3><a href="/ko/docs/home/">문서</a></h3>
           <p>개념, 튜토리얼 및 참조 문서와 함께 쿠버네티스 사용하는 방법을 익힐 수 있다. 또한, <a href="/editdocs/" data-auto-burger-exclude>문서에 기여하는 것도 도움을 줄 수 있다</a>!</p>

            </div>
         
        </div>
        <div class="main-section" data-auto-burger="primary">
            <div class="left">
                <h5 class="github-invite">코어 쿠버네티스 코드 베이스를 살펴보는데 관심이 있으십니까?</h5>
                <a href="https://github.com/kubernetes/kubernetes" class="button" data-auto-burger-exclude>GitHub에서 보기</a>
            </div>

            <div class="right">
                <h5 class="github-invite">커뮤니티 둘러보기</h5>
                <div class="social">
                    <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                    <a href="https://github.com/kubernetes/kubernetes" class="github"><span>GitHub</span></a>
                    <a href="http://slack.k8s.io/" class="slack"><span>Slack Slack</span></a>
                    <a href="https://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                    <a href="https://www.youtube.com/kubernetescommunity" class="youtube"><span>YouTube</span></a>
                    <a href="https://discuss.kubernetes.io" class="mailing-list"><span>Forum</span></a>
                    <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>이벤트 캘린더</span></a>
                </div>
            </div>
            <div class="clear" style="clear: both"></div>
        </div>
    </nav>
</header>

		
		
		<section id="hero" class="light-text no-sub">
			













<h1>튜토리얼</h1>
<h5></h5>






<div id="vendorStrip" class="light-text">
	<ul>
		
		
		<li><a href="/ko/docs/home/">홈</a></li>
		
		
		<li><a href="/ko/docs/setup/">시작하기</a></li>
		
		
		<li><a href="/ko/docs/concepts/">개념</a></li>
		
		
		<li><a href="/ko/docs/tasks/">태스크</a></li>
		
		
		<li><a href="/ko/docs/tutorials/" class="YAH">튜토리얼</a></li>
		
		
		<li><a href="/ko/docs/reference/">레퍼런스</a></li>
		
		
		<li><a href="/ko/docs/contribute/">기여</a></li>
		
	</ul>
	<form id="searchBox" action="/docs/search/" role="search">
		<input type="text" id="search" name="q" placeholder="검색하기" aria-label="Search">
	</form>
</div>

		</section>
		
    
		
<section id="deprecationWarning">
  <main>
    <div class="content deprecation-warning">
      <h3>
	 Kubernetes v1.17
	  문서는 더 이상 적극적으로 관리되지 않음. 현재 보고있는 문서는 정적 스냅샷임. 최신 문서를 위해서는, 다음을 참고. 
	 <a href="https://kubernetes.io/docs/home/">최신 버전.</a>
      </h3>
    </div>
  </main>
</section>


    <main>
        <section id="encyclopedia">
          
<div id="docsToc">
     <div class="pi-accordion">
    	
        
        
        
        
        
         
             
                 
             
         
             
                 
             
         
             
                 
             
         
             
                 
             
         
             
                 
                          
                          
                 
             
         
             
         
             
         
         
        
        <a class="item" data-title="튜토리얼" href="/ko/docs/tutorials/"></a>

	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="Hello Minikube" href="/ko/docs/tutorials/hello-minikube/"></a>

		
	
		
			
<div class="item" data-title="쿠버네티스 기초 학습">
	<div class="container">
		
		
		
		<a class="item" data-title="쿠버네티스 기초 학습" href="/ko/docs/tutorials/kubernetes-basics/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			
<div class="item" data-title="클러스터 생성하기">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="Minikube를 사용해서 클러스터 생성하기" href="/ko/docs/tutorials/kubernetes-basics/create-cluster/cluster-intro/"></a>

		
	
		
			

<a class="item" data-title="대화형 튜토리얼 - 클러스터 생성하기" href="/ko/docs/tutorials/kubernetes-basics/create-cluster/cluster-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="앱 배포하기">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="kubectl을 사용해서 디플로이먼트 생성하기" href="/ko/docs/tutorials/kubernetes-basics/deploy-app/deploy-intro/"></a>

		
	
		
			

<a class="item" data-title="대화형 튜토리얼 - 앱 배포하기" href="/ko/docs/tutorials/kubernetes-basics/deploy-app/deploy-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="앱 조사하기">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="파드와 노드 보기" href="/ko/docs/tutorials/kubernetes-basics/explore/explore-intro/"></a>

		
	
		
			

<a class="item" data-title="대화형 튜토리얼 - 앱 조사하기" href="/ko/docs/tutorials/kubernetes-basics/explore/explore-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="앱 외부로 노출하기">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="앱 노출을 위해 서비스 이용하기" href="/ko/docs/tutorials/kubernetes-basics/expose/expose-intro/"></a>

		
	
		
			

<a class="item" data-title="대화형 튜토리얼 - 앱 노출하기" href="/ko/docs/tutorials/kubernetes-basics/expose/expose-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="앱 스케일링하기">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="복수의 앱 인스턴스를 구동하기" href="/ko/docs/tutorials/kubernetes-basics/scale/scale-intro/"></a>

		
	
		
			

<a class="item" data-title="대화형 튜토리얼 - 앱 스케일링하기" href="/ko/docs/tutorials/kubernetes-basics/scale/scale-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="앱 업데이트하기">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="롤링 업데이트 수행하기" href="/ko/docs/tutorials/kubernetes-basics/update/update-intro/"></a>

		
	
		
			

<a class="item" data-title="대화형 튜토리얼 - 앱 업데이트 하기" href="/ko/docs/tutorials/kubernetes-basics/update/update-interactive/"></a>

		
	

	</div>
</div>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="설정">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="컨피그 맵을 사용해서 Redis 설정하기" href="/ko/docs/tutorials/configuration/configure-redis-using-configmap/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="상태 유지를 하지 않는 애플리케이션">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="외부 IP 주소를 노출하여 클러스터의 애플리케이션에 접속하기" href="/ko/docs/tutorials/stateless-application/expose-external-ip-address/"></a>

		
	
		
			

<a class="item" data-title="예시: Redis를 사용한 PHP 방명록 애플리케이션 배포하기" href="/ko/docs/tutorials/stateless-application/guestbook/"></a>

		
	
		
			

<a class="item" data-title="예제: PHP / Redis 방명록 예제에 로깅과 메트릭 추가" href="/ko/docs/tutorials/stateless-application/guestbook-logs-metrics-with-elk/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="상태 유지가 필요한(stateful) 애플리케이션">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="스테이트풀셋 기본" href="/ko/docs/tutorials/stateful-application/basic-stateful-set/"></a>

		
	
		
			

<a class="item" data-title="예시: WordPress와 MySQL을 퍼시스턴트 볼륨에 배포하기" href="/ko/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/"></a>

		
	
		
			

<a class="item" data-title="예시: 카산드라를 스테이트풀셋으로 배포하기" href="/ko/docs/tutorials/stateful-application/cassandra/"></a>

		
	
		
			

<a class="item" data-title="분산 시스템 코디네이터 ZooKeeper 실행하기" href="/ko/docs/tutorials/stateful-application/zookeeper/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="클러스터">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="AppArmor" href="/ko/docs/tutorials/clusters/apparmor/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="서비스">
	<div class="container">
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="소스 IP 주소 이용하기" href="/ko/docs/tutorials/services/source-ip/"></a>

		
	

	</div>
</div>

		
	





     </div> 
    <button class="push-menu-close-button" onclick="kub.toggleToc()"></button>
</div> 


          <div id="docsContent">
            

<p>
  <a href="https://github.com/kubernetes/website/edit/master/content/ko/docs/tutorials/stateful-application/zookeeper.md" id="editPageButton" target="_blank">
    Edit This Page
  </a>
</p>

<h1>분산 시스템 코디네이터 ZooKeeper 실행하기</h1>



<p>이 튜토리얼은 <a href="https://zookeeper.apache.org" target="_blank">아파치 ZooKeeper</a>
쿠버네티스에서 <a href="/ko/docs/concepts/workloads/controllers/statefulset/">스테이트풀셋</a>과
<a href="/ko/docs/concepts/workloads/pods/disruptions/#specifying-a-poddisruptionbudget">파드디스룹선버짓(PodDisruptionBudget)</a>과
<a href="/ko/docs/user-guide/node-selection/#파드간-어피니티와-안티-어피니티">파드안티어피니티(PodAntiAffinity)</a>를 이용한 <a href="https://zookeeper.apache.org" target="_blank">Apache Zookeeper</a> 실행을 설명한다.</p>












<ul id="markdown-toc">










<li><a href="#%eb%aa%a9%ec%a0%81">목적</a></li>












<li><a href="#%ec%8b%9c%ec%9e%91%ed%95%98%ea%b8%b0-%ec%a0%84%ec%97%90">시작하기 전에</a></li>












<li><a href="#zookeeper-%ec%95%99%ec%83%81%eb%b8%94-%ec%83%9d%ec%84%b1%ed%95%98%ea%b8%b0">ZooKeeper 앙상블 생성하기</a></li>




<li><a href="#%ec%9d%bc%ea%b4%80%eb%90%9c-%ea%b5%ac%ec%84%b1-%eb%b3%b4%ec%9e%a5%ed%95%98%ea%b8%b0">일관된 구성 보장하기</a></li>




<li><a href="#zookeeper-%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4-%ea%b4%80%eb%a6%ac%ed%95%98%ea%b8%b0">ZooKeeper 프로세스 관리하기</a></li>




<li><a href="#%eb%85%b8%eb%93%9c-%ec%8b%a4%ed%8c%a8-%eb%b0%a9%ec%a7%80">노드 실패 방지</a></li>




<li><a href="#%ec%83%9d%ec%a1%b4-%ec%9c%a0%ec%a7%80">생존 유지</a></li>




















<li><a href="#%ec%a0%95%eb%a6%ac%ed%95%98%ea%b8%b0">정리하기</a></li>











</ul>



<h2 id="목적">목적</h2>
<p>이 튜토리얼을 마치면 다음에 대해 알게 된다.</p>

<ul>
<li>어떻게 스테이트풀셋을 이용하여 ZooKeeper 앙상블을 배포하는가.</li>
<li>어떻게 지속적해서 컨피그맵을 이용해서 앙상블을 설정하는가.</li>
<li>어떻게 ZooKeeper 서버 디플로이먼트를 앙상블 안에서 퍼뜨리는가.</li>
<li>어떻게 파드디스룹션버짓을 이용하여 계획된 점검 기간 동안 서비스 가용성을 보장하는가.
<br /></li>
</ul>





<h2 id="시작하기-전에">시작하기 전에</h2>
<p>이 튜토리얼을 시작하기 전에
다음 쿠버네티스 개념에 친숙해야 한다.</p>

<ul>
<li><a href="/docs/user-guide/pods/single-container/">파드</a></li>
<li><a href="/ko/docs/concepts/services-networking/dns-pod-service/">클러스터 DNS</a></li>
<li><a href="/ko/docs/concepts/services-networking/service/#헤드리스-headless-서비스">헤드리스 서비스</a></li>
<li><a href="/ko/docs/concepts/storage/volumes/">퍼시스턴트볼륨</a></li>
<li><a href="https://github.com/kubernetes/examples/tree/v1.17.17/staging/persistent-volume-provisioning/" target="_blank">퍼시스턴트볼륨 프로비저닝</a></li>
<li><a href="/ko/docs/concepts/workloads/controllers/statefulset/">스테이트풀셋</a></li>
<li><a href="/ko/docs/concepts/workloads/pods/disruptions/#specifying-a-poddisruptionbudget">파드디스룹션버짓</a></li>
<li><a href="/ko/docs/user-guide/node-selection/#파드간-어피니티와-안티-어피니티">파드안티어피니티</a></li>
<li><a href="/docs/user-guide/kubectl/">kubectl CLI</a></li>
</ul>

<p>최소한 4개의 노드가 있는 클러스터가 필요하며, 각 노드는 적어도 2 개의 CPU와 4 GiB 메모리가 필요하다. 이 튜토리얼에서 클러스터 노드를 통제(cordon)하고 비우게(drain) 할 것이다. <strong>이것은 클러스터를 종료하여 노드의 모든 파드를 퇴출(evict)하는 것으로, 모든 파드는 임시로 언스케줄된다는 의미이다.</strong> 이 튜토리얼을 위해 전용 클러스터를 이용하거나, 다른 테넌트에 간섭을 하는 혼란이 발생하지 않도록 해야 합니다.</p>

<p>이 튜토리얼은 클러스터가 동적으로 퍼시스턴트볼륨을 프로비저닝하도록 구성한다고 가정한다.
그렇게 설정되어 있지 않다면
튜토리얼을 시작하기 전에 수동으로 3개의 20 GiB 볼륨을
프로비저닝해야 한다.</p>




<h3 id="zookeeper-basics">ZooKeeper 기본</h3>

<p><a href="https://zookeeper.apache.org/doc/current/" target="_blank">아파치 ZooKeeper</a>는
분산 애플리케이션을 위한 분산 오픈 소스 코디네이션 서비스이다.
ZooKeeper는 데이터를 읽고 쓰고 갱신을 지켜보도록 한다. 데이터는
파일시스템처럼 계층적으로 관리되고 앙상블(ZooKeeper 서버의 집합) 내에 모든 ZooKeeper서버에 복제된다.
데이터에 모든 연산은 원자적이고 순처적으로 일관된다. ZooKeeper는
<a href="https://pdfs.semanticscholar.org/b02c/6b00bd5dbdbd951fddb00b906c82fa80f0b3.pdf" target="_blank">Zab</a> 합의 프로토콜을
이용하여 앙상블 내에 모든 서버에 걸쳐 상태 머신을 복제하여 이를 보장한다.</p>

<p>앙상블은 리더 선출을 위해 Zab 프로토콜을 사용하고, 리더 선출과 선거가 완료되기 전까지 앙상블은 데이터를 쓸 수 없다. 완료되면 앙상블은 Zab을 이용하여 확인하고 클라이언트에 보이도록 모든 쓰기를 쿼럼(quorum)에 복제한다. 가중치있는 쿼럼과 관련 없이, 쿼럼은 현재 리더를 포함하는 앙상블의 대다수 컴포넌트이다. 예를 들어 앙상블이 3개 서버인 경우, 리더와 다른 서버로 쿼럼을 구성한다. 앙상블이 쿼럼을 달성할 수 없다면, 앙상블은 데이터를 쓸 수 없다.</p>

<p>ZooKeeper는 전체 상태 머신을 메모리에 보존하고 모든 돌연변이를 저장 미디어의 내구성 있는 WAL(Write Ahead Log)에 기록한다. 서버 장애시 WAL을 재생하여 이전 상태를 복원할 수 있다. WAL이 무제한으로 커지는 것을 방지하기 위해 ZooKeeper는 주기적으로 저장 미디어에 메모리 상태의 스냅샷을 저장한다. 이 스냅샷은 메모리에 직접 적재할 수 있고 스냅샷 이전의 모든 WAL 항목은 삭제될 수 있다.</p>

<h2 id="zookeeper-앙상블-생성하기">ZooKeeper 앙상블 생성하기</h2>

<p>아래 메니페스트에는
<a href="/ko/docs/concepts/services-networking/service/#헤드리스-headless-서비스">헤드리스 서비스</a>,
<a href="/ko/docs/concepts/services-networking/service/">서비스</a>,
<a href="/ko/docs/concepts/workloads/pods/disruptions//#specifying-a-poddisruptionbudget">파드디스룹션버짓</a>,
<a href="/ko/docs/concepts/workloads/controllers/statefulset/">스테이트풀셋</a>을 포함한다.</p>

<table class="includecode" id="application-zookeeper-zookeeper-yaml">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/ko/examples/application/zookeeper/zookeeper.yaml" download="application/zookeeper/zookeeper.yaml">
                    <code>application/zookeeper/zookeeper.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode('application-zookeeper-zookeeper-yaml')" title="Copy application/zookeeper/zookeeper.yaml to clipboard">
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk-hs<span style="color:#bbb">
</span><span style="color:#bbb">  </span>labels:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>ports:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>port:<span style="color:#bbb"> </span><span style="color:#666">2888</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>name:<span style="color:#bbb"> </span>server<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>port:<span style="color:#bbb"> </span><span style="color:#666">3888</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>name:<span style="color:#bbb"> </span>leader-election<span style="color:#bbb">
</span><span style="color:#bbb">  </span>clusterIP:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk-cs<span style="color:#bbb">
</span><span style="color:#bbb">  </span>labels:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>ports:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>port:<span style="color:#bbb"> </span><span style="color:#666">2181</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>name:<span style="color:#bbb"> </span>client<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>policy/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>PodDisruptionBudget<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk-pdb<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>matchLabels:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">  </span>maxUnavailable:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>StatefulSet<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>matchLabels:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">  </span>serviceName:<span style="color:#bbb"> </span>zk-hs<span style="color:#bbb">
</span><span style="color:#bbb">  </span>replicas:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>updateStrategy:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>type:<span style="color:#bbb"> </span>RollingUpdate<span style="color:#bbb">
</span><span style="color:#bbb">  </span>podManagementPolicy:<span style="color:#bbb"> </span>OrderedReady<span style="color:#bbb">
</span><span style="color:#bbb">  </span>template:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>labels:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">    </span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>affinity:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>podAntiAffinity:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>requiredDuringSchedulingIgnoredDuringExecution:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>labelSelector:<span style="color:#bbb">
</span><span style="color:#bbb">                </span>matchExpressions:<span style="color:#bbb">
</span><span style="color:#bbb">                  </span>-<span style="color:#bbb"> </span>key:<span style="color:#bbb"> </span><span style="color:#b44">&#34;app&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">                    </span>operator:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>values:<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>-<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">              </span>topologyKey:<span style="color:#bbb"> </span><span style="color:#b44">&#34;kubernetes.io/hostname&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span>containers:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>kubernetes-zookeeper<span style="color:#bbb">
</span><span style="color:#bbb">        </span>imagePullPolicy:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span><span style="color:#bbb">        </span>image:<span style="color:#bbb"> </span><span style="color:#b44">&#34;k8s.gcr.io/kubernetes-zookeeper:1.0-3.4.10&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>resources:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>requests:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>memory:<span style="color:#bbb"> </span><span style="color:#b44">&#34;1Gi&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span>cpu:<span style="color:#bbb"> </span><span style="color:#b44">&#34;0.5&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>ports:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>containerPort:<span style="color:#bbb"> </span><span style="color:#666">2181</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>name:<span style="color:#bbb"> </span>client<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>containerPort:<span style="color:#bbb"> </span><span style="color:#666">2888</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>name:<span style="color:#bbb"> </span>server<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>containerPort:<span style="color:#bbb"> </span><span style="color:#666">3888</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>name:<span style="color:#bbb"> </span>leader-election<span style="color:#bbb">
</span><span style="color:#bbb">        </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;start-zookeeper \
</span><span style="color:#b44">          --servers=3 \
</span><span style="color:#b44">          --data_dir=/var/lib/zookeeper/data \
</span><span style="color:#b44">          --data_log_dir=/var/lib/zookeeper/data/log \
</span><span style="color:#b44">          --conf_dir=/opt/zookeeper/conf \
</span><span style="color:#b44">          --client_port=2181 \
</span><span style="color:#b44">          --election_port=3888 \
</span><span style="color:#b44">          --server_port=2888 \
</span><span style="color:#b44">          --tick_time=2000 \
</span><span style="color:#b44">          --init_limit=10 \
</span><span style="color:#b44">          --sync_limit=5 \
</span><span style="color:#b44">          --heap=512M \
</span><span style="color:#b44">          --max_client_cnxns=60 \
</span><span style="color:#b44">          --snap_retain_count=3 \
</span><span style="color:#b44">          --purge_interval=12 \
</span><span style="color:#b44">          --max_session_timeout=40000 \
</span><span style="color:#b44">          --min_session_timeout=4000 \
</span><span style="color:#b44">          --log_level=INFO&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>readinessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>livenessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>volumeMounts:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>datadir<span style="color:#bbb">
</span><span style="color:#bbb">          </span>mountPath:<span style="color:#bbb"> </span>/var/lib/zookeeper<span style="color:#bbb">
</span><span style="color:#bbb">      </span>securityContext:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>runAsUser:<span style="color:#bbb"> </span><span style="color:#666">1000</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>fsGroup:<span style="color:#bbb"> </span><span style="color:#666">1000</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>volumeClaimTemplates:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>name:<span style="color:#bbb"> </span>datadir<span style="color:#bbb">
</span><span style="color:#bbb">    </span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>accessModes:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">&#34;ReadWriteOnce&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span><span style="color:#bbb">      </span>resources:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>requests:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>storage:<span style="color:#bbb"> </span>10Gi<span style="color:#bbb">
</span></code></pre></div>  </td>
        </tr>
    </tbody>
</table>

<p>터미널을 열고
<a href="/docs/reference/generated/kubectl/kubectl-commands/#apply"><code>kubectl apply</code></a> 명령어로
메니페스트를 생성하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/zookeeper/zookeeper.yaml</code></pre></div>
<p>이는 <code>zk-hs</code> 헤드리스 서비스, <code>zk-cs</code> 서비스,
<code>zk-pdb</code> PodDisruptionBudget과 <code>zk</code> 스테이트풀셋을 생성한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">service/zk-hs created
service/zk-cs created
poddisruptionbudget.policy/zk-pdb created
statefulset.apps/zk created</code></pre></div>
<p><a href="/docs/reference/generated/kubectl/kubectl-commands/#get"><code>kubectl get</code></a>을 사용하여
스테이트풀셋 컨트롤러가 스테이트풀셋 파드를 생성하는지 확인한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p><code>zk-2</code> 파드가 Running and Ready 상태가 되면, <code>CTRL-C</code>를 눌러 kubectl을 종료하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>          0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         18s
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s</code></pre></div>
<p>스테이트풀셋 컨트롤러는 3개의 파드를 생성하고, 각 파드는
<a href="http://www-us.apache.org/dist/zookeeper/stable/" target="_blank">ZooKeeper</a> 서버를 포함한 컨테이너를 가진다.</p>

<h3 id="리더-선출-촉진">리더 선출 촉진</h3>

<p>익명 네트워크에서 리더 선출을 위한 종료 알고리즘이 없기에, Zab은 리더 선출을 위해 명시적인 멤버 구성을 해야 한다. 앙상블의 각 서버는 고유 식별자를 가져야 하고, 모든 서버는 식별자 전역 집합을 알아야 하며, 각 식별자는 네트워크 주소에 연관되어야 한다.</p>

<p><a href="/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a>를 이용하여 <code>zk</code> 스테이트풀셋의 파드의
호스트네임을 알아내자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl <span style="color:#a2f">exec</span> zk-<span style="color:#b8860b">$i</span> -- hostname; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p>스테이트풀셋 컨트롤러는 각 순번 인덱스에 기초하여 각 파드에 고유한 호스트네임을 부여한다. 각 호스트네임은 <code>&lt;스테이트풀셋 이름&gt;-&lt;순번 인덱스&gt;</code> 형식을 취한다. <code>zk</code> 스테이트풀셋의 <code>replicas</code> 필드는 <code>3</code>으로 설정되었기 때문에, 그 스테이트풀셋 컨트롤러는 3개 파드의 호스트네임을 <code>zk-0</code>, <code>zk-1</code>,
<code>zk-2</code>로 정한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-0
zk-1
zk-2</code></pre></div>
<p>ZooKeeper 앙상블에 서버들은 고유 식별자로서 자연수를 이용하고 서버 데이터 디렉터리에 <code>my</code> 라는 파일로 서버 식별자를 저장한다.</p>

<p>각 서버에서 다음 명령어를 이용하여 <code>myid</code> 파일의 내용을 확인하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;myid zk-</span><span style="color:#b8860b">$i</span><span style="color:#b44">&#34;</span>;kubectl <span style="color:#a2f">exec</span> zk-<span style="color:#b8860b">$i</span> -- cat /var/lib/zookeeper/data/myid; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p>식별자는 자연수이고, 순번 인덱스들도 음수가 아니므로, 순번에 1을 더하여 순번을 만들 수 있다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">myid zk-0
<span style="color:#666">1</span>
myid zk-1
<span style="color:#666">2</span>
myid zk-2
<span style="color:#666">3</span></code></pre></div>
<p><code>zk</code> 스테이트풀셋의 각 파드 Fully Qualified Domain Name (FQDN)을 얻기 위해 다음 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl <span style="color:#a2f">exec</span> zk-<span style="color:#b8860b">$i</span> -- hostname -f; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p><code>zk-hs</code> 서비스는 모든 파드를 위한 도메인인
<code>zk-hs.default.svc.cluster.local</code>을 만든다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-0.zk-hs.default.svc.cluster.local
zk-1.zk-hs.default.svc.cluster.local
zk-2.zk-hs.default.svc.cluster.local</code></pre></div>
<p><a href="/ko/docs/concepts/services-networking/dns-pod-service/">쿠버네티스 DNS</a>의 A 레코드는 FQDN을 파드의 IP 주소로 풀어낸다. 쿠버네티스가 파드를 리스케줄하면, 파드의 새 IP 주소로 A 레코드를 갱신하지만, A 레코드의 이름은 바뀌지 않는다.</p>

<p>ZooKeeper는 그것의 애플리케이션 환경설정을 <code>zoo.cfg</code> 파일에 저장한다. <code>kubectl exec</code>를 이용하여 <code>zk-0</code> 파드의 <code>zoo.cfg</code> 내용을 보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- cat /opt/zookeeper/conf/zoo.cfg</code></pre></div>
<p>아래 파일의  <code>server.1</code>, <code>server.2</code>, <code>server.3</code> 속성에서
<code>1</code>, <code>2</code>, <code>3</code>은 ZooKeeper 서버의 <code>myid</code> 파일에 구분자와
연관된다.
이들은 <code>zk</code> 스테이트풀셋의 파드의 FQDNS을 설정한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">clientPort</span><span style="color:#666">=</span><span style="color:#666">2181</span>
<span style="color:#b8860b">dataDir</span><span style="color:#666">=</span>/var/lib/zookeeper/data
<span style="color:#b8860b">dataLogDir</span><span style="color:#666">=</span>/var/lib/zookeeper/log
<span style="color:#b8860b">tickTime</span><span style="color:#666">=</span><span style="color:#666">2000</span>
<span style="color:#b8860b">initLimit</span><span style="color:#666">=</span><span style="color:#666">10</span>
<span style="color:#b8860b">syncLimit</span><span style="color:#666">=</span><span style="color:#666">2000</span>
<span style="color:#b8860b">maxClientCnxns</span><span style="color:#666">=</span><span style="color:#666">60</span>
<span style="color:#b8860b">minSessionTimeout</span><span style="color:#666">=</span> <span style="color:#666">4000</span>
<span style="color:#b8860b">maxSessionTimeout</span><span style="color:#666">=</span> <span style="color:#666">40000</span>
autopurge.snapRetainCount<span style="color:#666">=</span><span style="color:#666">3</span>
autopurge.purgeInterval<span style="color:#666">=</span><span style="color:#666">0</span>
server.1<span style="color:#666">=</span>zk-0.zk-hs.default.svc.cluster.local:2888:3888
server.2<span style="color:#666">=</span>zk-1.zk-hs.default.svc.cluster.local:2888:3888
server.3<span style="color:#666">=</span>zk-2.zk-hs.default.svc.cluster.local:2888:3888</code></pre></div>
<h3 id="합의-달성">합의 달성</h3>

<p>합의 프로토콜에서 각 참가자의 식별자는 유일해야 한다. Zab 프로토콜에서 동일한 고유 식별자를 요청하는 참가자는 없다. 이는 시스템 프로세스가 어떤 프로세스가 어떤 데이터를 커밋했는지 동의하게 하는데 필요하다. 2개 파드를 동일 순번으로 시작하였다면 두 대의 ZooKeeper 서버는 둘 다 스스로를 동일 서버로 식별한다.</p>

<p>합의 프로토콜에서 각 참여자의 식별자는 고유해야 한다. Zab 프로토콜에 두 참여자가 동일한 고유 식별자로 요청해서는 안된다. 이는 시스템 프로세스가 어떤 프로세스가 어떤 데이터를 커밋했는지 동의하도록 하기 위해 필수적이다. 동일 순번으로 두 개의 파드가 실행했다면 두 ZooKeeper 서버는 모두 동일한 서버로 식별된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>          0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         18s
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s</code></pre></div>
<p>각 파드의 A 레코드는 파드가 Ready 상태가 되면 입력된다. 따라서
ZooKeeper 서버의 FQDN은 단일 엔드포인트로 확인되고
해당 엔드포인트는 <code>myid</code> 파일에 구성된 식별자를 가진
고유한 ZooKeeper 서버가 된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-0.zk-hs.default.svc.cluster.local
zk-1.zk-hs.default.svc.cluster.local
zk-2.zk-hs.default.svc.cluster.local</code></pre></div>
<p>이것은 ZooKeeper의 <code>zoo.cfg</code> 파일에 <code>servers</code> 속성이 정확히 구성된 앙상블로 나타나는 것을 보증한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">server.1<span style="color:#666">=</span>zk-0.zk-hs.default.svc.cluster.local:2888:3888
server.2<span style="color:#666">=</span>zk-1.zk-hs.default.svc.cluster.local:2888:3888
server.3<span style="color:#666">=</span>zk-2.zk-hs.default.svc.cluster.local:2888:3888</code></pre></div>
<p>서버가 Zab 프로토콜로 값을 커밋 시도하면, 합의를 이루어 값을 커밋하거나(리더 선출에 성공했고 나머지 두 개 파드도 Running과 Ready 상태라면) 실패한다(조건 중 하나라도 충족하지 않으면). 다른 서버를 대신하여 쓰기를 승인하는 상태는 발생하지 않는다.</p>

<h3 id="앙상블-무결성-테스트">앙상블 무결성 테스트</h3>

<p>가장 기본적인 테스트는 한 ZooKeeper 서버에 데이터를 쓰고 다른 ZooKeeper 서버에서 데이터를 읽는 것이다.</p>

<p>아래 명령어는 앙상블 내에 <code>zk-0</code> 파드에서 <code>/hello</code> 경로로 <code>world</code>를 쓰는 스크립트인 <code>zkCli.sh</code>를 실행한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 zkCli.sh create /hello world

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
Created /hello</code></pre></div>
<p><code>zk-1</code> 파드에서 데이터를 읽기 위해 다음 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-1 zkCli.sh get /hello</code></pre></div>
<p><code>zk-0</code>에서 생성한 그 데이터는 앙상블 내에 모든 서버에서
사용할 수 있다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WATCHER::

WatchedEvent state:SyncConnected type:None path:null
world
<span style="color:#b8860b">cZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">ctime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">mZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">mtime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">pZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">cversion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">dataVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">aclVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">ephemeralOwner</span> <span style="color:#666">=</span> 0x0
<span style="color:#b8860b">dataLength</span> <span style="color:#666">=</span> <span style="color:#666">5</span>
<span style="color:#b8860b">numChildren</span> <span style="color:#666">=</span> <span style="color:#666">0</span></code></pre></div>
<h3 id="내구성있는-저장소-제공">내구성있는 저장소 제공</h3>

<p><a href="#zookeeper-basics">ZooKeeper 기본</a> 섹션에서 언급했듯이
ZooKeeper는 모든 항목을 내구성있는 WAL에 커밋하고 메모리 상태의 스냅샷을 저장 미디에에 주기적으로 저장한다.
내구성을 제공하기 위해 WAL을 이용하는 것은
복제된 상태 머신을 이루는 합의 프로토콜에서
이용하는 일반적인 기법이다.</p>

<p><a href="/docs/reference/generated/kubectl/kubectl-commands/#delete"><code>kubectl delete</code></a> 명령을 이용하여
<code>zk</code> 스테이트풀셋을 삭제하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl delete statefulset zk
statefulset.apps <span style="color:#b44">&#34;zk&#34;</span> deleted</code></pre></div>
<p>스테이트풀셋의 파드가 종료되는 것을 지켜보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p><code>zk-0</code>이 완전히 종료되면 <code>CTRL-C</code>를 이용해 kubectl을 종료하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-2      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         11m
zk-1      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-2      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-2      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-2      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         11m
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         11m
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         11m</code></pre></div>
<p><code>zookeeper.yaml</code> 메니페스트를 다시 적용한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/zookeeper/zookeeper.yaml</code></pre></div>
<p><code>zk</code> 스테이트풀셋 오브젝트를 생성하지만, 매니페스트에 다른 API 오브젝트는 이미 존재하므로 수정되지 않는다.</p>

<p>스테이트풀셋 컨트롤러가 스테트풀셋의 파드를 재생성하는 것을 확인한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p><code>zk-2</code> 파드가 Running과 Ready가 되면 <code>CTRL-C</code>를 이용하여 kubectl을 종료한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>          0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         18s
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s</code></pre></div>
<p>아래 명령어로 <a href="#앙상블-무결성-테스트">무결성 테스트</a>에서 입력한 값을
<code>zk-2</code> 파드에서 얻어온다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-2 zkCli.sh get /hello</code></pre></div>
<p><code>zk</code> 스테이트풀셋의 모든 파드를 종료하고 재생성했음에도, 앙상블은 여전히 원래 값을 돌려준다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WATCHER::

WatchedEvent state:SyncConnected type:None path:null
world
<span style="color:#b8860b">cZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">ctime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">mZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">mtime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">pZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">cversion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">dataVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">aclVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">ephemeralOwner</span> <span style="color:#666">=</span> 0x0
<span style="color:#b8860b">dataLength</span> <span style="color:#666">=</span> <span style="color:#666">5</span>
<span style="color:#b8860b">numChildren</span> <span style="color:#666">=</span> <span style="color:#666">0</span></code></pre></div>
<p><code>zk</code> 스테이트풀셋의 <code>spec</code>에 <code>volumeClaimTemplates</code> 필드는 각 파드에 프로비전될 퍼시스턴트볼륨을 지정한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">volumeClaimTemplates:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>name:<span style="color:#bbb"> </span>datadir<span style="color:#bbb">
</span><span style="color:#bbb">      </span>annotations:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>volume.alpha.kubernetes.io/storage-class:<span style="color:#bbb"> </span>anything<span style="color:#bbb">
</span><span style="color:#bbb">    </span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>accessModes:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">&#34;ReadWriteOnce&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span><span style="color:#bbb">      </span>resources:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>requests:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>storage:<span style="color:#bbb"> </span>20Gi</code></pre></div>
<p><code>스테이트풀셋</code> 컨트롤러는 <code>스테이트풀셋</code>의 각 파드에 대한
<code>퍼시스턴트볼륨클레임</code>을 생성한다.</p>

<p>다음 명령어를 이용하여 <code>스테이트풀셋</code>의 <code>퍼시스턴트볼륨클레임</code>을 살펴보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pvc -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p><code>스테이트풀셋</code>의 파드를 재생성할 때에 파드의 퍼시스턴트볼륨도 다시 마운트한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME           STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
datadir-zk-0   Bound     pvc-bed742cd-bcb1-11e6-994f-42010a800002   20Gi       RWO           1h
datadir-zk-1   Bound     pvc-bedd27d2-bcb1-11e6-994f-42010a800002   20Gi       RWO           1h
datadir-zk-2   Bound     pvc-bee0817e-bcb1-11e6-994f-42010a800002   20Gi       RWO           1h</code></pre></div>
<p><code>스테이트풀셋</code>의 컨테이너 <code>template</code>의 <code>volumeMounts</code> 부분이 ZooKeeper 서버의 데이터 디렉터리에 퍼시스턴트볼륨 마운트하는 내용이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">volumeMounts:
        - name: datadir
          mountPath: /var/lib/zookeeper</code></pre></div>
<p><code>zk</code> 스테이트풀셋이 (재)스케줄링될 때 항상 동일한 <code>퍼시스턴트볼륨</code>을
ZooKeeper의 서버 디렉터리에 마운트한다.
파드를 재스케쥴할 때에도 ZooKeeper의 WAL을 통해 이뤄진 모든 쓰기와
모든 그 스냅샷도 내구성을 유지한다.</p>

<h2 id="일관된-구성-보장하기">일관된 구성 보장하기</h2>

<p><a href="#리더-선출-촉진">리더 선출 촉진</a>과
<a href="#합의-달성">합의 달성</a> 섹션에서 알렸듯이,
ZooKeeper 앙상블에 서버는 리더 선출과 쿼럼을 구성하기 위한 일관된 설정이 필요하다.
또한 Zab 프로토콜의 일관된 설정도
네트워크에 걸쳐 올바르게 동작하기 위해서
필요하다. 이 예시에서는 메니페스트에 구성을 직접 포함시켜서 일관된 구성을
달성한다.</p>

<p><code>zk</code> 스테이트풀셋을 살펴보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get sts zk -o yaml
…
command:
      - sh
      - -c
      - <span style="color:#b44">&#34;start-zookeeper \
</span><span style="color:#b44">        --servers=3 \
</span><span style="color:#b44">        --data_dir=/var/lib/zookeeper/data \
</span><span style="color:#b44">        --data_log_dir=/var/lib/zookeeper/data/log \
</span><span style="color:#b44">        --conf_dir=/opt/zookeeper/conf \
</span><span style="color:#b44">        --client_port=2181 \
</span><span style="color:#b44">        --election_port=3888 \
</span><span style="color:#b44">        --server_port=2888 \
</span><span style="color:#b44">        --tick_time=2000 \
</span><span style="color:#b44">        --init_limit=10 \
</span><span style="color:#b44">        --sync_limit=5 \
</span><span style="color:#b44">        --heap=512M \
</span><span style="color:#b44">        --max_client_cnxns=60 \
</span><span style="color:#b44">        --snap_retain_count=3 \
</span><span style="color:#b44">        --purge_interval=12 \
</span><span style="color:#b44">        --max_session_timeout=40000 \
</span><span style="color:#b44">        --min_session_timeout=4000 \
</span><span style="color:#b44">        --log_level=INFO&#34;</span>
…</code></pre></div>
<p>ZooKeeper 서버를 시작하는데 사용한 명령어는 커맨드라인 파라미터로 환경 구성을 전달했다. 환경 변수를 이용하여서도 앙상블에 환경 구성을 전달할 수 있다.</p>

<h3 id="로깅-설정하기">로깅 설정하기</h3>

<p><code>zkGenConfig.sh</code> 스크립트로 생성된 파일 중 하나는 ZooKeeper의 로깅을 제어한다.
ZooKeeper는 <a href="http://logging.apache.org/log4j/2.x/" target="_blank">Log4j</a>를 이용하며
기본 로깅 구성으로는 시간과 파일 크기 기준의 롤링 파일 어펜더를 사용한다.</p>

<p><code>zk</code> <code>스테이트풀셋</code>의 한 파드에서 로깅 설정을 살펴보는 아래 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 cat /usr/etc/zookeeper/log4j.properties</code></pre></div>
<p>아래 로깅 구성은 ZooKeeper가 모든 로그를
표준 출력 스트림으로 처리하게 한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zookeeper.root.logger<span style="color:#666">=</span>CONSOLE
zookeeper.console.threshold<span style="color:#666">=</span>INFO
log4j.rootLogger<span style="color:#666">=</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#b8860b">zookeeper</span>.root.logger<span style="color:#b68;font-weight:bold">}</span>
log4j.appender.CONSOLE<span style="color:#666">=</span>org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.Threshold<span style="color:#666">=</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#b8860b">zookeeper</span>.console.threshold<span style="color:#b68;font-weight:bold">}</span>
log4j.appender.CONSOLE.layout<span style="color:#666">=</span>org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern<span style="color:#666">=</span>%d<span style="color:#666">{</span>ISO8601<span style="color:#666">}</span> <span style="color:#666">[</span>myid:%X<span style="color:#666">{</span>myid<span style="color:#666">}]</span> - %-5p <span style="color:#666">[</span>%t:%C<span style="color:#666">{</span><span style="color:#666">1</span><span style="color:#666">}</span>@%L<span style="color:#666">]</span> - %m%n</code></pre></div>
<p>이는 컨테이너 내에서 안전하게 로깅하는 가장 단순한 방법이다. 표준 출력으로 애플리케이션 로그를 작성하면, 쿠버네티스는 로그 로테이션을 처리한다. 또한 쿠버네티스는 애플리케이션이 표준 출력과 표준 오류에 쓰인 로그로 인하여 로컬 저장 미디어가 고갈되지 않도록 보장하는 정상적인 보존 정책을 구현한다.</p>

<p>파드의 마지막 20줄의 로그를 가져오는 <a href="/docs/reference/generated/kubectl/kubectl-commands/#logs"><code>kubectl logs</code></a> 명령을 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl logs zk-0 --tail <span style="color:#666">20</span></code></pre></div>
<p><code>kubectl logs</code>를 이용하거나 쿠버네티스 대시보드에서 표준 출력과 표준 오류로 쓰인 애플리케이션 로그를 볼 수 있다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:16,236 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52740
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:16,237 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1136:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52740 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,155 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52749
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,155 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52749
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,156 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1137:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52749 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,222 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52750
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,222 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52750
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,226 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1138:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52750 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,151 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52760
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,152 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52760
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,152 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1139:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52760 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52761
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,231 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52761
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,231 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1140:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52761 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,149 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52767
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,149 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52767
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,149 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1141:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52767 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52768
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52768
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1142:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52768 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span></code></pre></div>
<p>쿠버네티스는 더 강력하지만 조금 복잡한 로그 통합을
<a href="/docs/tasks/debug-application-cluster/logging-stackdriver/">스택드라이버</a>와
<a href="/docs/tasks/debug-application-cluster/logging-elasticsearch-kibana/">Elasticsearch와 Kibana</a>를 지원한다.
클러스터 수준의 로그 적재(ship)와 통합을 위해서는 로그 순환과 적재를 위해
<a href="https://kubernetes.io/blog/2015/06/the-distributed-system-toolkit-patterns" target="_blank">사이드카</a> 컨테이너를 배포하는 것을 고려한다.</p>

<h3 id="권한-없는-사용자를-위해-구성하기">권한 없는 사용자를 위해 구성하기</h3>

<p>컨테이너 내부의 권한있는 유저로 애플리케이션을 실행할 수 있도록 하는
최상의 방법은 논쟁거리이다.
조직에서 애플리케이션을 권한 없는 사용자가 실행한다면,
진입점을 실행할 사용자를 제어하기 위해
<a href="/docs/tasks/configure-pod-container/security-context/">시큐리티컨텍스트</a>를 이용할 수 있다.</p>

<p><code>zk</code> <code>스테이트풀셋</code>의 파드 <code>template</code>은 <code>SecurityContext</code>를 포함한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">securityContext:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>runAsUser:<span style="color:#bbb"> </span><span style="color:#666">1000</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>fsGroup:<span style="color:#bbb"> </span><span style="color:#666">1000</span></code></pre></div>
<p>파드 컨테이너에서 UID 1000은 ZooKeeper 사용자이며, GID 1000은
ZooKeeper의 그룹에 해당한다.</p>

<p><code>zk-0</code> 파드에서 프로세스 정보를 얻어오자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- ps -elf</code></pre></div>
<p><code>securityContext</code> 오브젝트의 <code>runAsUser</code> 필드 값이 1000 이므로
루트 사용자로 실행하는 대신 ZooKeeper 프로세스는 ZooKeeper 사용자로 실행된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD
<span style="color:#666">4</span> S zookeep+     <span style="color:#666">1</span>     <span style="color:#666">0</span>  <span style="color:#666">0</span>  <span style="color:#666">80</span>   <span style="color:#666">0</span> -  <span style="color:#666">1127</span> -      <span style="color:#666">20</span>:46 ?        <span style="color:#666">00</span>:00:00 sh -c zkGenConfig.sh <span style="color:#666">&amp;&amp;</span> zkServer.sh start-foreground
<span style="color:#666">0</span> S zookeep+    <span style="color:#666">27</span>     <span style="color:#666">1</span>  <span style="color:#666">0</span>  <span style="color:#666">80</span>   <span style="color:#666">0</span> - <span style="color:#666">1155556</span> -    <span style="color:#666">20</span>:46 ?        <span style="color:#666">00</span>:00:19 /usr/lib/jvm/java-8-openjdk-amd64/bin/java -Dzookeeper.log.dir<span style="color:#666">=</span>/var/log/zookeeper -Dzookeeper.root.logger<span style="color:#666">=</span>INFO,CONSOLE -cp /usr/bin/../build/classes:/usr/bin/../build/lib/*.jar:/usr/bin/../share/zookeeper/zookeeper-3.4.9.jar:/usr/bin/../share/zookeeper/slf4j-log4j12-1.6.1.jar:/usr/bin/../share/zookeeper/slf4j-api-1.6.1.jar:/usr/bin/../share/zookeeper/netty-3.10.5.Final.jar:/usr/bin/../share/zookeeper/log4j-1.2.16.jar:/usr/bin/../share/zookeeper/jline-0.9.94.jar:/usr/bin/../src/java/lib/*.jar:/usr/bin/../etc/zookeeper: -Xmx2G -Xms2G -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only<span style="color:#666">=</span><span style="color:#a2f">false</span> org.apache.zookeeper.server.quorum.QuorumPeerMain /usr/bin/../etc/zookeeper/zoo.cfg</code></pre></div>
<p>기본적으로 파드의 퍼시스턴트볼륨은 ZooKeeper 서버의 데이터 디렉터리에 마운트되고, 루트 사용자만이 접근 가능하다. 이 구성은 ZooKeeper 프로세스가 WAL에 기록하고 스냅샷을 저장하는 것을 방지한다.</p>

<p><code>zk-0</code> 파드의 ZooKeeper 데이터 디렉터리의 권한을 얻어오는 아래 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> -ti zk-0 -- ls -ld /var/lib/zookeeper/data</code></pre></div>
<p><code>securityContext</code> 오브젝트의 <code>fsGroup</code> 필드 값이 1000 이므로, 파드의 퍼시스턴트 볼륨의 소유권은 ZooKeeper 그룹으로 지정되어 ZooKeeper 프로세스에서 읽고 쓸 수 있다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">drwxr-sr-x <span style="color:#666">3</span> zookeeper zookeeper <span style="color:#666">4096</span> Dec  <span style="color:#666">5</span> <span style="color:#666">20</span>:45 /var/lib/zookeeper/data</code></pre></div>
<h2 id="zookeeper-프로세스-관리하기">ZooKeeper 프로세스 관리하기</h2>

<p><a href="https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_supervision" target="_blank">ZooKeeper 문서</a>에서는
&ldquo;ZooKeeper의 서버 프로세스(JVM)을 관리할
감독 프로세스를 필요할 것이다.&ldquo;라고 말한다.
와치독(감독 프로세스)를 활용하여 실패한 프로세스를 재시작하는 것은 분산시스템에서
일반적인 방식이다. 쿠버네티스에서 애플리케이션을 배포할 때에는
감독 프로세스로 외부 유틸리티를 사용하기보다 쿠버네티스를 애플리케이션의
와치독으로서 사용해야 한다.</p>

<h3 id="앙상블-관리하기">앙상블 관리하기</h3>

<p><code>zk</code> <code>스테이트풀셋</code>은 <code>RollingUpdate</code> 업데이트 전략을 이용하도록 구성되었다.</p>

<p><code>kubectl patch</code>로 서버에 할당된 <code>cpu</code> 수를 갱신할 수 있다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl patch sts zk --type<span style="color:#666">=</span><span style="color:#b44">&#39;json&#39;</span> -p<span style="color:#666">=</span><span style="color:#b44">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/resources/requests/cpu&#34;, &#34;value&#34;:&#34;0.3&#34;}]&#39;</span>

statefulset.apps/zk patched</code></pre></div>
<p>업데이트 상황을 지켜보기 위해 <code>kubectl rollout status</code> 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl rollout status sts/zk

waiting <span style="color:#a2f;font-weight:bold">for</span> statefulset rolling update to <span style="color:#a2f">complete</span> <span style="color:#666">0</span> pods at revision zk-5db4499664...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
waiting <span style="color:#a2f;font-weight:bold">for</span> statefulset rolling update to <span style="color:#a2f">complete</span> <span style="color:#666">1</span> pods at revision zk-5db4499664...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
waiting <span style="color:#a2f;font-weight:bold">for</span> statefulset rolling update to <span style="color:#a2f">complete</span> <span style="color:#666">2</span> pods at revision zk-5db4499664...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
statefulset rolling update <span style="color:#a2f">complete</span> <span style="color:#666">3</span> pods at revision zk-5db4499664...</code></pre></div>
<p>이것은 파드를 역순으로 한 번에 하나씩 종료하고, 새로운 구성으로 재생성한다. 이는 롤링업데이트 동안에 쿼럼을 유지하도록 보장한다.</p>

<p>이력과 이전 구성을 보기 위해 <code>kubectl rollout history</code> 명령을 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl rollout <span style="color:#a2f">history</span> sts/zk

statefulsets <span style="color:#b44">&#34;zk&#34;</span>
REVISION
<span style="color:#666">1</span>
<span style="color:#666">2</span></code></pre></div>
<p>수정사항을 롤백하기 위해 <code>kubectl rollout undo</code> 명령을 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl rollout undo sts/zk

statefulset.apps/zk rolled back</code></pre></div>
<h3 id="프로세스-장애-관리하기">프로세스 장애 관리하기</h3>

<p><a href="/ko/docs/concepts/workloads/pods/pod-lifecycle/#재시작-정책">재시작 정책</a>은
쿠버네티스가 파드 내에 컨테이너의 진입점에서 프로세스 실패를 어떻게 다루는지 제어한다.
<code>스테이트풀셋</code>의 파드에서 오직 적절한 <code>재시작 정책</code>는 Always이며
이것이 기본 값이다. 상태가 유지되는 애플리케이션을 위해
기본 정책을 <strong>절대로</strong> 변경하지 말자.</p>

<p><code>zk-0</code> 파드에서 실행 중인 ZooKeeper 서버에서 프로세스 트리를 살펴보기 위해 다음 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- ps -ef</code></pre></div>
<p>컨테이너의 엔트리 포인트로 PID 1 인 명령이 사용되었으며
ZooKeeper 프로세스는 엔트리 포인트의 자식 프로세스로 PID 27 이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">UID        PID  PPID  C STIME TTY          TIME CMD
zookeep+     <span style="color:#666">1</span>     <span style="color:#666">0</span>  <span style="color:#666">0</span> <span style="color:#666">15</span>:03 ?        <span style="color:#666">00</span>:00:00 sh -c zkGenConfig.sh <span style="color:#666">&amp;&amp;</span> zkServer.sh start-foreground
zookeep+    <span style="color:#666">27</span>     <span style="color:#666">1</span>  <span style="color:#666">0</span> <span style="color:#666">15</span>:03 ?        <span style="color:#666">00</span>:00:03 /usr/lib/jvm/java-8-openjdk-amd64/bin/java -Dzookeeper.log.dir<span style="color:#666">=</span>/var/log/zookeeper -Dzookeeper.root.logger<span style="color:#666">=</span>INFO,CONSOLE -cp /usr/bin/../build/classes:/usr/bin/../build/lib/*.jar:/usr/bin/../share/zookeeper/zookeeper-3.4.9.jar:/usr/bin/../share/zookeeper/slf4j-log4j12-1.6.1.jar:/usr/bin/../share/zookeeper/slf4j-api-1.6.1.jar:/usr/bin/../share/zookeeper/netty-3.10.5.Final.jar:/usr/bin/../share/zookeeper/log4j-1.2.16.jar:/usr/bin/../share/zookeeper/jline-0.9.94.jar:/usr/bin/../src/java/lib/*.jar:/usr/bin/../etc/zookeeper: -Xmx2G -Xms2G -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only<span style="color:#666">=</span><span style="color:#a2f">false</span> org.apache.zookeeper.server.quorum.QuorumPeerMain /usr/bin/../etc/zookeeper/zoo.cfg</code></pre></div>
<p>다른 터미널에서 다음 명령어로 <code>zk</code> <code>스테이트풀셋</code>의 파드를 확인한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>또 다른 터미널에서 다음 명령어로 <code>zk-0</code> 파드의 ZooKeeper 프로세스를 종료시킨다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- pkill java</code></pre></div>
<p>ZooKeeper 프로세스의 종료는 부모 프로세스의 종료를 일으킨다. 컨테이너 <code>재시작정책</code>이 Always이기 때문에 부모 프로세스를 재시작했다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          21m
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          20m
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          19m
NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Error     <span style="color:#666">0</span>          29m
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">1</span>         29m
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">1</span>         29m</code></pre></div>
<p>애플리케이션이 스크립트(<code>zkServer.sh</code> 같은)를 애플리케이션의 비지니스 로직을 구현한 프로세스를 시작하기 위해 이용한다면,
그 스크립트는 자식 프로세스와 함께 반드시 종료되어야 한다.
이는 쿠버네티스가 애플리케이션의 비지니스 로직을 구현한 프로세스가 실패할 때에
애플리케이션 컨테이너를 재시작하는 것을 보증한다.</p>

<h3 id="활성도-liveness-테스트하기">활성도(Liveness) 테스트하기</h3>

<p>실패한 애플리케이션을 재시작하도록 구성하는 것은 분산 시스템을
건강하게 유지하는데 충분하지 않다. 시스템의 프로세스는 살아있지만
응답이 없을 수 있고, 혹은 다른 건강하지 않은 경우의 시나리오가 있다.
애플리케이션 프로세스가 건강하지 않고 재시작해야만 한다는 것을
쿠버네티스에게 알리도록 활성도 검사를 이용해야 한다.</p>

<p><code>zk</code> <code>스테이트풀셋</code>에 파드 <code>template</code>에 활성도 검사를 명시한다.
``</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb"> </span>livenessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span></code></pre></div>
<p>검사는 ZooKeeper의 <code>ruok</code> 4 글자 단어를 이용해서 서버의 건강을 테스트하는
배쉬 스크립트를 호출한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b8860b">OK</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span><span style="color:#a2f">echo</span> ruok | nc <span style="color:#666">127</span>.0.0.1 <span style="color:#b8860b">$1</span><span style="color:#a2f;font-weight:bold">)</span>
<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">[</span> <span style="color:#b44">&#34;</span><span style="color:#b8860b">$OK</span><span style="color:#b44">&#34;</span> <span style="color:#666">==</span> <span style="color:#b44">&#34;imok&#34;</span> <span style="color:#666">]</span>; <span style="color:#a2f;font-weight:bold">then</span>
    <span style="color:#a2f">exit</span> <span style="color:#666">0</span>
<span style="color:#a2f;font-weight:bold">else</span>
    <span style="color:#a2f">exit</span> <span style="color:#666">1</span>
<span style="color:#a2f;font-weight:bold">fi</span></code></pre></div>
<p>한 터미널에서 <code>zk</code> 스테이트풀셋의 파드를 지켜보기 위해 다음 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>다른 창에서 <code>zk-0</code> 파드의 파일시스템에서 <code>zkOk.sh</code> 스크립트를 삭제하기 위해 다음 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- rm /usr/bin/zookeeper-ready</code></pre></div>
<p>ZooKeeper의 활성도 검사에 실패하면,
쿠버네티스는 자동으로 프로세스를 재시작하여 앙상블에 건강하지 않은 프로세스를
재시작하는 것을 보증한다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>          1h
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">1</span>         1h
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">1</span>         1h</code></pre></div>
<h3 id="준비도-테스트">준비도 테스트</h3>

<p>준비도는 활성도와 동일하지 않다. 프로세스가 살아 있다면, 스케쥴링되고 건강하다.
프로세스가 준비되면 입력을 처리할 수 있다. 활성도는 필수적이나 준비도의 조건으로는
충분하지 않다. 몇몇 경우
특별히 초기화와 종료 시에 프로세스는 살아있지만
준비되지 않을 수 있다.</p>

<p>준비도 검사를 지정하면, 쿠버네티스는 준비도가 통과할 때까지
애플리케이션 프로세스가 네트워크 트래픽을 수신하지 않게 한다.</p>

<p>ZooKeeper 서버에서는 준비도가 활성도를 내포한다. 그러므로 <code>zookeeper.yaml</code> 메니페스트에서
준비도 검사는 활성도 검사와 동일하다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span>readinessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span></code></pre></div>
<p>활성도와 준비도 검사가 동일함에도 둘 다 지정하는 것은 중요하다.
이는 ZooKeeper 앙상블에 건강한 서버만 아니라
네트워크 트래픽을 수신하는 것을 보장한다.</p>

<h2 id="노드-실패-방지">노드 실패 방지</h2>

<p>ZooKeeper는 변조된 데이터를 성공적으로 커밋하기 위한 서버의 쿼럼이 필요하다.
3개의 서버 앙상블에서 성공적으로 저장하려면 2개 서버는 반드시 건강해야 한다.
쿼럼 기반 시스템에서, 멤버는 가용성을 보장하는
실패 영역에 걸쳐 배포된다.
중단을 방지하기 위해 개별 시스템의 손실로 인해 모범 사례에서는 동일한 시스템에
여러 인스턴스의 응용 프로그램을 함께 배치하는 것을 배제한다.</p>

<p>기본적으로 쿠버네티스는 동일 노드상에 <code>스테이트풀셋</code>의 파드를 위치시킬 수 있다. 생성한 3개의 서버 앙상블에서 2개의 서버가 같은 노드에 있다면, 그 노드는 실패하고 ZooKeeper 서비스 클라이언트는 그 파드들의 최소 하나가 재스케쥴링될 때까지 작동 중단을 경험할 것이다.</p>

<p>노드 실패하는 사건 중에도 중요 시스템의 프로세스가 재스케줄될 수 있게
항상 추가적인 용량을 프로비전해야 한다. 그렇게 하면 쿠버네티스 스케줄러가
ZooKeeper 서버 하나를 다시 스케줄하는 동안까지만 작동 중단될 것이다.
그러나 서비스에서 노드 실패로 인한 다운타임을 방지하려 한다면,
<code>파드안티어피니티</code>를 설정해야 한다.</p>

<p><code>zk</code> <code>스테이트풀셋</code>의 파드의 노드를 알아보기 위해 다음 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl get pod zk-<span style="color:#b8860b">$i</span> --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span>; <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;&#34;</span>; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p><code>zk</code> <code>스테이트풀셋</code>에 모든 파드는 다른 노드에 배포된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubernetes-node-cxpk
kubernetes-node-a5aq
kubernetes-node-2g2d</code></pre></div>
<p>이는 <code>zk</code> <code>스테이트풀셋</code>의 파드에 <code>파드안티어피니티(PodAntiAffinity)</code>를 지정했기 때문이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">      </span>affinity:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>podAntiAffinity:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>requiredDuringSchedulingIgnoredDuringExecution:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>labelSelector:<span style="color:#bbb">
</span><span style="color:#bbb">                </span>matchExpressions:<span style="color:#bbb">
</span><span style="color:#bbb">                  </span>-<span style="color:#bbb"> </span>key:<span style="color:#bbb"> </span><span style="color:#b44">&#34;app&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">                    </span>operator:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>values:<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>-<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">              </span>topologyKey:<span style="color:#bbb"> </span><span style="color:#b44">&#34;kubernetes.io/hostname&#34;</span></code></pre></div>
<p><code>requiredDuringSchedulingIgnoredDuringExecution</code> 필드는
쿠버네티스 스케줄러에 <code>topologyKey</code>로 정의된 도메인에서 <code>app</code>이 <code>zk</code>라고 레이블링된
두 개 파드가 위치하지 않도록 한다.
<code>topologyKey</code> <code>kubernetes.io/hostname</code>은 도메인이 개별 노드임을 나타낸다.
다른 규칙과 레이블, 셀렉터를 사용하여
앙상블을 물리적인, 네트워크, 전원 장애 분야에 걸쳐 확산하도록 이 기법을 확장할 수 있다.</p>

<h2 id="생존-유지">생존 유지</h2>

<p><strong>이 섹션에서는 노드를 통제(cordon)하고 비운다(drain). 공유된 클러스터에서 이 튜토리얼을 진행한다면,
다른 테넌트에 부정적인 영향을 비치지 않음을 보증해야 한다.</strong></p>

<p>이전 섹션은 계획되지 않은 노드 실패에서 살아남도록
어떻게 파드를 확산할 것인가에 대해 알아보았다.
그러나 계획된 점검으로 인해 발생하는 일시적인 노드 실패에 대한 계획도 필요하다.</p>

<p>클러스터에서 다음 명령으로 노드를 살펴보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes</code></pre></div>
<p><a href="/docs/reference/generated/kubectl/kubectl-commands/#cordon"><code>kubectl cordon</code></a>을 이용하여
클러스터 내에 4개 노드를 제외하고 다른 모든 노드를 통제해보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl cordon &lt;노드-이름&gt;</code></pre></div>
<p><code>zk-pdb</code> <code>PodDisruptionBudget</code>을 살펴보고자 이 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pdb zk-pdb</code></pre></div>
<p><code>max-unavailable</code> 필드는 쿠버네티스가 <code>zk</code> <code>스테이트풀셋</code>에서 최대 1개의 파드는
언제든지 가용하지 않을 수 있음을 나타낸다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      MIN-AVAILABLE   MAX-UNAVAILABLE   ALLOWED-DISRUPTIONS   AGE
zk-pdb    N/A             <span style="color:#666">1</span>                 <span style="color:#666">1</span></code></pre></div>
<p>한 터미널에서 <code>zk</code> <code>스테이트풀셋</code>의 파드를 지켜보는 이 명령어를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>다른 터미널에서 현재 스케쥴되는 파드의 노드를 살펴보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl get pod zk-<span style="color:#b8860b">$i</span> --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span>; <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;&#34;</span>; <span style="color:#a2f;font-weight:bold">done</span>

kubernetes-node-pb41
kubernetes-node-ixsl
kubernetes-node-i4c4</code></pre></div>
<p><code>zk-0</code>파드가 스케쥴되는 노드를 통제하기 위해
<a href="/docs/reference/generated/kubectl/kubectl-commands/#drain"><code>kubectl drain</code></a>를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-0 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data
node <span style="color:#b44">&#34;kubernetes-node-group-pb41&#34;</span> cordoned

WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-group-pb41, kube-proxy-kubernetes-node-group-pb41; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-o5elz
pod <span style="color:#b44">&#34;zk-0&#34;</span> deleted
node <span style="color:#b44">&#34;kubernetes-node-group-pb41&#34;</span> drained</code></pre></div>
<p>클러스터에 4개 노드가 있기 때문에 <code>kubectl drain</code>이 성공하여
<code>zk-0</code>을 다른 노드로 재스케쥴링 된다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">2</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS        RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">2</span>          2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         51s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         1m</code></pre></div>
<p>계속해서 <code>스테이트풀셋</code>의 파드를 첫 터미널에서 지켜보고
<code>zk-1</code> 이 스케쥴된 노드를 비워보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-1 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data <span style="color:#b44">&#34;kubernetes-node-ixsl&#34;</span> cordoned

WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-ixsl, kube-proxy-kubernetes-node-ixsl; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-voc74
pod <span style="color:#b44">&#34;zk-1&#34;</span> deleted
node <span style="color:#b44">&#34;kubernetes-node-ixsl&#34;</span> drained</code></pre></div>
<p><code>zk-1</code> 파드는 스케쥴되지 않는데 이는 <code>zk</code> <code>스테이트풀셋</code>이 오직 2개 노드가 스케쥴되도록 파드를 위치시키는 것을 금하는 <code>파드안티어피니티</code> 규칙을 포함하였기 때문이고 그 파드는 Pending 상태로 남을 것이다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">2</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS        RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">2</span>          2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         51s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         1m
zk-1      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s</code></pre></div>
<p>계속해서 스테이트풀셋의 파드를 지켜보고
<code>zk-2</code>가 스케줄된 노드를 비워보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-2 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data
node <span style="color:#b44">&#34;kubernetes-node-i4c4&#34;</span> cordoned

WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-i4c4, kube-proxy-kubernetes-node-i4c4; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-dyrog
WARNING: Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-dyrog; Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-i4c4, kube-proxy-kubernetes-node-i4c4
There are pending pods when an error occurred: Cannot evict pod as it would violate the pod<span style="">&#39;</span>s disruption budget.
pod/zk-2</code></pre></div>
<p>kubectl 을 종료하기 위해 <code>CTRL-C</code>를 이용하자.</p>

<p><code>zk-2</code>를 추출하는 것은 <code>zk-budget</code>을 위반하기 때문에 셋째 노드를 비울 수 없다. 그러나 그 노드는 통제 상태로 남는다.</p>

<p><code>zk-0</code>에서 온전성 테스트 때에 입력한 값을 가져오는 <code>zkCli.sh</code>를 이용하자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 zkCli.sh get /hello</code></pre></div>
<p><code>PodDisruptionBudget</code>이 존중되기 때문에 서비스는 여전히 가용하다.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WatchedEvent state:SyncConnected type:None path:null
world
<span style="color:#b8860b">cZxid</span> <span style="color:#666">=</span> 0x200000002
<span style="color:#b8860b">ctime</span> <span style="color:#666">=</span> Wed Dec <span style="color:#666">07</span> <span style="color:#666">00</span>:08:59 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">mZxid</span> <span style="color:#666">=</span> 0x200000002
<span style="color:#b8860b">mtime</span> <span style="color:#666">=</span> Wed Dec <span style="color:#666">07</span> <span style="color:#666">00</span>:08:59 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">pZxid</span> <span style="color:#666">=</span> 0x200000002
<span style="color:#b8860b">cversion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">dataVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">aclVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">ephemeralOwner</span> <span style="color:#666">=</span> 0x0
<span style="color:#b8860b">dataLength</span> <span style="color:#666">=</span> <span style="color:#666">5</span>
<span style="color:#b8860b">numChildren</span> <span style="color:#666">=</span> <span style="color:#666">0</span></code></pre></div>
<p><a href="/docs/reference/generated/kubectl/kubectl-commands/#uncordon"><code>kubectl uncordon</code></a> 이용하여 첫 노드의 통제를 풀자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl uncordon kubernetes-node-pb41

node <span style="color:#b44">&#34;kubernetes-node-pb41&#34;</span> uncordoned</code></pre></div>
<p><code>zk-1</code>은 이 노드에서 재스케쥴된다. <code>zk-1</code>이 Running과 Ready가 될 때까지 기다리자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">2</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS        RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">2</span>          2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         51s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         1m
zk-1      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         12m
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         12m
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         13m
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         13m</code></pre></div>
<p><code>zk-2</code>가 스케쥴된 노드를 비워보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-2 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data</code></pre></div>
<p>출력은</p>

<pre><code>node &quot;kubernetes-node-i4c4&quot; already cordoned
WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-i4c4, kube-proxy-kubernetes-node-i4c4; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-dyrog
pod &quot;heapster-v1.2.0-2604621511-wht1r&quot; deleted
pod &quot;zk-2&quot; deleted
node &quot;kubernetes-node-i4c4&quot; drained
</code></pre>

<p>이번엔 <code>kubectl drain</code> 이 성공한다.</p>

<p><code>zk-2</code>가 재스케줄되도록 두 번째 노드의 통제를 풀어보자.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl uncordon kubernetes-node-ixsl</code></pre></div>
<pre><code>node &quot;kubernetes-node-ixsl&quot; uncordoned
</code></pre>

<p><code>kubectl drain</code>을 <code>PodDisruptionBudget</code>과 결합하면 유지보수 중에도 서비스를 가용하게 할 수 있다. drain으로 노드를 통제하고 유지보수를 위해 노드를 오프라인하기 전에 파드를 추출하기 위해 사용한다면 서비스는 혼란 예산을 표기한 서비스는 그 예산이 존중은 존중될 것이다. 파드가 즉각적으로 재스케줄 할 수 있도록 항상 중요 서비스를 위한 추가 용량을 할당해야 한다.</p>
















<h2 id="정리하기">정리하기</h2>
<ul>
<li><code>kubectl uncordon</code>은 클러스터 내에 모든 노드를 통제 해제한다.</li>
<li>이 튜토리얼에서 사용한 퍼시스턴트 볼륨을 위한
퍼시스턴트 스토리지 미디어를 삭제하자.
귀하의 환경과 스토리지 구성과 프로비저닝 방법에서 필요한 절차를 따라서
모든 스토리지가 재확보되도록 하자.</li>
</ul>











    
            
  <h2>피드백</h2>
  <p class="feedback--prompt">이 페이지가 도움이 되었나요? </p>
  <button class="button feedback--yes">네</button>
  <button class="button feedback--no">아니요</button>
  <p class="feedback--response feedback--response__hidden">
    피드백 감사합니다. 쿠버네티스 사용 방법에 대해서 구체적이고 답변 가능한 질문이 있다면, 다음 링크에서 질문하십시오.
    <a target="_blank" rel="noopener"
      href="https://stackoverflow.com/questions/tagged/kubernetes">
      Stack Overflow</a>.
    원한다면 GitHub 리포지터리에 이슈를 열어서
    <a class="feedback--link" target="_blank" rel="noopener"
      href="https://github.com/kubernetes/website/issues/new?title=Issue%20with%20k8s.io">
      문제 리포트</a>
    또는
    <a class="feedback--link" target="_blank" rel="noopener"
      href="https://github.com/kubernetes/website/issues/new?title=Improvement%20for%20k8s.io">
      개선 제안이 가능합니다.</a>.
  </p>
  <script>
    const yes = document.querySelector('.feedback--yes');
    const no = document.querySelector('.feedback--no');
    document.querySelectorAll('.feedback--link').forEach(link => {
      link.href = link.href + window.location.pathname;
    });
    const sendFeedback = (value) => {
      if (!gtag) { console.log('!gtag'); }
      gtag('event', 'click', {
        'event_category': 'Helpful',
        'event_label': window.location.pathname,
        value
      });
    };
    const disableButtons = () => {
      yes.disabled = true;
      yes.classList.add('feedback--button__disabled');
      no.disabled = true;
      no.classList.add('feedback--button__disabled');
    };
    yes.addEventListener('click', () => {
      sendFeedback(1);
      disableButtons();
      document.querySelector('.feedback--response').classList.remove('feedback--response__hidden');
    });
    no.addEventListener('click', () => {
      sendFeedback(0);
      disableButtons();
      document.querySelector('.feedback--response').classList.remove('feedback--response__hidden');
    });
  </script>


    
            <div id="pre-footer"> 
  <hr />

  <div class="issue-button-container">
    <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/tutorials/stateful-application/zookeeper.md?pixel" alt="Analytics" /></a></p>
    
    
    <script type="text/javascript">
    PDRTJS_settings_8345992 = {
    "id" : "8345992",
    "unique_id" : "\/ko\/docs\/tutorials\/stateful-application\/zookeeper\/",
    "title" : "분산 시스템 코디네이터 ZooKeeper 실행하기",
    "permalink" : "https:\/\/kubernetes.io\/ko\/docs\/tutorials\/stateful-application\/zookeeper\/"
    };
    (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
    </script>
    <a href="" onclick="window.open('https://github.com/kubernetes/website/issues/new?template=bug-report.md&title=Issue%20with%20' +
    'k8s.io'+window.location.pathname)" class="button issue">이슈 생성하기</a>
    
    
    
    <a href="https://github.com/kubernetes/website/edit/master/content/ko/docs/tutorials/stateful-application/zookeeper.md" class="button issue">페이지 편집하기</a>
    
  </div>
  

  <div id="lastedit" class="lastedit issue-button-container">
    최종 수정일시 March 13, 2020 at 10:40 AM PST , 다음 변경에 의해서:
    <a href="https://github.com/kubernetes/website/commit/3a3d25736ab612a15076b785346eb3117a969f10/">Merge sixth Korean l10n work for release 1.17 (#19615)</a> (<a href="https://github.com/kubernetes/website/commits/master/content/en/docs/tutorials/stateful-application/zookeeper.md">페이지 변경 이력</a>)
  </div>
  
</div>

          </div>
        </section>
    </main>
		<footer>
    <div class="light-text main-section">
        <nav>
            
            
            
            <a href="/ko/docs/home/">홈</a>
            
            
            
            <a href="/ko/training/">교육</a>
            
            
            
            
            
            <a href="/ko/case-studies/">사례 연구</a>
            
        </nav>
        <div class="social" role="region" aria-label="Social hyperlinks">
            <div>
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>GitHub</span></a>
                <a href="https://slack.k8s.io/" class="slack"><span>Slack</span></a>
            </div>
            <div>
                <a href="https://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://www.youtube.com/kubernetescommunity" class="youtube"><span>YouTube</span></a>
                <a href="https://discuss.kubernetes.io" class="mailing-list"><span>Forum</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>이벤트 캘린더</span></a>
            </div>
            <div>
                
                <a href="https://git.k8s.io/community/contributors/guide" class="button">기여하기</a>
            </div>
        </div>
        <div class="miceType center">
            &copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href="https://git.k8s.io/website/LICENSE" class="light-text">CC BY 4.0</a></a>
        </div>
        <div class="miceType center">
            Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage" class="light-text">Trademark Usage page</a>
        </div>
        <div class="miceType center">
            ICP license: 京ICP备17074266号-3
        </div>
    </div>
</footer>

		<button class="flyout-button" onclick="kub.toggleToc()" aria-label="Toggle table of contents visibility"></button>

<script>

(function () {
    window.addEventListener('DOMContentLoaded', init)

        
        function init() {
            window.removeEventListener('DOMContentLoaded', init)
                hideNav()
        }

    function hideNav(toc){
        if (!toc) toc = document.querySelector('#docsToc')
        if (!toc) return
            var container = toc.querySelector('.container')

                
                if (container) {
                    if (container.childElementCount === 0 || toc.querySelectorAll('a.item').length === 1) {
                        toc.style.display = 'none'
                            document.getElementById('docsContent').style.width = '100%'
                    }
                } else {
                    requestAnimationFrame(function () {
                        hideNav(toc)
                    })
                }
    }
})();
</script>



    <script language="application/javascript">
      
      (function addHeadingLinks(){
        var article = document.getElementById('docsContent');
        var headings = article.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(function(heading){
          if(heading.id){
            var a = document.createElement('a');
            a.innerHTML = heading.innerHTML;
            a.href = '#'+heading.id;
            a.classList.add('inpage_heading');
            heading.innerHTML = '';
            heading.appendChild(a);
          }
        });
      })();
    </script>
	</body>
</html>
