<!DOCTYPE html>
<html id="docs" lang="zh" class="">
	<head>
	

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-36037335-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-36037335-10');
</script>
<meta charset="utf-8">
<title>集群 - Kubernetes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#326ce5">
<link rel="shortcut icon" type="image/png" href="/images/favicon.png">









<link rel="stylesheet" href="/css/style.b7b8403eb5b1fddd0a2da2a8383d5b53e6ef81c23e4b0e292e6103bd91f9502d.css" integrity="sha256-t7hAPrWx/d0KLaKoOD1bU&#43;bvgcI&#43;Sw4pLmEDvZH5UC0=">


<link rel="stylesheet" href="/css/base_fonts.css">
<link rel="stylesheet" href="/css/jquery-ui.min.css">
<link rel="stylesheet" href="/css/callouts.css">
<link rel="stylesheet" href="/css/custom-jekyll/tags.css">



<meta name="description" content="">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:url" content="https://kubernetes.io/zh/docs/tutorials/clusters/">
<meta property="og:title" content="集群">
<meta name="twitter:title" content="集群">
<meta name="twitter:image" content="https://kubernetes.io/images/favicon.png" />

<meta name="twitter:image:alt" content="Kubernetes">

<meta property="og:image" content="/images/kubernetes-horizontal-color.png">

<meta property="og:type" content="article">
<script src="/js/anchor-4.1.1.min.js"></script>
<script src="/js/jquery-3.2.1.min.js"></script>
<script src="/js/jquery-ui-1.12.1.min.js"></script>
<script src="/js/bootstrap-4.3.1.min.js"></script>
<script src="/js/sweetalert-2.1.2.min.js"></script>

<script src="/js/script.js"></script>
<script src="/js/custom-jekyll/tags.js"></script>


	</head>
	<body>
		<div id="cellophane" onclick="kub.toggleMenu()"></div>

<header>
    <a href="/zh/" class="logo" title="生产级别的容器编排系统 - Kubernetes" aria-label="Kubernetes website"></a>

    <div class="nav-buttons" data-auto-burger="primary">
        <ul class="global-nav">
            
            
            <li><a href="/zh/docs/" class="active">文档</a></li>
            
            <li><a href="/zh/blog/">博客</a></li>
            
            
            
            <li><a href="/zh/partners/">合作伙伴</a></li>
            
            <li><a href="/zh/community/">社区</a></li>
            
            <li><a href="/zh/case-studies/">案例分析</a></li>
            
            
            
             <li>
                <a href="#">
                    中文 Chinese <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                    <li><a href="/docs/tutorials/clusters/">English</a></li>
                
                    <li><a href="/ko/docs/tutorials/clusters/">한국어 Korean</a></li>
                
                    <li><a href="/fr/docs/tutorials/clusters/">Français</a></li>
                
                    <li><a href="/es/docs/tutorials/clusters/">Español</a></li>
                
                </ul>
            </li>

            <li>
                <a href="#">
                    v1.17 <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                    <li><a href="https://kubernetes.io/zh/docs/tutorials/clusters/">v1.21</a></li>
                
                    <li><a href="https://v1-20.docs.kubernetes.io/zh/docs/tutorials/clusters/">v1.20</a></li>
                
                    <li><a href="https://v1-19.docs.kubernetes.io/zh/docs/tutorials/clusters/">v1.19</a></li>
                
                    <li><a href="https://v1-18.docs.kubernetes.io/zh/docs/tutorials/clusters/">v1.18</a></li>
                
                    <li><a href="https://v1-17.docs.kubernetes.io/zh/docs/tutorials/clusters/">v1.17</a></li>
                
                </ul>
            </li>
        </ul>
        
        <a href="/zh/docs/tutorials/kubernetes-basics/" class="button" id="tryKubernetes" data-auto-burger-exclude>学习 Kubernetes 基础知识</a>
        

        <button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
    </div>

    <nav id="mainNav">
        <div class="main-section" data-auto-burger="primary">
         
           <div class="nav-box">
            <h3><a href="/zh/docs/tutorials/hello-minikube/">Get Started</a></h3>
           <p>Ready to get your hands dirty? Build a simple Kubernetes cluster that runs "Hello World" for Node.js.</p>

            </div>
         
           <div class="nav-box">
            <h3><a href="/zh/docs/home/">文档</a></h3>
           <p>通过演练，示例和参考文档了解如何使用 Kubernetes。你甚至可以<a href="/editdocs/" data-auto-burger-exclude>帮助贡献文档</a>！</p>

            </div>
         
           <div class="nav-box">
            <h3><a href="/zh/blog/">博客</a></h3>
           <p>阅读关于 kubernetes 和容器规范的最新信息,以及获取最新的技术。</p>

            </div>
         
        </div>
        <div class="main-section" data-auto-burger="primary">
            <div class="left">
                <h5 class="github-invite">想要修改 Kubernetes 的核心源代码？</h5>
                <a href="https://github.com/kubernetes/kubernetes" class="button" data-auto-burger-exclude>在 GitHub 上查看</a>
            </div>

            <div class="right">
                <h5 class="github-invite">了解社区</h5>
                <div class="social">
                    <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                    <a href="https://github.com/kubernetes/kubernetes" class="github"><span>GitHub</span></a>
                    <a href="http://slack.k8s.io/" class="slack"><span>Slack Slack</span></a>
                    <a href="https://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                    <a href="https://www.youtube.com/kubernetescommunity" class="youtube"><span>YouTube</span></a>
                    <a href="https://discuss.kubernetes.io" class="mailing-list"><span>论坛</span></a>
                    <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>事件日历</span></a>
                </div>
            </div>
            <div class="clear" style="clear: both"></div>
        </div>
    </nav>
</header>

		
		
		<section id="hero" class="light-text no-sub">
			













<h1>教程</h1>
<h5></h5>






<div id="vendorStrip" class="light-text">
	<ul>
		
		
		<li><a href="/zh/docs/home/">主页</a></li>
		
		
		<li><a href="/zh/docs/setup/">入门</a></li>
		
		
		<li><a href="/zh/docs/concepts/">概念</a></li>
		
		
		<li><a href="/zh/docs/tasks/">任务</a></li>
		
		
		<li><a href="/zh/docs/tutorials/" class="YAH">教程</a></li>
		
		
		<li><a href="/zh/docs/reference/">参考</a></li>
		
		
		<li><a href="/zh/docs/contribute/">贡献</a></li>
		
	</ul>
	<form id="searchBox" action="/docs/search/" role="search">
		<input type="text" id="search" name="q" placeholder="搜索" aria-label="Search">
	</form>
</div>

		</section>
		
    
		
<section id="deprecationWarning">
  <main>
    <div class="content deprecation-warning">
      <h3>
	 Kubernetes v1.17
	  版本的文档已不再维护。您现在看到的版本来自于一份静态的快照。如需查阅最新文档，请点击
	 <a href="https://kubernetes.io/docs/home/">最新版本。</a>
      </h3>
    </div>
  </main>
</section>


    <main>
        <section id="encyclopedia">
          
<div id="docsToc">
     <div class="pi-accordion">
    	
        
        
        
        
        
         
             
                 
             
         
             
                 
             
         
             
                 
             
         
             
                 
             
         
             
                 
                          
                          
                 
             
         
             
         
             
         
         
        
        <a class="item" data-title="教程" href="/zh/docs/tutorials/"></a>

	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="你好 Minikube" href="/zh/docs/tutorials/hello-minikube/"></a>

		
	
		
			
<div class="item" data-title="学习 Kubernetes 基础知识">
	<div class="container">
		
		
		
		<a class="item" data-title="学习 Kubernetes 基础知识" href="/zh/docs/tutorials/kubernetes-basics/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			
<div class="item" data-title="创建集群">
	<div class="container">
		
		
		
		<a class="item" data-title="创建集群" href="/zh/docs/tutorials/kubernetes-basics/create-cluster/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="Using Minikube to Create a Cluster" href="/zh/docs/tutorials/kubernetes-basics/create-cluster/cluster-intro/"></a>

		
	
		
			

<a class="item" data-title="交互式教程 - 创建集群" href="/zh/docs/tutorials/kubernetes-basics/create-cluster/cluster-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="部署应用">
	<div class="container">
		
		
		
		<a class="item" data-title="部署应用" href="/zh/docs/tutorials/kubernetes-basics/deploy-app/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="使用 kubectl 创建 Deployment" href="/zh/docs/tutorials/kubernetes-basics/deploy-app/deploy-intro/"></a>

		
	
		
			

<a class="item" data-title="交互式教程 - 部署应用程序" href="/zh/docs/tutorials/kubernetes-basics/deploy-app/deploy-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="了解你的应用">
	<div class="container">
		
		
		
		<a class="item" data-title="了解你的应用" href="/zh/docs/tutorials/kubernetes-basics/explore/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="查看 pod 和工作节点" href="/zh/docs/tutorials/kubernetes-basics/explore/explore-intro/"></a>

		
	
		
			

<a class="item" data-title="交互式教程-探索您的应用程序" href="/zh/docs/tutorials/kubernetes-basics/explore/explore-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="公开地暴露你的应用">
	<div class="container">
		
		
		
		<a class="item" data-title="公开地暴露你的应用" href="/zh/docs/tutorials/kubernetes-basics/expose/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="Using a Service to Expose Your App" href="/zh/docs/tutorials/kubernetes-basics/expose/expose-intro/"></a>

		
	
		
			

<a class="item" data-title="交互式教程 - 发布您的应用程序" href="/zh/docs/tutorials/kubernetes-basics/expose/expose-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="伸缩您的应用">
	<div class="container">
		
		
		
		<a class="item" data-title="伸缩您的应用" href="/zh/docs/tutorials/kubernetes-basics/scale/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="运行应用程序的多个实例" href="/zh/docs/tutorials/kubernetes-basics/scale/scale-intro/"></a>

		
	
		
			

<a class="item" data-title="交互教程 - 缩放你的应用程序" href="/zh/docs/tutorials/kubernetes-basics/scale/scale-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="更新你的应用">
	<div class="container">
		
		
		
		<a class="item" data-title="更新你的应用" href="/zh/docs/tutorials/kubernetes-basics/update/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="执行滚动更新" href="/zh/docs/tutorials/kubernetes-basics/update/update-intro/"></a>

		
	
		
			

<a class="item" data-title="交互式教程 - 更新应用" href="/zh/docs/tutorials/kubernetes-basics/update/update-interactive/"></a>

		
	

	</div>
</div>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="在线培训课程">
	<div class="container">
		
		
		
		<a class="item" data-title="在线培训课程" href="/zh/docs/tutorials/online-training/"></a>
		
		
	
	
			
			
		
	
	
	
		
			

<a class="item" data-title="Kubernetes 在线培训概述" href="/zh/docs/tutorials/online-training/overview/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="配置">
	<div class="container">
		
		
		
		<a class="item" data-title="配置" href="/zh/docs/tutorials/configuration/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="使用 ConfigMap 来配置 Redis" href="/zh/docs/tutorials/configuration/configure-redis-using-configmap/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="无状态应用程序">
	<div class="container">
		
		
		
		<a class="item" data-title="无状态应用程序" href="/zh/docs/tutorials/stateless-application/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="公开外部 IP 地址以访问集群中应用程序" href="/zh/docs/tutorials/stateless-application/expose-external-ip-address/"></a>

		
	
		
			

<a class="item" data-title="示例：使用 Redis 部署 PHP 留言板应用程序" href="/zh/docs/tutorials/stateless-application/guestbook/"></a>

		
	
		
			

<a class="item" target="_blank" data-title="Example: Add logging and metrics to the PHP / Redis Guestbook example <small>(EN)</small>" href="/docs/tutorials/stateless-application/guestbook-logs-metrics-with-elk/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="有状态的应用">
	<div class="container">
		
		
		
		<a class="item" data-title="有状态的应用" href="/zh/docs/tutorials/stateful-application/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="示例：使用 Persistent Volumes 部署 WordPress 和 MySQL" href="/zh/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/"></a>

		
	
		
			

<a class="item" data-title="StatefulSet 基础" href="/zh/docs/tutorials/stateful-application/basic-stateful-set/"></a>

		
	
		
			

<a class="item" data-title="示例：使用 Stateful Sets 部署 Cassandra" href="/zh/docs/tutorials/stateful-application/cassandra/"></a>

		
	
		
			

<a class="item" data-title="运行 ZooKeeper， 一个 CP 分布式系统" href="/zh/docs/tutorials/stateful-application/zookeeper/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="集群">
	<div class="container">
		
		
		
		<a class="item" data-title="集群" href="/zh/docs/tutorials/clusters/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="AppArmor" href="/zh/docs/tutorials/clusters/apparmor/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Services">
	<div class="container">
		
		
		
		<a class="item" data-title="Services" href="/zh/docs/tutorials/services/"></a>
		
		
	
	
			
			
			
			
			
		
	
	
	
		
			

<a class="item" data-title="使用 Source IP" href="/zh/docs/tutorials/services/source-ip/"></a>

		
	

	</div>
</div>

		
	





     </div> 
    <button class="push-menu-close-button" onclick="kub.toggleToc()"></button>
</div> 


          <div id="docsContent">
            
    
    
    
    
    
    
	 
    
    
    
<p>
  <a href="https://github.com/kubernetes/website/edit/master/content/zh/docs/tutorials/clusters/apparmor.md" id="editPageButton" target="_blank">
    Edit This Page
  </a>
</p>

<h1>AppArmor</h1>



<div style="margin-top: 10px; margin-bottom: 10px;">



<b>FEATURE STATE:</b> <code>Kubernetes v1.4</code>




    
    
    
    
    
<a href="#" id="feature-state-dialog-link" class="ui-state-default ui-corner-all"><span class="ui-icon ui-icon-newwin"></span>beta</a>
<div id="feature-state-dialog" class="ui-dialog-content" title="beta">
该功能目前处于 <em>beta</em> 状态，意味着：</p>

<ul>
<li>版本名称包含 beta （例如 v2beta3）。</li>
<li>代码经过了充分测试，启用该功能被认为是安全的。默认情况下被启用。</li>
<li>对整体功能的支持在未来不会被移除，尽管细节上可能会做更改。</li>
<li>在后续的 beta 或稳定版本中，对象的模式、语义可能以不兼容的方式发生变化。当这种情况发生时，我们将提供迁移到下一个版本的说明。这可能需要删除、编辑和重建 API 对象，编辑过程可能需要一些思考。这可能导致依赖该功能的应用程序停机一段时间。</li>
<li>建议仅在非业务关键场景使用该功能，因为在后续版本中可能会发生不兼容的更改。如果您有多个可以独立升级的集群，那么您可能可以放松这个限制。</li>
<li><strong>请尝试使用我们的 beta 版功能，并给出反馈！在它们退出 beta 测试阶段之后，我们将很难去做更多的更改。</strong></li>
</ul>
</div>
<script>
$(function(){
    
    $( "#feature-state-dialog" ).dialog({
        autoOpen: false,
        width: "600",
        buttons: [
            {
                text: "Ok",
                click: function() {
                    $( this ).dialog( "close" );
                }
            }
        ]
    });

    
    $( "#feature-state-dialog-link" ).click(function( event ) {
        $( "#feature-state-dialog" ).dialog( "open" );
        event.preventDefault();
    });

});
</script>

    

</div>

<!-- AppArmor is a Linux kernel security module that supplements the standard Linux user and group based
permissions to confine programs to a limited set of resources. AppArmor can be configured for any
application to reduce its potential attack surface and provide greater in-depth defense. It is
configured through profiles tuned to whitelist the access needed by a specific program or container,
such as Linux capabilities, network access, file permissions, etc. Each profile can be run in either
*enforcing* mode, which blocks access to disallowed resources, or *complain* mode, which only reports
violations. -->

<p>Apparmor 是一个 Linux 内核安全模块，它补充了标准的基于 Linux 用户和组的安全模块将程序限制为有限资源集的权限。AppArmor 可以配置为任何应用程序减少潜在的攻击面，并且提供更加深入的防御。AppArmor 是通过配置文件进行配置的，这些配置文件被调整为报名单，列出了特定程序或者容器所需要的访问权限，如 Linux 功能、网络访问、文件权限等。每个配置文件都可以在*强制*模式(阻止访问不允许的资源)或*投诉*模式(仅报告冲突)下运行。</p>












<ul id="markdown-toc">










<li><a href="#%e6%95%99%e7%a8%8b%e7%9b%ae%e6%a0%87">教程目标</a></li>












<li><a href="#%e5%87%86%e5%a4%87%e5%bc%80%e5%a7%8b">准备开始</a></li>












<li><a href="#%e4%bf%9d%e6%8a%a4-pod">保护 Pod</a></li>




<li><a href="#%e4%b8%be%e4%be%8b">举例</a></li>




<li><a href="#%e7%ae%a1%e7%90%86">管理</a></li>




<li><a href="#%e7%bc%96%e5%86%99%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6">编写配置文件</a></li>




<li><a href="#api-%e5%8f%82%e8%80%83">API 参考</a></li>




























<li><a href="#%e6%8e%a5%e4%b8%8b%e6%9d%a5">接下来</a></li>



</ul>



<h2 id="教程目标">教程目标</h2>
<!-- * See an example of how to load a profile on a node
* Learn how to enforce the profile on a Pod
* Learn how to check that the profile is loaded
* See what happens when a profile is violated
* See what happens when a profile cannot be loaded -->

<ul>
<li>查看如何在节点上加载配置文件示例</li>
<li>了解如何在 Pod 上强制执行配置文件</li>
<li>了解如何检查配置文件是否已加载</li>
<li>查看违反配置文件时会发生什么情况</li>
<li>查看无法加载配置文件时会发生什么情况</li>
</ul>





<h2 id="准备开始">准备开始</h2>
<!-- Make sure: -->

<p>务必：</p>

<!-- 1. Kubernetes version is at least v1.4 -- Kubernetes support for AppArmor was added in
   v1.4. Kubernetes components older than v1.4 are not aware of the new AppArmor annotations, and
   will **silently ignore** any AppArmor settings that are provided. To ensure that your Pods are
   receiving the expected protections, it is important to verify the Kubelet version of your nodes:

   ```shell
   kubectl get nodes -o=jsonpath=$'{range .items[*]}{@.metadata.name}: {@.status.nodeInfo.kubeletVersion}\n{end}'
   ```
   ```
   gke-test-default-pool-239f5d02-gyn2: v1.4.0
   gke-test-default-pool-239f5d02-x1kf: v1.4.0
   gke-test-default-pool-239f5d02-xwux: v1.4.0
   ``` -->

<ol>
<li><p>Kubernetes 版本至少是 v1.4 &ndash; AppArmor 在 Kubernetes v1.4 版本中才添加了对 AppArmor 的支持。早于 v1.4 版本的 Kubernetes 组件不知道新的 AppArmor 注释，并且将会 <strong>默认忽略</strong> 提供的任何 AppArmor 设置。为了确保您的 Pods 能够得到预期的保护，必须验证节点的 Kubelet 版本：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes -o<span style="color:#666">=</span><span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">$&#39;{range .items[*]}{@.metadata.name}: {@.status.nodeInfo.kubeletVersion}\n{end}&#39;</span></code></pre></div>
<pre><code>gke-test-default-pool-239f5d02-gyn2: v1.4.0
gke-test-default-pool-239f5d02-x1kf: v1.4.0
gke-test-default-pool-239f5d02-xwux: v1.4.0
</code></pre></li>
</ol>

<!-- 2. AppArmor kernel module is enabled -- For the Linux kernel to enforce an AppArmor profile, the
   AppArmor kernel module must be installed and enabled. Several distributions enable the module by
   default, such as Ubuntu and SUSE, and many others provide optional support. To check whether the
   module is enabled, check the `/sys/module/apparmor/parameters/enabled` file:

   ```shell
   cat /sys/module/apparmor/parameters/enabled
   Y
   ```

   If the Kubelet contains AppArmor support (>= v1.4), it will refuse to run a Pod with AppArmor
   options if the kernel module is not enabled.

  <blockquote class="note">
  <div><strong>注意：</strong> Ubuntu carries many AppArmor patches that have not been merged into the upstream Linux
  kernel, including patches that add additional hooks and features. Kubernetes has only been
  tested with the upstream version, and does not promise support for other features.</div>
</blockquote> -->

<ol>
<li><p>AppArmor 内核模块已启用 &ndash; 要使 Linux 内核强制执行 AppArmor 配置文件，必须安装并且启动 AppArmor 内核模块。默认情况下，有几个发行版支持该模块，如 Ubuntu 和 SUSE，还有许多发行版提供可选支持。要检查模块是否已启用，请检查
<code>/sys/module/apparmor/parameters/enabled</code> 文件：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cat /sys/module/apparmor/parameters/enabled
Y</code></pre></div>
<p>如果 Kubelet 包含 AppArmor 支持(&gt;=v1.4)，如果内核模块未启用，它将拒绝运行带有 AppArmor 选项的 Pod。</p></li>
</ol>

<p><blockquote class="note">
  <div><strong>注意：</strong> Ubuntu 携带了许多没有合并到上游 Linux 内核中的 AppArmor 补丁，包括添加附加钩子和特性的补丁。Kubernetes 只在上游版本中测试过，不承诺支持其他特性。</div>
</blockquote></p>

<!-- 3. Container runtime is Docker -- Currently the only Kubernetes-supported container runtime that
   also supports AppArmor is Docker. As more runtimes add AppArmor support, the options will be
   expanded. You can verify that your nodes are running docker with:

   ```shell
   kubectl get nodes -o=jsonpath=$'{range .items[*]}{@.metadata.name}: {@.status.nodeInfo.containerRuntimeVersion}\n{end}'
   ```
   ```
   gke-test-default-pool-239f5d02-gyn2: docker://1.11.2
   gke-test-default-pool-239f5d02-x1kf: docker://1.11.2
   gke-test-default-pool-239f5d02-xwux: docker://1.11.2
   ```

   If the Kubelet contains AppArmor support (>= v1.4), it will refuse to run a Pod with AppArmor
   options if the runtime is not Docker. -->

<ol>
<li><p>Docker 作为容器运行环境 &ndash; 目前，支持 Kubernetes 运行的容器中只有 Docker 也支持 AppArmor。随着更多的运行时添加 AppArmor 的支持，可选项将会增多。您可以使用以下命令验证节点是否正在运行 Docker:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes -o<span style="color:#666">=</span><span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">$&#39;{range .items[*]}{@.metadata.name}: {@.status.nodeInfo.containerRuntimeVersion}\n{end}&#39;</span></code></pre></div>
<pre><code>gke-test-default-pool-239f5d02-gyn2: docker://1.11.2
gke-test-default-pool-239f5d02-x1kf: docker://1.11.2
gke-test-default-pool-239f5d02-xwux: docker://1.11.2
</code></pre></li>
</ol>

<p>如果 Kubelet 包含 AppArmor 支持(&gt;=v1.4)，如果运行环境不是 Docker，它将拒绝运行带有 AppArmor 选项的 Pod。</p>

<!-- 4. Profile is loaded -- AppArmor is applied to a Pod by specifying an AppArmor profile that each
   container should be run with. If any of the specified profiles is not already loaded in the
   kernel, the Kubelet (>= v1.4) will reject the Pod. You can view which profiles are loaded on a
   node by checking the `/sys/kernel/security/apparmor/profiles` file. For example:

   ```shell
   ssh gke-test-default-pool-239f5d02-gyn2 "sudo cat /sys/kernel/security/apparmor/profiles | sort"
   ```
   ```
   apparmor-test-deny-write (enforce)
   apparmor-test-audit-write (enforce)
   docker-default (enforce)
   k8s-nginx (enforce)
   ```

   For more details on loading profiles on nodes, see
   [Setting up nodes with profiles](#setting-up-nodes-with-profiles). -->

<ol>
<li><p>配置文件已加载 &ndash; 通过指定每个容器都应使用 AppArmor 配置文件，AppArmor 应用于 Pod。如果指定的任何配置文件尚未加载到内核， Kubelet (&gt;=v1.4) 将拒绝 Pod。通过检查 <code>/sys/kernel/security/apparmor/profiles</code> 文件，可以查看节点加载了哪些配置文件。例如:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">ssh gke-test-default-pool-239f5d02-gyn2 <span style="color:#b44">&#34;sudo cat /sys/kernel/security/apparmor/profiles | sort&#34;</span></code></pre></div>
<pre><code>apparmor-test-deny-write (enforce)
apparmor-test-audit-write (enforce)
docker-default (enforce)
k8s-nginx (enforce)
</code></pre></li>
</ol>

<p><!-- For more details on loading profiles on nodes, see
   [Setting up nodes with profiles](#setting-up-nodes-with-profiles). -->
   有关在节点上加载配置文件的详细信息，请参见<a href="#setting-up-nodes-with-profiles">使用配置文件设置节点</a>。</p>

<!-- As long as the Kubelet version includes AppArmor support (>= v1.4), the Kubelet will reject a Pod
with AppArmor options if any of the prerequisites are not met. You can also verify AppArmor support
on nodes by checking the node ready condition message (though this is likely to be removed in a
later release): -->

<p>只要 Kubelet 版本包含 AppArmor 支持(&gt;=v1.4)，如果不满足任何先决条件，Kubelet 将拒绝带有 AppArmor 选项的 Pod。您还可以通过检查节点就绪状况消息来验证节点上的 AppArmor 支持(尽管这可能会在以后的版本中删除)：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes -o<span style="color:#666">=</span><span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">$&#39;{range .items[*]}{@.metadata.name}: {.status.conditions[?(@.reason==&#34;KubeletReady&#34;)].message}\n{end}&#39;</span></code></pre></div>
<pre><code>gke-test-default-pool-239f5d02-gyn2: kubelet is posting ready status. AppArmor enabled
gke-test-default-pool-239f5d02-x1kf: kubelet is posting ready status. AppArmor enabled
gke-test-default-pool-239f5d02-xwux: kubelet is posting ready status. AppArmor enabled
</code></pre>




<!-- ## Securing a Pod -->

<h2 id="保护-pod">保护 Pod</h2>

<blockquote class="note">
  <div><strong>注意：</strong> <!-- AppArmor is currently in beta, so options are specified as annotations. Once support graduates to
general availability, the annotations will be replaced with first-class fields (more details in
[Upgrade path to GA](#upgrade-path-to-general-availability)). -->

<p>AppArmor 目前处于测试阶段，因此选项被指定为注释。一旦 AppArmor 被授予支持通用，注释将替换为首要的字段(更多详情参见<a href="#upgrade-path-to-general-availability">升级到 GA 的途径</a>)。</div>
</blockquote>

<!-- AppArmor profiles are specified *per-container*. To specify the AppArmor profile to run a Pod
container with, add an annotation to the Pod's metadata: -->

<p>AppArmor 配置文件被指定为 *per-container*。要指定要用其运行 Pod 容器的 AppArmor 配置文件，请向 Pod 的元数据添加注释：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">container.apparmor.security.beta.kubernetes.io/&lt;container_name&gt;:<span style="color:#bbb"> </span>&lt;profile_ref&gt;</code></pre></div>
<!-- Where `<container_name>` is the name of the container to apply the profile to, and `<profile_ref>`
specifies the profile to apply. The `profile_ref` can be one of: -->

<p><code>&lt;container_name&gt;</code> 的名称是容器的简称，用以描述简介，并且简称为 <code>&lt;profile_ref&gt;</code> 。<code>&lt;profile_ref&gt;</code> 可以作为其中之一：</p>

<!-- * `runtime/default` to apply the runtime's default profile
* `localhost/<profile_name>` to apply the profile loaded on the host with the name `<profile_name>`
* `unconfined` to indicate that no profiles will be loaded -->

<ul>
<li><code>runtime/default</code> 应用运行时的默认配置</li>
<li><code>localhost/&lt;profile_name&gt;</code> 应用在名为 <code>&lt;profile_name&gt;</code> 的主机上加载的配置文件</li>
<li><code>unconfined</code> 表示不加载配置文件</li>
</ul>

<!-- See the [API Reference](#api-reference) for the full details on the annotation and profile name formats. -->

<p>有关注释和配置文件名称格式的详细信息，请参阅<a href="#api-reference">API 参考</a>。</p>

<!-- Kubernetes AppArmor enforcement works by first checking that all the prerequisites have been
met, and then forwarding the profile selection to the container runtime for enforcement. If the
prerequisites have not been met, the Pod will be rejected, and will not run. -->

<p>Kubernetes AppArmor 强制首先通过检查所有先决条件都已满足，然后将配置文件选择转发到容器运行时进行强制。如果未满足先决条件， Pod 将被拒绝，并且不会运行。</p>

<!-- To verify that the profile was applied, you can look for the AppArmor security option listed in the container created event: -->

<p>要验证是否应用了配置文件，可以查找容器创建事件中列出的 AppArmor 安全选项：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get events | grep Created</code></pre></div>
<pre><code>22s        22s         1         hello-apparmor     Pod       spec.containers{hello}   Normal    Created     {kubelet e2e-test-stclair-node-pool-31nt}   Created container with docker id 269a53b202d3; Security:[seccomp=unconfined apparmor=k8s-apparmor-example-deny-write]
</code></pre>

<!-- You can also verify directly that the container's root process is running with the correct profile by checking its proc attr: -->

<p>您还可以通过检查容器的 proc attr，直接验证容器的根进程是否以正确的配置文件运行：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> &lt;pod_name&gt; cat /proc/1/attr/current</code></pre></div>
<pre><code>k8s-apparmor-example-deny-write (enforce)
</code></pre>

<!-- ## Example -->

<h2 id="举例">举例</h2>

<!-- *This example assumes you have already set up a cluster with AppArmor support.* -->

<p><em>本例假设您已经使用 AppArmor 支持设置了一个集群。</em></p>

<!-- First, we need to load the profile we want to use onto our nodes. The profile we'll use simply
denies all file writes: -->

<p>首先，我们需要将要使用的配置文件加载到节点上。我们将使用的配置文件仅拒绝所有文件写入：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#080;font-style:italic">#include &lt;tunables/global&gt;</span>
profile k8s-apparmor-example-deny-write <span style="color:#b8860b">flags</span><span style="color:#666">=(</span>attach_disconnected<span style="color:#666">)</span> <span style="color:#666">{</span>
  <span style="color:#080;font-style:italic">#include &lt;abstractions/base&gt;</span>
  file,
  <span style="color:#080;font-style:italic"># Deny all file writes.</span>
  deny /** w,
<span style="color:#666">}</span></code></pre></div>
<!-- Since we don't know where the Pod will be scheduled, we'll need to load the profile on all our
nodes. For this example we'll just use SSH to install the profiles, but other approaches are
discussed in [Setting up nodes with profiles](#setting-up-nodes-with-profiles). -->

<p>由于我们不知道 Pod 将被安排在那里，我们需要在所有节点上加载配置文件。在本例中，我们将只使用 SSH 来安装概要文件，但是在<a href="#setting-up-nodes-with-profiles">使用配置文件设置节点</a>中讨论了其他方法。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">NODES</span><span style="color:#666">=(</span>
    <span style="color:#080;font-style:italic"># The SSH-accessible domain names of your nodes</span>
    gke-test-default-pool-239f5d02-gyn2.us-central1-a.my-k8s
    gke-test-default-pool-239f5d02-x1kf.us-central1-a.my-k8s
    gke-test-default-pool-239f5d02-xwux.us-central1-a.my-k8s<span style="color:#666">)</span>
<span style="color:#a2f;font-weight:bold">for</span> NODE in <span style="color:#b68;font-weight:bold">${</span><span style="color:#b8860b">NODES</span>[*]<span style="color:#b68;font-weight:bold">}</span>; <span style="color:#a2f;font-weight:bold">do</span> ssh <span style="color:#b8860b">$NODE</span> <span style="color:#b44">&#39;sudo apparmor_parser -q &lt;&lt;EOF
</span><span style="color:#b44">#include &lt;tunables/global&gt;
</span><span style="color:#b44">
</span><span style="color:#b44">profile k8s-apparmor-example-deny-write flags=(attach_disconnected) {
</span><span style="color:#b44">  #include &lt;abstractions/base&gt;
</span><span style="color:#b44">
</span><span style="color:#b44">  file,
</span><span style="color:#b44">
</span><span style="color:#b44">  # Deny all file writes.
</span><span style="color:#b44">  deny /** w,
</span><span style="color:#b44">}
</span><span style="color:#b44">EOF&#39;</span>
<span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<!-- Next, we'll run a simple "Hello AppArmor" pod with the deny-write profile: -->

<p>接下来，我们将运行一个带有拒绝写入配置文件的简单 &ldquo;Hello AppArmor&rdquo; pod：</p>

<table class="includecode" id="pods-security-hello-apparmor-yaml">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/zh/examples/pods/security/hello-apparmor.yaml" download="pods/security/hello-apparmor.yaml">
                    <code>pods/security/hello-apparmor.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode('pods-security-hello-apparmor-yaml')" title="Copy pods/security/hello-apparmor.yaml to clipboard">
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>hello-apparmor<span style="color:#bbb">
</span><span style="color:#bbb">  </span>annotations:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Tell Kubernetes to apply the AppArmor profile &#34;k8s-apparmor-example-deny-write&#34;.</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># Note that this is ignored if the Kubernetes node is not running version 1.4 or greater.</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>container.apparmor.security.beta.kubernetes.io/hello:<span style="color:#bbb"> </span>localhost/k8s-apparmor-example-deny-write<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>containers:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>hello<span style="color:#bbb">
</span><span style="color:#bbb">    </span>image:<span style="color:#bbb"> </span>busybox<span style="color:#bbb">
</span><span style="color:#bbb">    </span>command:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">&#34;sh&#34;</span>,<span style="color:#bbb"> </span><span style="color:#b44">&#34;-c&#34;</span>,<span style="color:#bbb"> </span><span style="color:#b44">&#34;echo &#39;Hello AppArmor!&#39; &amp;&amp; sleep 1h&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span></code></pre></div>  </td>
        </tr>
    </tbody>
</table>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create -f ./hello-apparmor.yaml</code></pre></div>
<!-- If we look at the pod events, we can see that the Pod container was created with the AppArmor
profile "k8s-apparmor-example-deny-write": -->

<p>如果我们查看 pod 事件，我们可以看到 pod 容器是用 AppArmor 配置文件 &ldquo;k8s-apparmor-example-deny-write&rdquo; 所创建的：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get events | grep hello-apparmor</code></pre></div>
<pre><code>14s        14s         1         hello-apparmor   Pod                                Normal    Scheduled   {default-scheduler }                           Successfully assigned hello-apparmor to gke-test-default-pool-239f5d02-gyn2
14s        14s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Pulling     {kubelet gke-test-default-pool-239f5d02-gyn2}   pulling image &quot;busybox&quot;
13s        13s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Pulled      {kubelet gke-test-default-pool-239f5d02-gyn2}   Successfully pulled image &quot;busybox&quot;
13s        13s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Created     {kubelet gke-test-default-pool-239f5d02-gyn2}   Created container with docker id 06b6cd1c0989; Security:[seccomp=unconfined apparmor=k8s-apparmor-example-deny-write]
13s        13s         1         hello-apparmor   Pod       spec.containers{hello}   Normal    Started     {kubelet gke-test-default-pool-239f5d02-gyn2}   Started container with docker id 06b6cd1c0989
</code></pre>

<!-- We can verify that the container is actually running with that profile by checking its proc attr: -->

<p>我们可以通过检查该配置文件的 proc attr 来验证容器是否实际使用该配置文件运行：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> hello-apparmor cat /proc/1/attr/current</code></pre></div>
<pre><code>k8s-apparmor-example-deny-write (enforce)
</code></pre>

<!-- Finally, we can see what happens if we try to violate the profile by writing to a file: -->

<p>最后，我们可以看到如果试图通过写入文件来违反配置文件，会发生什么情况：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> hello-apparmor touch /tmp/test</code></pre></div>
<pre><code>touch: /tmp/test: Permission denied
error: error executing remote command: command terminated with non-zero exit code: Error executing in Docker Container: 1
</code></pre>

<!-- To wrap up, let's look at what happens if we try to specify a profile that hasn't been loaded: -->

<p>最后，让我们看看如果我们试图指定一个尚未加载的配置文件会发生什么：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create -f /dev/stdin &lt;&lt;EOF</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>hello-apparmor<span style="color:#666">-2</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>annotations:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>container.apparmor.security.beta.kubernetes.io/hello:<span style="color:#bbb"> </span>localhost/k8s-apparmor-example-allow-write<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>containers:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>hello<span style="color:#bbb">
</span><span style="color:#bbb">    </span>image:<span style="color:#bbb"> </span>busybox<span style="color:#bbb">
</span><span style="color:#bbb">    </span>command:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">&#34;sh&#34;</span>,<span style="color:#bbb"> </span><span style="color:#b44">&#34;-c&#34;</span>,<span style="color:#bbb"> </span><span style="color:#b44">&#34;echo &#39;Hello AppArmor!&#39; &amp;&amp; sleep 1h&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span><span style="color:#bbb"></span>EOF<span style="color:#bbb">
</span><span style="color:#bbb"></span>pod/hello-apparmor<span style="color:#666">-2</span><span style="color:#bbb"> </span>created</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl describe pod hello-apparmor-2</code></pre></div>
<pre><code>Name:          hello-apparmor-2
Namespace:     default
Node:          gke-test-default-pool-239f5d02-x1kf/
Start Time:    Tue, 30 Aug 2016 17:58:56 -0700
Labels:        &lt;none&gt;
Annotations:   container.apparmor.security.beta.kubernetes.io/hello=localhost/k8s-apparmor-example-allow-write
Status:        Pending
Reason:        AppArmor
Message:       Pod Cannot enforce AppArmor: profile &quot;k8s-apparmor-example-allow-write&quot; is not loaded
IP:
Controllers:   &lt;none&gt;
Containers:
  hello:
    Container ID:
    Image:     busybox
    Image ID:
    Port:
    Command:
      sh
      -c
      echo 'Hello AppArmor!' &amp;&amp; sleep 1h
    State:              Waiting
      Reason:           Blocked
    Ready:              False
    Restart Count:      0
    Environment:        &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-dnz7v (ro)
Conditions:
  Type          Status
  Initialized   True
  Ready         False
  PodScheduled  True
Volumes:
  default-token-dnz7v:
    Type:    Secret (a volume populated by a Secret)
    SecretName:    default-token-dnz7v
    Optional:   false
QoS Class:      BestEffort
Node-Selectors: &lt;none&gt;
Tolerations:    &lt;none&gt;
Events:
  FirstSeen    LastSeen    Count    From                        SubobjectPath    Type        Reason        Message
  ---------    --------    -----    ----                        -------------    --------    ------        -------
  23s          23s         1        {default-scheduler }                         Normal      Scheduled     Successfully assigned hello-apparmor-2 to e2e-test-stclair-node-pool-t1f5
  23s          23s         1        {kubelet e2e-test-stclair-node-pool-t1f5}             Warning        AppArmor    Cannot enforce AppArmor: profile &quot;k8s-apparmor-example-allow-write&quot; is not loaded
</code></pre>

<!-- Note the pod status is Failed, with a helpful error message: `Pod Cannot enforce AppArmor: profile
"k8s-apparmor-example-allow-write" is not loaded`. An event was also recorded with the same message. -->

<p>注意 pod 呈现失败状态，并且显示一条有用的错误信息：<code>Pod Cannot enforce AppArmor: profile
&quot;k8s-apparmor-example-allow-write&quot; 未加载</code>。还用相同的消息记录了一个事件。</p>

<!-- ## Administration -->

<h2 id="管理">管理</h2>

<!-- ### Setting up nodes with profiles -->

<h3 id="使用配置文件设置节点">使用配置文件设置节点</h3>

<!-- Kubernetes does not currently provide any native mechanisms for loading AppArmor profiles onto
nodes. There are lots of ways to setup the profiles though, such as: -->

<p>Kubernetes 目前不提供任何本地机制来将 AppArmor 配置文件加载到节点上。有很多方法可以设置配置文件，例如：</p>

<!-- * Through a [DaemonSet](/docs/concepts/workloads/controllers/daemonset/) that runs a Pod on each node to
  ensure the correct profiles are loaded. An example implementation can be found
  [here](https://git.k8s.io/kubernetes/test/images/apparmor-loader).
* At node initialization time, using your node initialization scripts (e.g. Salt, Ansible, etc.) or
  image.
* By copying the profiles to each node and loading them through SSH, as demonstrated in the
  [Example](#example). -->

<ul>
<li>通过在每个节点上运行 Pod 的<a href="/docs/concepts/workloads/controllers/daemonset/">DaemonSet</a>确保加载了正确的配置文件。可以找到一个示例实现<a href="https://git.k8s.io/kubernetes/test/images/apparmor-loader" target="_blank">这里</a>。</li>
<li>在节点初始化时，使用节点初始化脚本(例如 Salt 、Ansible 等)或镜像。</li>
<li>通过将配置文件复制到每个节点并通过 SSH 加载它们，如<a href="#example">示例</a>。</li>
</ul>

<!-- The scheduler is not aware of which profiles are loaded onto which node, so the full set of profiles
must be loaded onto every node.  An alternative approach is to add a node label for each profile (or
class of profiles) on the node, and use a
[node selector](/docs/concepts/configuration/assign-pod-node/) to ensure the Pod is run on a
node with the required profile. -->

<p>调度程序不知道哪些配置文件加载到哪个节点上，因此必须将全套配置文件加载到每个节点上。另一种方法是为节点上的每个配置文件(或配置文件类)添加节点标签，并使用<a href="/docs/concepts/configuration/assign pod node/">节点选择器</a>确保 Pod 在具有所需配置文件的节点上运行。</p>

<!-- ### Restricting profiles with the PodSecurityPolicy -->

<h3 id="使用-podsecuritypolicy-限制配置文件">使用 PodSecurityPolicy 限制配置文件</h3>

<!-- If the PodSecurityPolicy extension is enabled, cluster-wide AppArmor restrictions can be applied. To
enable the PodSecurityPolicy, the following flag must be set on the `apiserver`: -->

<p>如果启用了 PodSecurityPolicy 扩展，则可以应用群集范围的 AppArmor 限制。要启用 PodSecurityPolicy，必须在“apiserver”上设置以下标志：</p>

<pre><code>--enable-admission-plugins=PodSecurityPolicy[,others...]
</code></pre>

<!-- The AppArmor options can be specified as annotations on the PodSecurityPolicy: -->

<p>AppArmor 选项可以指定为 PodSecurityPolicy 上的注释：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apparmor.security.beta.kubernetes.io/defaultProfileName:<span style="color:#bbb"> </span>&lt;profile_ref&gt;<span style="color:#bbb">
</span><span style="color:#bbb"></span>apparmor.security.beta.kubernetes.io/allowedProfileNames:<span style="color:#bbb"> </span>&lt;profile_ref&gt;[,others...]</code></pre></div>
<!-- The default profile name option specifies the profile to apply to containers by default when none is
specified. The allowed profile names option specifies a list of profiles that Pod containers are
allowed to be run with. If both options are provided, the default must be allowed. The profiles are
specified in the same format as on containers. See the [API Reference](#api-reference) for the full
specification. -->

<p>默认配置文件名选项指定默认情况下在未指定任何配置文件时应用于容器的配置文件。节点允许配置文件名选项指定允许 Pod 容器运行时的配置文件列表。配置文件的指定格式与容器上的相同。完整规范见<a href="#api-reference">API 参考</a>。</p>

<!-- ### Disabling AppArmor -->

<h3 id="禁用-apparmor">禁用 AppArmor</h3>

<!-- If you do not want AppArmor to be available on your cluster, it can be disabled by a command-line flag: -->

<p>如果您不希望 AppArmor 在集群上可用，可以通过命令行标志禁用它：</p>

<pre><code>--feature-gates=AppArmor=false
</code></pre>

<!-- When disabled, any Pod that includes an AppArmor profile will fail validation with a "Forbidden"
error. Note that by default docker always enables the "docker-default" profile on non-privileged
pods (if the AppArmor kernel module is enabled), and will continue to do so even if the feature-gate
is disabled. The option to disable AppArmor will be removed when AppArmor graduates to general
availability (GA). -->

<p>禁用时，任何包含 AppArmor 配置文件的 Pod 都将因 &ldquo;Forbidden&rdquo; 错误而导致验证失败。注意，默认情况下，docker 总是在非特权 pods 上启用 &ldquo;docker-default&rdquo; 配置文件(如果 AppArmor 内核模块已启用)，并且即使功能门已禁用，也将继续启用该配置文件。当 AppArmor 应用于通用(GA)时，禁用 Apparmor 的选项将被删除。</p>

<!-- ### Upgrading to Kubernetes v1.4 with AppArmor -->

<h3 id="使用-apparmor-升级到-kubernetes-v1-4">使用 AppArmor 升级到 Kubernetes v1.4</h3>

<!-- No action is required with respect to AppArmor to upgrade your cluster to v1.4. However, if any
existing pods had an AppArmor annotation, they will not go through validation (or PodSecurityPolicy
admission). If permissive profiles are loaded on the nodes, a malicious user could pre-apply a
permissive profile to escalate the pod privileges above the docker-default. If this is a concern, it
is recommended to scrub the cluster of any pods containing an annotation with
`apparmor.security.beta.kubernetes.io`. -->

<p>不需要对 AppArmor 执行任何操作即可将集群升级到 v1.4。但是，如果任何现有的 pods 有一个 AppArmor 注释，它们将不会通过验证(或 PodSecurityPolicy 认证)。如果节点上加载了许可配置文件，恶意用户可以预先应用许可配置文件，将 pod 权限提升到 docker-default 权限之上。如果存在这个问题，建议清除包含 <code>apparmor.security.beta.kubernetes.io</code> 注释的任何 pods 的集群。</p>

<!-- ### Upgrade path to General Availability -->

<h3 id="升级到一般可用性的途径">升级到一般可用性的途径</h3>

<!-- When AppArmor is ready to be graduated to general availability (GA), the options currently specified
through annotations will be converted to fields. Supporting all the upgrade and downgrade paths
through the transition is very nuanced, and will be explained in detail when the transition
occurs. We will commit to supporting both fields and annotations for at least 2 releases, and will
explicitly reject the annotations for at least 2 releases after that. -->

<p>当 Apparmor 准备升级到通用(GA)时，当前指定的选项通过注释将转换为字段。通过转换支持所有升级和降级路径是非常微妙的，并将在转换发生时详细解释。我们将承诺在至少两个版本中同时支持字段和注释，并在之后的至少两个版本中显式拒绝注释。</p>

<!-- ## Authoring Profiles -->

<h2 id="编写配置文件">编写配置文件</h2>

<!-- Getting AppArmor profiles specified correctly can be a tricky business. Fortunately there are some
tools to help with that: -->

<p>获得正确指定的 AppArmor 配置文件可能是一件棘手的事情。幸运的是，有一些工具可以帮助您做到这一点：</p>

<!-- * `aa-genprof` and `aa-logprof` generate profile rules by monitoring an application's activity and
  logs, and admitting the actions it takes. Further instructions are provided by the
  [AppArmor documentation](https://gitlab.com/apparmor/apparmor/wikis/Profiling_with_tools).
* [bane](https://github.com/jfrazelle/bane) is an AppArmor profile generator for Docker that uses a
  simplified profile language. -->

<ul>
<li><code>aa-genprof</code> and <code>aa-logprof</code> 通过监视应用程序的活动和日志并承认它所采取的操作来生成配置文件规则。更多说明由<a href="https://gitlab.com/apparmor/apparmor/wikis/Profiling_with_tools" target="_blank">AppArmor 文档</a>提供。</li>
<li><a href="https://github.com/jfrazelle/bane" target="_blank">bane</a>是一个用于 Docker的 AppArmor 档案生成器，它使用简化的档案语言。</li>
</ul>

<!-- It is recommended to run your application through Docker on a development workstation to generate
the profiles, but there is nothing preventing running the tools on the Kubernetes node where your
Pod is running. -->

<p>建议在开发工作站上通过 Docker 运行应用程序以生成配置文件，但是没有什么可以阻止在运行 Pod 的 Kubernetes 节点上运行工具。</p>

<!-- To debug problems with AppArmor, you can check the system logs to see what, specifically, was
denied. AppArmor logs verbose messages to `dmesg`, and errors can usually be found in the system
logs or through `journalctl`. More information is provided in
[AppArmor failures](https://gitlab.com/apparmor/apparmor/wikis/AppArmor_Failures). -->

<p>想要调试 AppArmor 的问题，您可以检查系统日志，查看具体拒绝了什么。AppArmor 将详细消息记录到 <code>dmesg</code> ，错误通常可以在系统日志中或通过 <code>journalctl</code> 找到。更多详细信息见<a href="https://gitlab.com/apparmor/apparmor/wikis/AppArmor_Failures" target="_blank">AppArmor 失败</a>。</p>

<!-- ## API Reference -->

<h2 id="api-参考">API 参考</h2>

<!-- ### Pod Annotation -->

<h3 id="pod-注释">Pod 注释</h3>

<!-- Specifying the profile a container will run with: -->

<p>指定容器将使用的配置文件：</p>

<!-- - **key**: `container.apparmor.security.beta.kubernetes.io/<container_name>`
  Where `<container_name>` matches the name of a container in the Pod.
  A separate profile can be specified for each container in the Pod.
- **value**: a profile reference, described below -->

<ul>
<li><strong>key</strong>: <code>container.apparmor.security.beta.kubernetes.io/&lt;container_name&gt;</code> 中的 <code>&lt;container_name&gt;</code> 匹配 Pod 中的容器名称。
可以为 Pod 中的每个容器指定单独的配置文件。</li>
<li><strong>value</strong>: 配置文件参考，如下所述</li>
</ul>

<!-- ### Profile Reference -->

<h3 id="配置文件参考">配置文件参考</h3>

<!-- - `runtime/default`: Refers to the default runtime profile.
  - Equivalent to not specifying a profile (without a PodSecurityPolicy default), except it still
    requires AppArmor to be enabled.
  - For Docker, this resolves to the
    [`docker-default`](https://docs.docker.com/engine/security/apparmor/) profile for non-privileged
    containers, and unconfined (no profile) for privileged containers.
- `localhost/<profile_name>`: Refers to a profile loaded on the node (localhost) by name.
  - The possible profile names are detailed in the
    [core policy reference](https://gitlab.com/apparmor/apparmor/wikis/AppArmor_Core_Policy_Reference#profile-names-and-attachment-specifications).
- `unconfined`: This effectively disables AppArmor on the container. -->

<ul>
<li><code>runtime/default</code>: 指默认运行时配置文件。

<ul>
<li>等同于不指定配置文件(没有 PodSecurityPolicy 默认值)，除非它仍然需要启用 AppArmor。</li>
<li>对于 Docker，这将解析为非特权容器的<a href="https://docs.docker.com/engine/security/apparmor/" target="_blank"><code>Docker default</code></a>配置文件，特权容器的配置文件为未定义(无配置文件)。</li>
</ul></li>
<li><code>localhost/&lt;profile_name&gt;</code>: 指按名称加载到节点(localhost)上的配置文件。

<ul>
<li>可能的配置文件名在 <a href="https://gitlab.com/apparmor/apparmor/wikis/AppArmor_Core_Policy_Reference#profile-names-and-attachment-specifications" target="_blank">核心策略参考</a>。</li>
</ul></li>
<li><code>unconfined</code>: 这有效地禁用了容器上的 AppArmor 。</li>
</ul>

<!-- Any other profile reference format is invalid. -->

<p>任何其他配置文件引用格式无效。</p>

<!-- ### PodSecurityPolicy Annotations -->

<h3 id="podsecuritypolicy-注解">PodSecurityPolicy 注解</h3>

<!-- Specifying the default profile to apply to containers when none is provided: -->

<p>指定在未提供容器时应用于容器的默认配置文件：</p>

<!-- * **key**: `apparmor.security.beta.kubernetes.io/defaultProfileName`
* **value**: a profile reference, described above -->

<ul>
<li><strong>key</strong>: <code>apparmor.security.beta.kubernetes.io/defaultProfileName</code></li>
<li><strong>value</strong>: 如上述文件参考所述</li>
</ul>

<!-- Specifying the list of profiles Pod containers is allowed to specify: -->

<p>上面描述的指定配置文件， Pod 容器列表的配置文件引用允许指定：</p>

<!-- * **key**: `apparmor.security.beta.kubernetes.io/allowedProfileNames`
* **value**: a comma-separated list of profile references (described above)
  - Although an escaped comma is a legal character in a profile name, it cannot be explicitly
    allowed here. -->

<ul>
<li><strong>key</strong>: <code>apparmor.security.beta.kubernetes.io/allowedProfileNames</code></li>
<li><strong>value</strong>: 配置文件引用的逗号分隔列表(如上所述)

<ul>
<li>尽管转义逗号是配置文件名中的合法字符，但此处不能显式允许。</li>
</ul></li>
</ul>



<!-- ---
reviewers:
- stclair
title: AppArmor
content_template: templates/tutorial
--- -->

















<h2 id="接下来">接下来</h2>
<!-- Additional resources: -->

<p>其他资源</p>

<!-- * [Quick guide to the AppArmor profile language](https://gitlab.com/apparmor/apparmor/wikis/QuickProfileLanguage)
* [AppArmor core policy reference](https://gitlab.com/apparmor/apparmor/wikis/Policy_Layout) -->

<ul>
<li><a href="https://gitlab.com/apparmor/apparmor/wikis/QuickProfileLanguage" target="_blank">Apparmor 配置文件语言快速指南</a></li>
<li><a href="https://gitlab.com/apparmor/apparmor/wikis/Policy_Layout" target="_blank">Apparmor 核心策略参考</a></li>
</ul>







    
    

    
            
  <h2>反馈</h2>
  <p class="feedback--prompt">此页是否对您有帮助？ </p>
  <button class="button feedback--yes">是</button>
  <button class="button feedback--no">否</button>
  <p class="feedback--response feedback--response__hidden">
    感谢反馈。如果您有一个关于如何使用 Kubernetes 的特定的、需要答案的问题，可以访问
    <a target="_blank" rel="noopener"
      href="https://stackoverflow.com/questions/tagged/kubernetes">
      Stack Overflow</a>.
    在 GitHub 仓库上登记新的问题
    <a class="feedback--link" target="_blank" rel="noopener"
      href="https://github.com/kubernetes/website/issues/new?title=Issue%20with%20k8s.io">
      报告问题</a>
    或者
    <a class="feedback--link" target="_blank" rel="noopener"
      href="https://github.com/kubernetes/website/issues/new?title=Improvement%20for%20k8s.io">
      提出改进建议</a>.
  </p>
  <script>
    const yes = document.querySelector('.feedback--yes');
    const no = document.querySelector('.feedback--no');
    document.querySelectorAll('.feedback--link').forEach(link => {
      link.href = link.href + window.location.pathname;
    });
    const sendFeedback = (value) => {
      if (!gtag) { console.log('!gtag'); }
      gtag('event', 'click', {
        'event_category': 'Helpful',
        'event_label': window.location.pathname,
        value
      });
    };
    const disableButtons = () => {
      yes.disabled = true;
      yes.classList.add('feedback--button__disabled');
      no.disabled = true;
      no.classList.add('feedback--button__disabled');
    };
    yes.addEventListener('click', () => {
      sendFeedback(1);
      disableButtons();
      document.querySelector('.feedback--response').classList.remove('feedback--response__hidden');
    });
    no.addEventListener('click', () => {
      sendFeedback(0);
      disableButtons();
      document.querySelector('.feedback--response').classList.remove('feedback--response__hidden');
    });
  </script>


    
            <div id="pre-footer"> 
  <hr />

  <div class="issue-button-container">
    <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/tutorials/clusters/_index.md?pixel" alt="Analytics" /></a></p>
    
    
    <script type="text/javascript">
    PDRTJS_settings_8345992 = {
    "id" : "8345992",
    "unique_id" : "\/zh\/docs\/tutorials\/clusters\/",
    "title" : "集群",
    "permalink" : "https:\/\/kubernetes.io\/zh\/docs\/tutorials\/clusters\/"
    };
    (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
    </script>
    <a href="" onclick="window.open('https://github.com/kubernetes/website/issues/new?template=bug-report.md&title=Issue%20with%20' +
    'k8s.io'+window.location.pathname)" class="button issue">报告 GitHub 问题</a>
    
    
    
    <a href="https://github.com/kubernetes/website/edit/master/content/zh/docs/tutorials/clusters/_index.md" class="button issue">修改本页面</a>
    
  </div>
  

  <div id="lastedit" class="lastedit issue-button-container">
    页面最后一次修改于 December 25, 2019 at 8:51 AM PST 由：
    <a href="https://github.com/kubernetes/website/commit/b8b2cc7c7443e32de70834a2b3d2186cae6eea5a/">ZH-trans: merge release1.16-temporary to master (#18217)</a> (<a href="https://github.com/kubernetes/website/commits/master/content/en/docs/tutorials/clusters/_index.md">页面历史</a>)
  </div>
  
</div>

          </div>
        </section>
    </main>
		<footer>
    <div class="light-text main-section">
        <nav>
            
            
            
            <a href="/zh/docs/home/">主页</a>
            
            <a href="/zh/blog/">博客</a>
            
            
            
            <a href="/zh/partners/">合作伙伴</a>
            
            <a href="/zh/community/">社区</a>
            
            <a href="/zh/case-studies/">案例分析</a>
            
        </nav>
        <div class="social" role="region" aria-label="Social hyperlinks">
            <div>
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>GitHub</span></a>
                <a href="https://slack.k8s.io/" class="slack"><span>Slack</span></a>
            </div>
            <div>
                <a href="https://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://www.youtube.com/kubernetescommunity" class="youtube"><span>YouTube</span></a>
                <a href="https://discuss.kubernetes.io" class="mailing-list"><span>论坛</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>事件日历</span></a>
            </div>
            <div>
                
                <a href="https://git.k8s.io/community/contributors/guide" class="button">贡献</a>
            </div>
        </div>
        <div class="miceType center">
            &copy; 2023 The Kubernetes 作者 | 文档发布基于 <a href="https://git.k8s.io/website/LICENSE" class="light-text">CC BY 4.0</a> 授权许可</a>
        </div>
        <div class="miceType center">
            Copyright &copy; 2023 Linux 基金会&reg;。保留所有权利。Linux 基金会已注册并使用商标。如需了解 Linux 基金会的商标列表，请访问<a href="https://www.linuxfoundation.org/trademark-usage" class="light-text">商标使用页面</a>
        </div>
        <div class="miceType center">
            ICP license: 京ICP备17074266号-3
        </div>
    </div>
</footer>

		<button class="flyout-button" onclick="kub.toggleToc()" aria-label="Toggle table of contents visibility"></button>

<script>

(function () {
    window.addEventListener('DOMContentLoaded', init)

        
        function init() {
            window.removeEventListener('DOMContentLoaded', init)
                hideNav()
        }

    function hideNav(toc){
        if (!toc) toc = document.querySelector('#docsToc')
        if (!toc) return
            var container = toc.querySelector('.container')

                
                if (container) {
                    if (container.childElementCount === 0 || toc.querySelectorAll('a.item').length === 1) {
                        toc.style.display = 'none'
                            document.getElementById('docsContent').style.width = '100%'
                    }
                } else {
                    requestAnimationFrame(function () {
                        hideNav(toc)
                    })
                }
    }
})();
</script>



    <script language="application/javascript">
      
      (function addHeadingLinks(){
        var article = document.getElementById('docsContent');
        var headings = article.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(function(heading){
          if(heading.id){
            var a = document.createElement('a');
            a.innerHTML = heading.innerHTML;
            a.href = '#'+heading.id;
            a.classList.add('inpage_heading');
            heading.innerHTML = '';
            heading.appendChild(a);
          }
        });
      })();
    </script>
	</body>
</html>
