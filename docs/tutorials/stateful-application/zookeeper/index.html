<!DOCTYPE html>
<html id="docs" lang="en" class="">
	<head>
	

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-36037335-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-36037335-10');
</script>
<meta charset="utf-8">
<title>Running ZooKeeper, A Distributed System Coordinator - Kubernetes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#326ce5">
<link rel="shortcut icon" type="image/png" href="/images/favicon.png">









<link rel="stylesheet" href="/css/style.b7b8403eb5b1fddd0a2da2a8383d5b53e6ef81c23e4b0e292e6103bd91f9502d.css" integrity="sha256-t7hAPrWx/d0KLaKoOD1bU&#43;bvgcI&#43;Sw4pLmEDvZH5UC0=">


<link rel="stylesheet" href="/css/base_fonts.css">
<link rel="stylesheet" href="/css/jquery-ui.min.css">
<link rel="stylesheet" href="/css/callouts.css">
<link rel="stylesheet" href="/css/custom-jekyll/tags.css">



<meta name="description" content="">
<meta property="og:description" content="">
<meta name="twitter:description" content="">
<meta property="og:url" content="https://kubernetes.io/docs/tutorials/stateful-application/zookeeper/">
<meta property="og:title" content="Running ZooKeeper, A Distributed System Coordinator">
<meta name="twitter:title" content="Running ZooKeeper, A Distributed System Coordinator">
<meta name="twitter:image" content="https://kubernetes.io/images/favicon.png" />

<meta name="twitter:image:alt" content="Kubernetes">

<meta property="og:image" content="/images/kubernetes-horizontal-color.png">

<meta property="og:type" content="article">
<script src="/js/anchor-4.1.1.min.js"></script>
<script src="/js/jquery-3.2.1.min.js"></script>
<script src="/js/jquery-ui-1.12.1.min.js"></script>
<script src="/js/bootstrap-4.3.1.min.js"></script>
<script src="/js/sweetalert-2.1.2.min.js"></script>

<script src="/js/script.js"></script>
<script src="/js/custom-jekyll/tags.js"></script>


	</head>
	<body>
		<div id="cellophane" onclick="kub.toggleMenu()"></div>

<header>
    <a href="/" class="logo" title="Production-Grade Container Orchestration - Kubernetes" aria-label="Kubernetes website"></a>

    <div class="nav-buttons" data-auto-burger="primary">
        <ul class="global-nav">
            
            
            <li><a href="/docs/" class="active">Documentation</a></li>
            
            <li><a href="/blog/">Blog</a></li>
            
            <li><a href="/training/">Training</a></li>
            
            <li><a href="/partners/">Partners</a></li>
            
            <li><a href="/community/">Community</a></li>
            
            <li><a href="/case-studies/">Case Studies</a></li>
            
            
            
             <li>
                <a href="#">
                    English <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                    <li><a href="/zh/docs/tutorials/stateful-application/zookeeper/">中文 Chinese</a></li>
                
                    <li><a href="/ko/docs/tutorials/stateful-application/zookeeper/">한국어 Korean</a></li>
                
                </ul>
            </li>

            <li>
                <a href="#">
                    v1.17 <span class="ui-icon ui-icon-carat-1-s"></span>
                </a>
                <ul>
                
                    <li><a href="https://kubernetes.io/docs/tutorials/stateful-application/zookeeper/">v1.21</a></li>
                
                    <li><a href="https://v1-20.docs.kubernetes.io/docs/tutorials/stateful-application/zookeeper/">v1.20</a></li>
                
                    <li><a href="https://v1-19.docs.kubernetes.io/docs/tutorials/stateful-application/zookeeper/">v1.19</a></li>
                
                    <li><a href="https://v1-18.docs.kubernetes.io/docs/tutorials/stateful-application/zookeeper/">v1.18</a></li>
                
                    <li><a href="https://v1-17.docs.kubernetes.io/docs/tutorials/stateful-application/zookeeper/">v1.17</a></li>
                
                </ul>
            </li>
        </ul>
        
        <a href="/docs/tutorials/kubernetes-basics/" class="button" id="tryKubernetes" data-auto-burger-exclude>Learn Kubernetes Basics</a>
        

        <button id="hamburger" onclick="kub.toggleMenu()" data-auto-burger-exclude><div></div></button>
    </div>

    <nav id="mainNav">
        <div class="main-section" data-auto-burger="primary">
         
           <div class="nav-box">
            <h3><a href="/docs/tutorials/hello-minikube/">Get Started</a></h3>
           <p>Ready to get your hands dirty? Build a simple Kubernetes cluster that runs "Hello World" for Node.js.</p>

            </div>
         
           <div class="nav-box">
            <h3><a href="/docs/home/">Documentation</a></h3>
           <p>Learn how to use Kubernetes with conceptual, tutorial, and reference documentation. You can even <a href="/editdocs/" data-auto-burger-exclude>help contribute to the docs</a>!</p>

            </div>
         
           <div class="nav-box">
            <h3><a href="/blog/">Blog</a></h3>
           <p>Read the latest news for Kubernetes and the containers space in general, and get technical how-tos hot off the presses.</p>

            </div>
         
        </div>
        <div class="main-section" data-auto-burger="primary">
            <div class="left">
                <h5 class="github-invite">Interested in hacking on the core Kubernetes code base?</h5>
                <a href="https://github.com/kubernetes/kubernetes" class="button" data-auto-burger-exclude>View On GitHub</a>
            </div>

            <div class="right">
                <h5 class="github-invite">Explore the community</h5>
                <div class="social">
                    <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                    <a href="https://github.com/kubernetes/kubernetes" class="github"><span>GitHub</span></a>
                    <a href="http://slack.k8s.io/" class="slack"><span>Slack Slack</span></a>
                    <a href="https://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                    <a href="https://www.youtube.com/kubernetescommunity" class="youtube"><span>YouTube</span></a>
                    <a href="https://discuss.kubernetes.io" class="mailing-list"><span>Forum</span></a>
                    <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
                </div>
            </div>
            <div class="clear" style="clear: both"></div>
        </div>
    </nav>
</header>

		
		
		<section id="hero" class="light-text no-sub">
			













<h1>Tutorials</h1>
<h5></h5>






<div id="vendorStrip" class="light-text">
	<ul>
		
		
		<li><a href="/docs/home/">HOME</a></li>
		
		
		<li><a href="/docs/setup/">GETTING STARTED</a></li>
		
		
		<li><a href="/docs/concepts/">CONCEPTS</a></li>
		
		
		<li><a href="/docs/tasks/">TASKS</a></li>
		
		
		<li><a href="/docs/tutorials/" class="YAH">TUTORIALS</a></li>
		
		
		<li><a href="/docs/reference/">REFERENCE</a></li>
		
		
		<li><a href="/docs/contribute/">CONTRIBUTE</a></li>
		
	</ul>
	<form id="searchBox" action="/docs/search/" role="search">
		<input type="text" id="search" name="q" placeholder="Search" aria-label="Search">
	</form>
</div>

		</section>
		
    
		
<section id="deprecationWarning">
  <main>
    <div class="content deprecation-warning">
      <h3>
	 Kubernetes v1.17
	  documentation is no longer actively maintained. The version you are currently viewing is a static snapshot. For up-to-date documentation, see the 
	 <a href="https://kubernetes.io/docs/home/">latest version.</a>
      </h3>
    </div>
  </main>
</section>


    <main>
        <section id="encyclopedia">
          
<div id="docsToc">
     <div class="pi-accordion">
    	
        
        
        
        
        
         
             
                 
             
         
             
                 
             
         
             
                 
             
         
             
                 
             
         
             
                 
                          
                          
                 
             
         
             
         
             
         
         
        
        <a class="item" data-title="Tutorials" href="/docs/tutorials/"></a>

	
	
	
	
		
			

<a class="item" data-title="Hello Minikube" href="/docs/tutorials/hello-minikube/"></a>

		
	
		
			
<div class="item" data-title="Learn Kubernetes Basics">
	<div class="container">
		
		
		
		<a class="item" data-title="Learn Kubernetes Basics" href="/docs/tutorials/kubernetes-basics/"></a>
		
		
	
	
	
	
		
			
<div class="item" data-title="Create a Cluster">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Using Minikube to Create a Cluster" href="/docs/tutorials/kubernetes-basics/create-cluster/cluster-intro/"></a>

		
	
		
			

<a class="item" data-title="Interactive Tutorial - Creating a Cluster" href="/docs/tutorials/kubernetes-basics/create-cluster/cluster-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Deploy an App">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Using kubectl to Create a Deployment" href="/docs/tutorials/kubernetes-basics/deploy-app/deploy-intro/"></a>

		
	
		
			

<a class="item" data-title="Interactive Tutorial - Deploying an App" href="/docs/tutorials/kubernetes-basics/deploy-app/deploy-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Explore Your App">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Viewing Pods and Nodes" href="/docs/tutorials/kubernetes-basics/explore/explore-intro/"></a>

		
	
		
			

<a class="item" data-title="Interactive Tutorial - Exploring Your App" href="/docs/tutorials/kubernetes-basics/explore/explore-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Expose Your App Publicly">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Using a Service to Expose Your App" href="/docs/tutorials/kubernetes-basics/expose/expose-intro/"></a>

		
	
		
			

<a class="item" data-title="Interactive Tutorial - Exposing Your App" href="/docs/tutorials/kubernetes-basics/expose/expose-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Scale Your App">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Running Multiple Instances of Your App" href="/docs/tutorials/kubernetes-basics/scale/scale-intro/"></a>

		
	
		
			

<a class="item" data-title="Interactive Tutorial - Scaling Your App" href="/docs/tutorials/kubernetes-basics/scale/scale-interactive/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Update Your App">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Performing a Rolling Update" href="/docs/tutorials/kubernetes-basics/update/update-intro/"></a>

		
	
		
			

<a class="item" data-title="Interactive Tutorial - Updating Your App" href="/docs/tutorials/kubernetes-basics/update/update-interactive/"></a>

		
	

	</div>
</div>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Configuration">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Configuring Redis using a ConfigMap" href="/docs/tutorials/configuration/configure-redis-using-configmap/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Stateless Applications">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Exposing an External IP Address to Access an Application in a Cluster" href="/docs/tutorials/stateless-application/expose-external-ip-address/"></a>

		
	
		
			

<a class="item" data-title="Example: Deploying PHP Guestbook application with Redis" href="/docs/tutorials/stateless-application/guestbook/"></a>

		
	
		
			

<a class="item" data-title="Example: Add logging and metrics to the PHP / Redis Guestbook example" href="/docs/tutorials/stateless-application/guestbook-logs-metrics-with-elk/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Stateful Applications">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="StatefulSet Basics" href="/docs/tutorials/stateful-application/basic-stateful-set/"></a>

		
	
		
			

<a class="item" data-title="Example: Deploying WordPress and MySQL with Persistent Volumes" href="/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/"></a>

		
	
		
			

<a class="item" data-title="Example: Deploying Cassandra with Stateful Sets" href="/docs/tutorials/stateful-application/cassandra/"></a>

		
	
		
			

<a class="item" data-title="Running ZooKeeper, A Distributed System Coordinator" href="/docs/tutorials/stateful-application/zookeeper/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Clusters">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="AppArmor" href="/docs/tutorials/clusters/apparmor/"></a>

		
	

	</div>
</div>

		
	
		
			
<div class="item" data-title="Services">
	<div class="container">
		
		
	
	
	
	
		
			

<a class="item" data-title="Using Source IP" href="/docs/tutorials/services/source-ip/"></a>

		
	

	</div>
</div>

		
	





     </div> 
    <button class="push-menu-close-button" onclick="kub.toggleToc()"></button>
</div> 


          <div id="docsContent">
            

<p>
  <a href="https://github.com/kubernetes/website/edit/master/content/en/docs/tutorials/stateful-application/zookeeper.md" id="editPageButton" target="_blank">
    Edit This Page
  </a>
</p>

<h1>Running ZooKeeper, A Distributed System Coordinator</h1>



<p>This tutorial demonstrates running <a href="https://zookeeper.apache.org" target="_blank">Apache Zookeeper</a> on
Kubernetes using <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a>,
<a href="/docs/concepts/workloads/pods/disruptions/#specifying-a-poddisruptionbudget">PodDisruptionBudgets</a>,
and <a href="/docs/user-guide/node-selection/#inter-pod-affinity-and-anti-affinity-beta-feature">PodAntiAffinity</a>.</p>












<ul id="markdown-toc">










<li><a href="#objectives">Objectives</a></li>












<li><a href="#before-you-begin">Before you begin</a></li>












<li><a href="#creating-a-zookeeper-ensemble">Creating a ZooKeeper Ensemble</a></li>




<li><a href="#ensuring-consistent-configuration">Ensuring Consistent Configuration</a></li>




<li><a href="#managing-the-zookeeper-process">Managing the ZooKeeper Process</a></li>




<li><a href="#tolerating-node-failure">Tolerating Node Failure</a></li>




<li><a href="#surviving-maintenance">Surviving Maintenance</a></li>




















<li><a href="#cleaning-up">Cleaning up</a></li>











</ul>



<h2 id="objectives">Objectives</h2>
<p>After this tutorial, you will know the following.</p>

<ul>
<li>How to deploy a ZooKeeper ensemble using StatefulSet.</li>
<li>How to consistently configure the ensemble using ConfigMaps.</li>
<li>How to spread the deployment of ZooKeeper servers in the ensemble.</li>
<li>How to use PodDisruptionBudgets to ensure service availability during planned maintenance.
<br /></li>
</ul>





<h2 id="before-you-begin">Before you begin</h2>
<p>Before starting this tutorial, you should be familiar with the following
Kubernetes concepts.</p>

<ul>
<li><a href="/docs/user-guide/pods/single-container/">Pods</a></li>
<li><a href="/docs/concepts/services-networking/dns-pod-service/">Cluster DNS</a></li>
<li><a href="/docs/concepts/services-networking/service/#headless-services">Headless Services</a></li>
<li><a href="/docs/concepts/storage/volumes/">PersistentVolumes</a></li>
<li><a href="https://github.com/kubernetes/examples/tree/v1.17.17/staging/persistent-volume-provisioning/" target="_blank">PersistentVolume Provisioning</a></li>
<li><a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSets</a></li>
<li><a href="/docs/concepts/workloads/pods/disruptions/#specifying-a-poddisruptionbudget">PodDisruptionBudgets</a></li>
<li><a href="/docs/user-guide/node-selection/#inter-pod-affinity-and-anti-affinity-beta-feature">PodAntiAffinity</a></li>
<li><a href="/docs/user-guide/kubectl/">kubectl CLI</a></li>
</ul>

<p>You will require a cluster with at least four nodes, and each node requires at least 2 CPUs and 4 GiB of memory. In this tutorial you will cordon and drain the cluster&rsquo;s nodes. <strong>This means that the cluster will terminate and evict all Pods on its nodes, and the nodes will temporarily become unschedulable.</strong> You should use a dedicated cluster for this tutorial, or you should ensure that the disruption you cause will not interfere with other tenants.</p>

<p>This tutorial assumes that you have configured your cluster to dynamically provision
PersistentVolumes. If your cluster is not configured to do so, you
will have to manually provision three 20 GiB volumes before starting this
tutorial.</p>




<h3 id="zookeeper-basics">ZooKeeper Basics</h3>

<p><a href="https://zookeeper.apache.org/doc/current/" target="_blank">Apache ZooKeeper</a> is a
distributed, open-source coordination service for distributed applications.
ZooKeeper allows you to read, write, and observe updates to data. Data are
organized in a file system like hierarchy and replicated to all ZooKeeper
servers in the ensemble (a set of ZooKeeper servers). All operations on data
are atomic and sequentially consistent. ZooKeeper ensures this by using the
<a href="https://pdfs.semanticscholar.org/b02c/6b00bd5dbdbd951fddb00b906c82fa80f0b3.pdf" target="_blank">Zab</a>
consensus protocol to replicate a state machine across all servers in the ensemble.</p>

<p>The ensemble uses the Zab protocol to elect a leader, and the ensemble cannot write data until that election is complete. Once complete, the ensemble uses Zab to ensure that it replicates all writes to a quorum before it acknowledges and makes them visible to clients. Without respect to weighted quorums, a quorum is a majority component of the ensemble containing the current leader. For instance, if the ensemble has three servers, a component that contains the leader and one other server constitutes a quorum. If the ensemble can not achieve a quorum, the ensemble cannot write data.</p>

<p>ZooKeeper servers keep their entire state machine in memory, and write every mutation to a durable WAL (Write Ahead Log) on storage media. When a server crashes, it can recover its previous state by replaying the WAL. To prevent the WAL from growing without bound, ZooKeeper servers will periodically snapshot them in memory state to storage media. These snapshots can be loaded directly into memory, and all WAL entries that preceded the snapshot may be discarded.</p>

<h2 id="creating-a-zookeeper-ensemble">Creating a ZooKeeper Ensemble</h2>

<p>The manifest below contains a
<a href="/docs/concepts/services-networking/service/#headless-services">Headless Service</a>,
a <a href="/docs/concepts/services-networking/service/">Service</a>,
a <a href="/docs/concepts/workloads/pods/disruptions//#specifying-a-poddisruptionbudget">PodDisruptionBudget</a>,
and a <a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a>.</p>

<table class="includecode" id="application-zookeeper-zookeeper-yaml">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/application/zookeeper/zookeeper.yaml" download="application/zookeeper/zookeeper.yaml">
                    <code>application/zookeeper/zookeeper.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode('application-zookeeper-zookeeper-yaml')" title="Copy application/zookeeper/zookeeper.yaml to clipboard">
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk-hs<span style="color:#bbb">
</span><span style="color:#bbb">  </span>labels:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>ports:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>port:<span style="color:#bbb"> </span><span style="color:#666">2888</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>name:<span style="color:#bbb"> </span>server<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>port:<span style="color:#bbb"> </span><span style="color:#666">3888</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>name:<span style="color:#bbb"> </span>leader-election<span style="color:#bbb">
</span><span style="color:#bbb">  </span>clusterIP:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk-cs<span style="color:#bbb">
</span><span style="color:#bbb">  </span>labels:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>ports:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>port:<span style="color:#bbb"> </span><span style="color:#666">2181</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>name:<span style="color:#bbb"> </span>client<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>policy/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>PodDisruptionBudget<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk-pdb<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>matchLabels:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">  </span>maxUnavailable:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span>apiVersion:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span>kind:<span style="color:#bbb"> </span>StatefulSet<span style="color:#bbb">
</span><span style="color:#bbb"></span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>name:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb"></span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>selector:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>matchLabels:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">  </span>serviceName:<span style="color:#bbb"> </span>zk-hs<span style="color:#bbb">
</span><span style="color:#bbb">  </span>replicas:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>updateStrategy:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>type:<span style="color:#bbb"> </span>RollingUpdate<span style="color:#bbb">
</span><span style="color:#bbb">  </span>podManagementPolicy:<span style="color:#bbb"> </span>OrderedReady<span style="color:#bbb">
</span><span style="color:#bbb">  </span>template:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>labels:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>app:<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">    </span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>affinity:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>podAntiAffinity:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>requiredDuringSchedulingIgnoredDuringExecution:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>labelSelector:<span style="color:#bbb">
</span><span style="color:#bbb">                </span>matchExpressions:<span style="color:#bbb">
</span><span style="color:#bbb">                  </span>-<span style="color:#bbb"> </span>key:<span style="color:#bbb"> </span><span style="color:#b44">&#34;app&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">                    </span>operator:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>values:<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>-<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">              </span>topologyKey:<span style="color:#bbb"> </span><span style="color:#b44">&#34;kubernetes.io/hostname&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span>containers:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>kubernetes-zookeeper<span style="color:#bbb">
</span><span style="color:#bbb">        </span>imagePullPolicy:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span><span style="color:#bbb">        </span>image:<span style="color:#bbb"> </span><span style="color:#b44">&#34;k8s.gcr.io/kubernetes-zookeeper:1.0-3.4.10&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>resources:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>requests:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>memory:<span style="color:#bbb"> </span><span style="color:#b44">&#34;1Gi&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span>cpu:<span style="color:#bbb"> </span><span style="color:#b44">&#34;0.5&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>ports:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>containerPort:<span style="color:#bbb"> </span><span style="color:#666">2181</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>name:<span style="color:#bbb"> </span>client<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>containerPort:<span style="color:#bbb"> </span><span style="color:#666">2888</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>name:<span style="color:#bbb"> </span>server<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>containerPort:<span style="color:#bbb"> </span><span style="color:#666">3888</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>name:<span style="color:#bbb"> </span>leader-election<span style="color:#bbb">
</span><span style="color:#bbb">        </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;start-zookeeper \
</span><span style="color:#b44">          --servers=3 \
</span><span style="color:#b44">          --data_dir=/var/lib/zookeeper/data \
</span><span style="color:#b44">          --data_log_dir=/var/lib/zookeeper/data/log \
</span><span style="color:#b44">          --conf_dir=/opt/zookeeper/conf \
</span><span style="color:#b44">          --client_port=2181 \
</span><span style="color:#b44">          --election_port=3888 \
</span><span style="color:#b44">          --server_port=2888 \
</span><span style="color:#b44">          --tick_time=2000 \
</span><span style="color:#b44">          --init_limit=10 \
</span><span style="color:#b44">          --sync_limit=5 \
</span><span style="color:#b44">          --heap=512M \
</span><span style="color:#b44">          --max_client_cnxns=60 \
</span><span style="color:#b44">          --snap_retain_count=3 \
</span><span style="color:#b44">          --purge_interval=12 \
</span><span style="color:#b44">          --max_session_timeout=40000 \
</span><span style="color:#b44">          --min_session_timeout=4000 \
</span><span style="color:#b44">          --log_level=INFO&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>readinessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>livenessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>volumeMounts:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>-<span style="color:#bbb"> </span>name:<span style="color:#bbb"> </span>datadir<span style="color:#bbb">
</span><span style="color:#bbb">          </span>mountPath:<span style="color:#bbb"> </span>/var/lib/zookeeper<span style="color:#bbb">
</span><span style="color:#bbb">      </span>securityContext:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>runAsUser:<span style="color:#bbb"> </span><span style="color:#666">1000</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>fsGroup:<span style="color:#bbb"> </span><span style="color:#666">1000</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>volumeClaimTemplates:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>name:<span style="color:#bbb"> </span>datadir<span style="color:#bbb">
</span><span style="color:#bbb">    </span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>accessModes:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">&#34;ReadWriteOnce&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span><span style="color:#bbb">      </span>resources:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>requests:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>storage:<span style="color:#bbb"> </span>10Gi<span style="color:#bbb">
</span></code></pre></div>  </td>
        </tr>
    </tbody>
</table>

<p>Open a terminal, and use the
<a href="/docs/reference/generated/kubectl/kubectl-commands/#apply"><code>kubectl apply</code></a> command to create the
manifest.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/zookeeper/zookeeper.yaml</code></pre></div>
<p>This creates the <code>zk-hs</code> Headless Service, the <code>zk-cs</code> Service,
the <code>zk-pdb</code> PodDisruptionBudget, and the <code>zk</code> StatefulSet.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">service/zk-hs created
service/zk-cs created
poddisruptionbudget.policy/zk-pdb created
statefulset.apps/zk created</code></pre></div>
<p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#get"><code>kubectl get</code></a> to watch the
StatefulSet controller create the StatefulSet&rsquo;s Pods.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>Once the <code>zk-2</code> Pod is Running and Ready, use <code>CTRL-C</code> to terminate kubectl.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>          0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         18s
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s</code></pre></div>
<p>The StatefulSet controller creates three Pods, and each Pod has a container with
a <a href="http://www-us.apache.org/dist/zookeeper/stable/" target="_blank">ZooKeeper</a> server.</p>

<h3 id="facilitating-leader-election">Facilitating Leader Election</h3>

<p>Because there is no terminating algorithm for electing a leader in an anonymous network, Zab requires explicit membership configuration to perform leader election. Each server in the ensemble needs to have a unique identifier, all servers need to know the global set of identifiers, and each identifier needs to be associated with a network address.</p>

<p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a> to get the hostnames
of the Pods in the <code>zk</code> StatefulSet.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl <span style="color:#a2f">exec</span> zk-<span style="color:#b8860b">$i</span> -- hostname; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p>The StatefulSet controller provides each Pod with a unique hostname based on its ordinal index. The hostnames take the form of <code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>. Because the <code>replicas</code> field of the <code>zk</code> StatefulSet is set to <code>3</code>, the Set&rsquo;s controller creates three Pods with their hostnames set to <code>zk-0</code>, <code>zk-1</code>, and
<code>zk-2</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-0
zk-1
zk-2</code></pre></div>
<p>The servers in a ZooKeeper ensemble use natural numbers as unique identifiers, and store each server&rsquo;s identifier in a file called <code>myid</code> in the server&rsquo;s data directory.</p>

<p>To examine the contents of the <code>myid</code> file for each server use the following command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;myid zk-</span><span style="color:#b8860b">$i</span><span style="color:#b44">&#34;</span>;kubectl <span style="color:#a2f">exec</span> zk-<span style="color:#b8860b">$i</span> -- cat /var/lib/zookeeper/data/myid; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p>Because the identifiers are natural numbers and the ordinal indices are non-negative integers, you can generate an identifier by adding 1 to the ordinal.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">myid zk-0
<span style="color:#666">1</span>
myid zk-1
<span style="color:#666">2</span>
myid zk-2
<span style="color:#666">3</span></code></pre></div>
<p>To get the Fully Qualified Domain Name (FQDN) of each Pod in the <code>zk</code> StatefulSet use the following command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl <span style="color:#a2f">exec</span> zk-<span style="color:#b8860b">$i</span> -- hostname -f; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p>The <code>zk-hs</code> Service creates a domain for all of the Pods,
<code>zk-hs.default.svc.cluster.local</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-0.zk-hs.default.svc.cluster.local
zk-1.zk-hs.default.svc.cluster.local
zk-2.zk-hs.default.svc.cluster.local</code></pre></div>
<p>The A records in <a href="/docs/concepts/services-networking/dns-pod-service/">Kubernetes DNS</a> resolve the FQDNs to the Pods&rsquo; IP addresses. If Kubernetes reschedules the Pods, it will update the A records with the Pods&rsquo; new IP addresses, but the A records names will not change.</p>

<p>ZooKeeper stores its application configuration in a file named <code>zoo.cfg</code>. Use <code>kubectl exec</code> to view the contents of the <code>zoo.cfg</code> file in the <code>zk-0</code> Pod.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- cat /opt/zookeeper/conf/zoo.cfg</code></pre></div>
<p>In the <code>server.1</code>, <code>server.2</code>, and <code>server.3</code> properties at the bottom of
the file, the <code>1</code>, <code>2</code>, and <code>3</code> correspond to the identifiers in the
ZooKeeper servers&rsquo; <code>myid</code> files. They are set to the FQDNs for the Pods in
the <code>zk</code> StatefulSet.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">clientPort</span><span style="color:#666">=</span><span style="color:#666">2181</span>
<span style="color:#b8860b">dataDir</span><span style="color:#666">=</span>/var/lib/zookeeper/data
<span style="color:#b8860b">dataLogDir</span><span style="color:#666">=</span>/var/lib/zookeeper/log
<span style="color:#b8860b">tickTime</span><span style="color:#666">=</span><span style="color:#666">2000</span>
<span style="color:#b8860b">initLimit</span><span style="color:#666">=</span><span style="color:#666">10</span>
<span style="color:#b8860b">syncLimit</span><span style="color:#666">=</span><span style="color:#666">2000</span>
<span style="color:#b8860b">maxClientCnxns</span><span style="color:#666">=</span><span style="color:#666">60</span>
<span style="color:#b8860b">minSessionTimeout</span><span style="color:#666">=</span> <span style="color:#666">4000</span>
<span style="color:#b8860b">maxSessionTimeout</span><span style="color:#666">=</span> <span style="color:#666">40000</span>
autopurge.snapRetainCount<span style="color:#666">=</span><span style="color:#666">3</span>
autopurge.purgeInterval<span style="color:#666">=</span><span style="color:#666">0</span>
server.1<span style="color:#666">=</span>zk-0.zk-hs.default.svc.cluster.local:2888:3888
server.2<span style="color:#666">=</span>zk-1.zk-hs.default.svc.cluster.local:2888:3888
server.3<span style="color:#666">=</span>zk-2.zk-hs.default.svc.cluster.local:2888:3888</code></pre></div>
<h3 id="achieving-consensus">Achieving Consensus</h3>

<p>Consensus protocols require that the identifiers of each participant be unique. No two participants in the Zab protocol should claim the same unique identifier. This is necessary to allow the processes in the system to agree on which processes have committed which data. If two Pods are launched with the same ordinal, two ZooKeeper servers would both identify themselves as the same server.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>          0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         18s
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s</code></pre></div>
<p>The A records for each Pod are entered when the Pod becomes Ready. Therefore,
the FQDNs of the ZooKeeper servers will resolve to a single endpoint, and that
endpoint will be the unique ZooKeeper server claiming the identity configured
in its <code>myid</code> file.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-0.zk-hs.default.svc.cluster.local
zk-1.zk-hs.default.svc.cluster.local
zk-2.zk-hs.default.svc.cluster.local</code></pre></div>
<p>This ensures that the <code>servers</code> properties in the ZooKeepers&rsquo; <code>zoo.cfg</code> files
represents a correctly configured ensemble.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">server.1<span style="color:#666">=</span>zk-0.zk-hs.default.svc.cluster.local:2888:3888
server.2<span style="color:#666">=</span>zk-1.zk-hs.default.svc.cluster.local:2888:3888
server.3<span style="color:#666">=</span>zk-2.zk-hs.default.svc.cluster.local:2888:3888</code></pre></div>
<p>When the servers use the Zab protocol to attempt to commit a value, they will either achieve consensus and commit the value (if leader election has succeeded and at least two of the Pods are Running and Ready), or they will fail to do so (if either of the conditions are not met). No state will arise where one server acknowledges a write on behalf of another.</p>

<h3 id="sanity-testing-the-ensemble">Sanity Testing the Ensemble</h3>

<p>The most basic sanity test is to write data to one ZooKeeper server and
to read the data from another.</p>

<p>The command below executes the <code>zkCli.sh</code> script to write <code>world</code> to the path <code>/hello</code> on the <code>zk-0</code> Pod in the ensemble.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 zkCli.sh create /hello world

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
Created /hello</code></pre></div>
<p>To get the data from the <code>zk-1</code> Pod use the following command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-1 zkCli.sh get /hello</code></pre></div>
<p>The data that you created on <code>zk-0</code> is available on all the servers in the
ensemble.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WATCHER::

WatchedEvent state:SyncConnected type:None path:null
world
<span style="color:#b8860b">cZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">ctime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">mZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">mtime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">pZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">cversion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">dataVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">aclVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">ephemeralOwner</span> <span style="color:#666">=</span> 0x0
<span style="color:#b8860b">dataLength</span> <span style="color:#666">=</span> <span style="color:#666">5</span>
<span style="color:#b8860b">numChildren</span> <span style="color:#666">=</span> <span style="color:#666">0</span></code></pre></div>
<h3 id="providing-durable-storage">Providing Durable Storage</h3>

<p>As mentioned in the <a href="#zookeeper-basics">ZooKeeper Basics</a> section,
ZooKeeper commits all entries to a durable WAL, and periodically writes snapshots
in memory state, to storage media. Using WALs to provide durability is a common
technique for applications that use consensus protocols to achieve a replicated
state machine.</p>

<p>Use the <a href="/docs/reference/generated/kubectl/kubectl-commands/#delete"><code>kubectl delete</code></a> command to delete the
<code>zk</code> StatefulSet.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl delete statefulset zk
statefulset.apps <span style="color:#b44">&#34;zk&#34;</span> deleted</code></pre></div>
<p>Watch the termination of the Pods in the StatefulSet.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>When <code>zk-0</code> if fully terminated, use <code>CTRL-C</code> to terminate kubectl.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zk-2      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         11m
zk-1      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-2      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-2      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-2      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         9m
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         10m
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         11m
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         11m
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         11m</code></pre></div>
<p>Reapply the manifest in <code>zookeeper.yaml</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/zookeeper/zookeeper.yaml</code></pre></div>
<p>This creates the <code>zk</code> StatefulSet object, but the other API objects in the manifest are not modified because they already exist.</p>

<p>Watch the StatefulSet controller recreate the StatefulSet&rsquo;s Pods.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>Once the <code>zk-2</code> Pod is Running and Ready, use <code>CTRL-C</code> to terminate kubectl.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>          0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         18s
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-2      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         19s
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         40s</code></pre></div>
<p>Use the command below to get the value you entered during the <a href="#sanity-testing-the-ensemble">sanity test</a>,
from the <code>zk-2</code> Pod.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-2 zkCli.sh get /hello</code></pre></div>
<p>Even though you terminated and recreated all of the Pods in the <code>zk</code> StatefulSet, the ensemble still serves the original value.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WATCHER::

WatchedEvent state:SyncConnected type:None path:null
world
<span style="color:#b8860b">cZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">ctime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">mZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">mtime</span> <span style="color:#666">=</span> Thu Dec <span style="color:#666">08</span> <span style="color:#666">15</span>:13:30 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">pZxid</span> <span style="color:#666">=</span> 0x100000002
<span style="color:#b8860b">cversion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">dataVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">aclVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">ephemeralOwner</span> <span style="color:#666">=</span> 0x0
<span style="color:#b8860b">dataLength</span> <span style="color:#666">=</span> <span style="color:#666">5</span>
<span style="color:#b8860b">numChildren</span> <span style="color:#666">=</span> <span style="color:#666">0</span></code></pre></div>
<p>The <code>volumeClaimTemplates</code> field of the <code>zk</code> StatefulSet&rsquo;s <code>spec</code> specifies a PersistentVolume provisioned for each Pod.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">volumeClaimTemplates:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>-<span style="color:#bbb"> </span>metadata:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>name:<span style="color:#bbb"> </span>datadir<span style="color:#bbb">
</span><span style="color:#bbb">      </span>annotations:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>volume.alpha.kubernetes.io/storage-class:<span style="color:#bbb"> </span>anything<span style="color:#bbb">
</span><span style="color:#bbb">    </span>spec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>accessModes:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">&#34;ReadWriteOnce&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span><span style="color:#bbb">      </span>resources:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>requests:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>storage:<span style="color:#bbb"> </span>20Gi</code></pre></div>
<p>The <code>StatefulSet</code> controller generates a <code>PersistentVolumeClaim</code> for each Pod in
the <code>StatefulSet</code>.</p>

<p>Use the following command to get the <code>StatefulSet</code>&rsquo;s <code>PersistentVolumeClaims</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pvc -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>When the <code>StatefulSet</code> recreated its Pods, it remounts the Pods&rsquo; PersistentVolumes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME           STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE
datadir-zk-0   Bound     pvc-bed742cd-bcb1-11e6-994f-42010a800002   20Gi       RWO           1h
datadir-zk-1   Bound     pvc-bedd27d2-bcb1-11e6-994f-42010a800002   20Gi       RWO           1h
datadir-zk-2   Bound     pvc-bee0817e-bcb1-11e6-994f-42010a800002   20Gi       RWO           1h</code></pre></div>
<p>The <code>volumeMounts</code> section of the <code>StatefulSet</code>&rsquo;s container <code>template</code> mounts the PersistentVolumes in the ZooKeeper servers&rsquo; data directories.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">volumeMounts:
        - name: datadir
          mountPath: /var/lib/zookeeper</code></pre></div>
<p>When a Pod in the <code>zk</code> <code>StatefulSet</code> is (re)scheduled, it will always have the
same <code>PersistentVolume</code> mounted to the ZooKeeper server&rsquo;s data directory.
Even when the Pods are rescheduled, all the writes made to the ZooKeeper
servers&rsquo; WALs, and all their snapshots, remain durable.</p>

<h2 id="ensuring-consistent-configuration">Ensuring Consistent Configuration</h2>

<p>As noted in the <a href="#facilitating-leader-election">Facilitating Leader Election</a> and
<a href="#achieving-consensus">Achieving Consensus</a> sections, the servers in a
ZooKeeper ensemble require consistent configuration to elect a leader
and form a quorum. They also require consistent configuration of the Zab protocol
in order for the protocol to work correctly over a network. In our example we
achieve consistent configuration by embedding the configuration directly into
the manifest.</p>

<p>Get the <code>zk</code> StatefulSet.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get sts zk -o yaml
…
command:
      - sh
      - -c
      - <span style="color:#b44">&#34;start-zookeeper \
</span><span style="color:#b44">        --servers=3 \
</span><span style="color:#b44">        --data_dir=/var/lib/zookeeper/data \
</span><span style="color:#b44">        --data_log_dir=/var/lib/zookeeper/data/log \
</span><span style="color:#b44">        --conf_dir=/opt/zookeeper/conf \
</span><span style="color:#b44">        --client_port=2181 \
</span><span style="color:#b44">        --election_port=3888 \
</span><span style="color:#b44">        --server_port=2888 \
</span><span style="color:#b44">        --tick_time=2000 \
</span><span style="color:#b44">        --init_limit=10 \
</span><span style="color:#b44">        --sync_limit=5 \
</span><span style="color:#b44">        --heap=512M \
</span><span style="color:#b44">        --max_client_cnxns=60 \
</span><span style="color:#b44">        --snap_retain_count=3 \
</span><span style="color:#b44">        --purge_interval=12 \
</span><span style="color:#b44">        --max_session_timeout=40000 \
</span><span style="color:#b44">        --min_session_timeout=4000 \
</span><span style="color:#b44">        --log_level=INFO&#34;</span>
…</code></pre></div>
<p>The command used to start the ZooKeeper servers passed the configuration as command line parameter. You can also use environment variables to pass configuration to the ensemble.</p>

<h3 id="configuring-logging">Configuring Logging</h3>

<p>One of the files generated by the <code>zkGenConfig.sh</code> script controls ZooKeeper&rsquo;s logging.
ZooKeeper uses <a href="http://logging.apache.org/log4j/2.x/" target="_blank">Log4j</a>, and, by default,
it uses a time and size based rolling file appender for its logging configuration.</p>

<p>Use the command below to get the logging configuration from one of Pods in the <code>zk</code> <code>StatefulSet</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 cat /usr/etc/zookeeper/log4j.properties</code></pre></div>
<p>The logging configuration below will cause the ZooKeeper process to write all
of its logs to the standard output file stream.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">zookeeper.root.logger<span style="color:#666">=</span>CONSOLE
zookeeper.console.threshold<span style="color:#666">=</span>INFO
log4j.rootLogger<span style="color:#666">=</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#b8860b">zookeeper</span>.root.logger<span style="color:#b68;font-weight:bold">}</span>
log4j.appender.CONSOLE<span style="color:#666">=</span>org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.Threshold<span style="color:#666">=</span><span style="color:#b68;font-weight:bold">${</span><span style="color:#b8860b">zookeeper</span>.console.threshold<span style="color:#b68;font-weight:bold">}</span>
log4j.appender.CONSOLE.layout<span style="color:#666">=</span>org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern<span style="color:#666">=</span>%d<span style="color:#666">{</span>ISO8601<span style="color:#666">}</span> <span style="color:#666">[</span>myid:%X<span style="color:#666">{</span>myid<span style="color:#666">}]</span> - %-5p <span style="color:#666">[</span>%t:%C<span style="color:#666">{</span><span style="color:#666">1</span><span style="color:#666">}</span>@%L<span style="color:#666">]</span> - %m%n</code></pre></div>
<p>This is the simplest possible way to safely log inside the container. Because the applications write logs to standard out, Kubernetes will handle log rotation for you. Kubernetes also implements a sane retention policy that ensures application logs written to standard out and standard error do not exhaust local storage media.</p>

<p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#logs"><code>kubectl logs</code></a> to retrieve the last 20 log lines from one of the Pods.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl logs zk-0 --tail <span style="color:#666">20</span></code></pre></div>
<p>You can view application logs written to standard out or standard error using <code>kubectl logs</code> and from the Kubernetes Dashboard.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:16,236 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52740
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:16,237 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1136:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52740 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,155 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52749
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,155 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52749
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,156 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1137:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52749 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,222 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52750
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,222 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52750
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:26,226 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1138:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52750 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,151 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52760
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,152 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52760
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,152 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1139:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52760 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52761
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,231 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52761
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:36,231 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1140:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52761 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,149 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52767
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,149 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52767
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,149 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1141:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52767 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span>
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxnFactory@192<span style="color:#666">]</span> - Accepted socket connection from /127.0.0.1:52768
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@827<span style="color:#666">]</span> - Processing ruok <span style="color:#a2f">command</span> from /127.0.0.1:52768
<span style="color:#666">2016</span>-12-06 <span style="color:#666">19</span>:34:46,230 <span style="color:#666">[</span>myid:1<span style="color:#666">]</span> - INFO  <span style="color:#666">[</span>Thread-1142:NIOServerCnxn@1008<span style="color:#666">]</span> - Closed socket connection <span style="color:#a2f;font-weight:bold">for</span> client /127.0.0.1:52768 <span style="color:#666">(</span>no session established <span style="color:#a2f;font-weight:bold">for</span> client<span style="color:#666">)</span></code></pre></div>
<p>Kubernetes supports more powerful, but more complex, logging integrations
with <a href="/docs/tasks/debug-application-cluster/logging-stackdriver/">Stackdriver</a>
and <a href="/docs/tasks/debug-application-cluster/logging-elasticsearch-kibana/">Elasticsearch and Kibana</a>.
For cluster level log shipping and aggregation, consider deploying a <a href="https://kubernetes.io/blog/2015/06/the-distributed-system-toolkit-patterns" target="_blank">sidecar</a>
container to rotate and ship your logs.</p>

<h3 id="configuring-a-non-privileged-user">Configuring a Non-Privileged User</h3>

<p>The best practices to allow an application to run as a privileged
user inside of a container are a matter of debate. If your organization requires
that applications run as a non-privileged user you can use a
<a href="/docs/tasks/configure-pod-container/security-context/">SecurityContext</a> to control the user that
the entry point runs as.</p>

<p>The <code>zk</code> <code>StatefulSet</code>&rsquo;s Pod <code>template</code> contains a <code>SecurityContext</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">securityContext:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>runAsUser:<span style="color:#bbb"> </span><span style="color:#666">1000</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>fsGroup:<span style="color:#bbb"> </span><span style="color:#666">1000</span></code></pre></div>
<p>In the Pods&rsquo; containers, UID 1000 corresponds to the zookeeper user and GID 1000
corresponds to the zookeeper group.</p>

<p>Get the ZooKeeper process information from the <code>zk-0</code> Pod.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- ps -elf</code></pre></div>
<p>As the <code>runAsUser</code> field of the <code>securityContext</code> object is set to 1000,
instead of running as root, the ZooKeeper process runs as the zookeeper user.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">F S UID        PID  PPID  C PRI  NI ADDR SZ WCHAN  STIME TTY          TIME CMD
<span style="color:#666">4</span> S zookeep+     <span style="color:#666">1</span>     <span style="color:#666">0</span>  <span style="color:#666">0</span>  <span style="color:#666">80</span>   <span style="color:#666">0</span> -  <span style="color:#666">1127</span> -      <span style="color:#666">20</span>:46 ?        <span style="color:#666">00</span>:00:00 sh -c zkGenConfig.sh <span style="color:#666">&amp;&amp;</span> zkServer.sh start-foreground
<span style="color:#666">0</span> S zookeep+    <span style="color:#666">27</span>     <span style="color:#666">1</span>  <span style="color:#666">0</span>  <span style="color:#666">80</span>   <span style="color:#666">0</span> - <span style="color:#666">1155556</span> -    <span style="color:#666">20</span>:46 ?        <span style="color:#666">00</span>:00:19 /usr/lib/jvm/java-8-openjdk-amd64/bin/java -Dzookeeper.log.dir<span style="color:#666">=</span>/var/log/zookeeper -Dzookeeper.root.logger<span style="color:#666">=</span>INFO,CONSOLE -cp /usr/bin/../build/classes:/usr/bin/../build/lib/*.jar:/usr/bin/../share/zookeeper/zookeeper-3.4.9.jar:/usr/bin/../share/zookeeper/slf4j-log4j12-1.6.1.jar:/usr/bin/../share/zookeeper/slf4j-api-1.6.1.jar:/usr/bin/../share/zookeeper/netty-3.10.5.Final.jar:/usr/bin/../share/zookeeper/log4j-1.2.16.jar:/usr/bin/../share/zookeeper/jline-0.9.94.jar:/usr/bin/../src/java/lib/*.jar:/usr/bin/../etc/zookeeper: -Xmx2G -Xms2G -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only<span style="color:#666">=</span><span style="color:#a2f">false</span> org.apache.zookeeper.server.quorum.QuorumPeerMain /usr/bin/../etc/zookeeper/zoo.cfg</code></pre></div>
<p>By default, when the Pod&rsquo;s PersistentVolumes is mounted to the ZooKeeper server&rsquo;s data directory, it is only accessible by the root user. This configuration prevents the ZooKeeper process from writing to its WAL and storing its snapshots.</p>

<p>Use the command below to get the file permissions of the ZooKeeper data directory on the <code>zk-0</code> Pod.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> -ti zk-0 -- ls -ld /var/lib/zookeeper/data</code></pre></div>
<p>Because the <code>fsGroup</code> field of the <code>securityContext</code> object is set to 1000, the ownership of the Pods&rsquo; PersistentVolumes is set to the zookeeper group, and the ZooKeeper process is able to read and write its data.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">drwxr-sr-x <span style="color:#666">3</span> zookeeper zookeeper <span style="color:#666">4096</span> Dec  <span style="color:#666">5</span> <span style="color:#666">20</span>:45 /var/lib/zookeeper/data</code></pre></div>
<h2 id="managing-the-zookeeper-process">Managing the ZooKeeper Process</h2>

<p>The <a href="https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_supervision" target="_blank">ZooKeeper documentation</a>
mentions that &ldquo;You will want to have a supervisory process that
manages each of your ZooKeeper server processes (JVM).&rdquo; Utilizing a watchdog
(supervisory process) to restart failed processes in a distributed system is a
common pattern. When deploying an application in Kubernetes, rather than using
an external utility as a supervisory process, you should use Kubernetes as the
watchdog for your application.</p>

<h3 id="updating-the-ensemble">Updating the Ensemble</h3>

<p>The <code>zk</code> <code>StatefulSet</code> is configured to use the <code>RollingUpdate</code> update strategy.</p>

<p>You can use <code>kubectl patch</code> to update the number of <code>cpus</code> allocated to the servers.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl patch sts zk --type<span style="color:#666">=</span><span style="color:#b44">&#39;json&#39;</span> -p<span style="color:#666">=</span><span style="color:#b44">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/resources/requests/cpu&#34;, &#34;value&#34;:&#34;0.3&#34;}]&#39;</span>

statefulset.apps/zk patched</code></pre></div>
<p>Use <code>kubectl rollout status</code> to watch the status of the update.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl rollout status sts/zk

waiting <span style="color:#a2f;font-weight:bold">for</span> statefulset rolling update to <span style="color:#a2f">complete</span> <span style="color:#666">0</span> pods at revision zk-5db4499664...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
waiting <span style="color:#a2f;font-weight:bold">for</span> statefulset rolling update to <span style="color:#a2f">complete</span> <span style="color:#666">1</span> pods at revision zk-5db4499664...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
waiting <span style="color:#a2f;font-weight:bold">for</span> statefulset rolling update to <span style="color:#a2f">complete</span> <span style="color:#666">2</span> pods at revision zk-5db4499664...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
Waiting <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">1</span> pods to be ready...
statefulset rolling update <span style="color:#a2f">complete</span> <span style="color:#666">3</span> pods at revision zk-5db4499664...</code></pre></div>
<p>This terminates the Pods, one at a time, in reverse ordinal order, and recreates them with the new configuration. This ensures that quorum is maintained during a rolling update.</p>

<p>Use the <code>kubectl rollout history</code> command to view a history or previous configurations.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl rollout <span style="color:#a2f">history</span> sts/zk

statefulsets <span style="color:#b44">&#34;zk&#34;</span>
REVISION
<span style="color:#666">1</span>
<span style="color:#666">2</span></code></pre></div>
<p>Use the <code>kubectl rollout undo</code> command to roll back the modification.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl rollout undo sts/zk

statefulset.apps/zk rolled back</code></pre></div>
<h3 id="handling-process-failure">Handling Process Failure</h3>

<p><a href="/docs/user-guide/pod-states/#restartpolicy">Restart Policies</a> control how
Kubernetes handles process failures for the entry point of the container in a Pod.
For Pods in a <code>StatefulSet</code>, the only appropriate <code>RestartPolicy</code> is Always, and this
is the default value. For stateful applications you should <strong>never</strong> override
the default policy.</p>

<p>Use the following command to examine the process tree for the ZooKeeper server running in the <code>zk-0</code> Pod.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- ps -ef</code></pre></div>
<p>The command used as the container&rsquo;s entry point has PID 1, and
the ZooKeeper process, a child of the entry point, has PID 27.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">UID        PID  PPID  C STIME TTY          TIME CMD
zookeep+     <span style="color:#666">1</span>     <span style="color:#666">0</span>  <span style="color:#666">0</span> <span style="color:#666">15</span>:03 ?        <span style="color:#666">00</span>:00:00 sh -c zkGenConfig.sh <span style="color:#666">&amp;&amp;</span> zkServer.sh start-foreground
zookeep+    <span style="color:#666">27</span>     <span style="color:#666">1</span>  <span style="color:#666">0</span> <span style="color:#666">15</span>:03 ?        <span style="color:#666">00</span>:00:03 /usr/lib/jvm/java-8-openjdk-amd64/bin/java -Dzookeeper.log.dir<span style="color:#666">=</span>/var/log/zookeeper -Dzookeeper.root.logger<span style="color:#666">=</span>INFO,CONSOLE -cp /usr/bin/../build/classes:/usr/bin/../build/lib/*.jar:/usr/bin/../share/zookeeper/zookeeper-3.4.9.jar:/usr/bin/../share/zookeeper/slf4j-log4j12-1.6.1.jar:/usr/bin/../share/zookeeper/slf4j-api-1.6.1.jar:/usr/bin/../share/zookeeper/netty-3.10.5.Final.jar:/usr/bin/../share/zookeeper/log4j-1.2.16.jar:/usr/bin/../share/zookeeper/jline-0.9.94.jar:/usr/bin/../src/java/lib/*.jar:/usr/bin/../etc/zookeeper: -Xmx2G -Xms2G -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only<span style="color:#666">=</span><span style="color:#a2f">false</span> org.apache.zookeeper.server.quorum.QuorumPeerMain /usr/bin/../etc/zookeeper/zoo.cfg</code></pre></div>
<p>In another terminal watch the Pods in the <code>zk</code> <code>StatefulSet</code> with the following command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>In another terminal, terminate the ZooKeeper process in Pod <code>zk-0</code> with the following command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- pkill java</code></pre></div>
<p>The termination of the ZooKeeper process caused its parent process to terminate. Because the <code>RestartPolicy</code> of the container is Always, it restarted the parent process.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          21m
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          20m
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          19m
NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Error     <span style="color:#666">0</span>          29m
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">1</span>         29m
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">1</span>         29m</code></pre></div>
<p>If your application uses a script (such as <code>zkServer.sh</code>) to launch the process
that implements the application&rsquo;s business logic, the script must terminate with the
child process. This ensures that Kubernetes will restart the application&rsquo;s
container when the process implementing the application&rsquo;s business logic fails.</p>

<h3 id="testing-for-liveness">Testing for Liveness</h3>

<p>Configuring your application to restart failed processes is not enough to
keep a distributed system healthy. There are scenarios where
a system&rsquo;s processes can be both alive and unresponsive, or otherwise
unhealthy. You should use liveness probes to notify Kubernetes
that your application&rsquo;s processes are unhealthy and it should restart them.</p>

<p>The Pod <code>template</code> for the <code>zk</code> <code>StatefulSet</code> specifies a liveness probe.
``</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb"> </span>livenessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span></code></pre></div>
<p>The probe calls a bash script that uses the ZooKeeper <code>ruok</code> four letter
word to test the server&rsquo;s health.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b8860b">OK</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span><span style="color:#a2f">echo</span> ruok | nc <span style="color:#666">127</span>.0.0.1 <span style="color:#b8860b">$1</span><span style="color:#a2f;font-weight:bold">)</span>
<span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">[</span> <span style="color:#b44">&#34;</span><span style="color:#b8860b">$OK</span><span style="color:#b44">&#34;</span> <span style="color:#666">==</span> <span style="color:#b44">&#34;imok&#34;</span> <span style="color:#666">]</span>; <span style="color:#a2f;font-weight:bold">then</span>
    <span style="color:#a2f">exit</span> <span style="color:#666">0</span>
<span style="color:#a2f;font-weight:bold">else</span>
    <span style="color:#a2f">exit</span> <span style="color:#666">1</span>
<span style="color:#a2f;font-weight:bold">fi</span></code></pre></div>
<p>In one terminal window, use the following command to watch the Pods in the <code>zk</code> StatefulSet.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>In another window, using the following command to delete the <code>zkOk.sh</code> script from the file system of Pod <code>zk-0</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 -- rm /usr/bin/zookeeper-ready</code></pre></div>
<p>When the liveness probe for the ZooKeeper process fails, Kubernetes will
automatically restart the process for you, ensuring that unhealthy processes in
the ensemble are restarted.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>          1h
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">1</span>         1h
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">1</span>         1h</code></pre></div>
<h3 id="testing-for-readiness">Testing for Readiness</h3>

<p>Readiness is not the same as liveness. If a process is alive, it is scheduled
and healthy. If a process is ready, it is able to process input. Liveness is
a necessary, but not sufficient, condition for readiness. There are cases,
particularly during initialization and termination, when a process can be
alive but not ready.</p>

<p>If you specify a readiness probe, Kubernetes will ensure that your application&rsquo;s
processes will not receive network traffic until their readiness checks pass.</p>

<p>For a ZooKeeper server, liveness implies readiness.  Therefore, the readiness
probe from the <code>zookeeper.yaml</code> manifest is identical to the liveness probe.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span>readinessProbe:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>exec:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>command:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span>sh<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span>-c<span style="color:#bbb">
</span><span style="color:#bbb">      </span>-<span style="color:#bbb"> </span><span style="color:#b44">&#34;zookeeper-ready 2181&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>initialDelaySeconds:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>timeoutSeconds:<span style="color:#bbb"> </span><span style="color:#666">5</span></code></pre></div>
<p>Even though the liveness and readiness probes are identical, it is important
to specify both. This ensures that only healthy servers in the ZooKeeper
ensemble receive network traffic.</p>

<h2 id="tolerating-node-failure">Tolerating Node Failure</h2>

<p>ZooKeeper needs a quorum of servers to successfully commit mutations
to data. For a three server ensemble, two servers must be healthy for
writes to succeed. In quorum based systems, members are deployed across failure
domains to ensure availability. To avoid an outage, due to the loss of an
individual machine, best practices preclude co-locating multiple instances of the
application on the same machine.</p>

<p>By default, Kubernetes may co-locate Pods in a <code>StatefulSet</code> on the same node. For the three server ensemble you created, if two servers are on the same node, and that node fails, the clients of your ZooKeeper service will experience an outage until at least one of the Pods can be rescheduled.</p>

<p>You should always provision additional capacity to allow the processes of critical
systems to be rescheduled in the event of node failures. If you do so, then the
outage will only last until the Kubernetes scheduler reschedules one of the ZooKeeper
servers. However, if you want your service to tolerate node failures with no downtime,
you should set <code>podAntiAffinity</code>.</p>

<p>Use the command below to get the nodes for Pods in the <code>zk</code> <code>StatefulSet</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl get pod zk-<span style="color:#b8860b">$i</span> --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span>; <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;&#34;</span>; <span style="color:#a2f;font-weight:bold">done</span></code></pre></div>
<p>All of the Pods in the <code>zk</code> <code>StatefulSet</code> are deployed on different nodes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubernetes-node-cxpk
kubernetes-node-a5aq
kubernetes-node-2g2d</code></pre></div>
<p>This is because the Pods in the <code>zk</code> <code>StatefulSet</code> have a <code>PodAntiAffinity</code> specified.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">      </span>affinity:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>podAntiAffinity:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>requiredDuringSchedulingIgnoredDuringExecution:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>-<span style="color:#bbb"> </span>labelSelector:<span style="color:#bbb">
</span><span style="color:#bbb">                </span>matchExpressions:<span style="color:#bbb">
</span><span style="color:#bbb">                  </span>-<span style="color:#bbb"> </span>key:<span style="color:#bbb"> </span><span style="color:#b44">&#34;app&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">                    </span>operator:<span style="color:#bbb"> </span>In<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>values:<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>-<span style="color:#bbb"> </span>zk<span style="color:#bbb">
</span><span style="color:#bbb">              </span>topologyKey:<span style="color:#bbb"> </span><span style="color:#b44">&#34;kubernetes.io/hostname&#34;</span></code></pre></div>
<p>The <code>requiredDuringSchedulingIgnoredDuringExecution</code> field tells the
Kubernetes Scheduler that it should never co-locate two Pods which have <code>app</code> label
as <code>zk</code> in the domain defined by the <code>topologyKey</code>. The <code>topologyKey</code>
<code>kubernetes.io/hostname</code> indicates that the domain is an individual node. Using
different rules, labels, and selectors, you can extend this technique to spread
your ensemble across physical, network, and power failure domains.</p>

<h2 id="surviving-maintenance">Surviving Maintenance</h2>

<p><strong>In this section you will cordon and drain nodes. If you are using this tutorial
on a shared cluster, be sure that this will not adversely affect other tenants.</strong></p>

<p>The previous section showed you how to spread your Pods across nodes to survive
unplanned node failures, but you also need to plan for temporary node failures
that occur due to planned maintenance.</p>

<p>Use this command to get the nodes in your cluster.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes</code></pre></div>
<p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#cordon"><code>kubectl cordon</code></a> to
cordon all but four of the nodes in your cluster.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl cordon &lt;node-name&gt;</code></pre></div>
<p>Use this command to get the <code>zk-pdb</code> <code>PodDisruptionBudget</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pdb zk-pdb</code></pre></div>
<p>The <code>max-unavailable</code> field indicates to Kubernetes that at most one Pod from
<code>zk</code> <code>StatefulSet</code> can be unavailable at any time.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      MIN-AVAILABLE   MAX-UNAVAILABLE   ALLOWED-DISRUPTIONS   AGE
zk-pdb    N/A             <span style="color:#666">1</span>                 <span style="color:#666">1</span></code></pre></div>
<p>In one terminal, use this command to watch the Pods in the <code>zk</code> <code>StatefulSet</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk</code></pre></div>
<p>In another terminal, use this command to get the nodes that the Pods are currently scheduled on.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#666">0</span> <span style="color:#666">1</span> <span style="color:#666">2</span>; <span style="color:#a2f;font-weight:bold">do</span> kubectl get pod zk-<span style="color:#b8860b">$i</span> --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span>; <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;&#34;</span>; <span style="color:#a2f;font-weight:bold">done</span>

kubernetes-node-pb41
kubernetes-node-ixsl
kubernetes-node-i4c4</code></pre></div>
<p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#drain"><code>kubectl drain</code></a> to cordon and
drain the node on which the <code>zk-0</code> Pod is scheduled.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-0 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data
node <span style="color:#b44">&#34;kubernetes-node-pb41&#34;</span> cordoned

WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-pb41, kube-proxy-kubernetes-node-pb41; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-o5elz
pod <span style="color:#b44">&#34;zk-0&#34;</span> deleted
node <span style="color:#b44">&#34;kubernetes-node-pb41&#34;</span> drained</code></pre></div>
<p>As there are four nodes in your cluster, <code>kubectl drain</code>, succeeds and the
<code>zk-0</code> is rescheduled to another node.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">2</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS        RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">2</span>          2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         51s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         1m</code></pre></div>
<p>Keep watching the <code>StatefulSet</code>&rsquo;s Pods in the first terminal and drain the node on which
<code>zk-1</code> is scheduled.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-1 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data <span style="color:#b44">&#34;kubernetes-node-ixsl&#34;</span> cordoned

WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-ixsl, kube-proxy-kubernetes-node-ixsl; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-voc74
pod <span style="color:#b44">&#34;zk-1&#34;</span> deleted
node <span style="color:#b44">&#34;kubernetes-node-ixsl&#34;</span> drained</code></pre></div>
<p>The <code>zk-1</code> Pod cannot be scheduled because the <code>zk</code> <code>StatefulSet</code> contains a <code>PodAntiAffinity</code> rule preventing co-location of the Pods, and as only two nodes are schedulable, the Pod will remain in a Pending state.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">2</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS        RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">2</span>          2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         51s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         1m
zk-1      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s</code></pre></div>
<p>Continue to watch the Pods of the stateful set, and drain the node on which
<code>zk-2</code> is scheduled.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-2 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data
node <span style="color:#b44">&#34;kubernetes-node-i4c4&#34;</span> cordoned

WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-i4c4, kube-proxy-kubernetes-node-i4c4; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-dyrog
WARNING: Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-dyrog; Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-i4c4, kube-proxy-kubernetes-node-i4c4
There are pending pods when an error occurred: Cannot evict pod as it would violate the pod<span style="">&#39;</span>s disruption budget.
pod/zk-2</code></pre></div>
<p>Use <code>CTRL-C</code> to terminate to kubectl.</p>

<p>You cannot drain the third node because evicting <code>zk-2</code> would violate <code>zk-budget</code>. However, the node will remain cordoned.</p>

<p>Use <code>zkCli.sh</code> to retrieve the value you entered during the sanity test from <code>zk-0</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> zk-0 zkCli.sh get /hello</code></pre></div>
<p>The service is still available because its <code>PodDisruptionBudget</code> is respected.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WatchedEvent state:SyncConnected type:None path:null
world
<span style="color:#b8860b">cZxid</span> <span style="color:#666">=</span> 0x200000002
<span style="color:#b8860b">ctime</span> <span style="color:#666">=</span> Wed Dec <span style="color:#666">07</span> <span style="color:#666">00</span>:08:59 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">mZxid</span> <span style="color:#666">=</span> 0x200000002
<span style="color:#b8860b">mtime</span> <span style="color:#666">=</span> Wed Dec <span style="color:#666">07</span> <span style="color:#666">00</span>:08:59 UTC <span style="color:#666">2016</span>
<span style="color:#b8860b">pZxid</span> <span style="color:#666">=</span> 0x200000002
<span style="color:#b8860b">cversion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">dataVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">aclVersion</span> <span style="color:#666">=</span> <span style="color:#666">0</span>
<span style="color:#b8860b">ephemeralOwner</span> <span style="color:#666">=</span> 0x0
<span style="color:#b8860b">dataLength</span> <span style="color:#666">=</span> <span style="color:#666">5</span>
<span style="color:#b8860b">numChildren</span> <span style="color:#666">=</span> <span style="color:#666">0</span></code></pre></div>
<p>Use <a href="/docs/reference/generated/kubectl/kubectl-commands/#uncordon"><code>kubectl uncordon</code></a> to uncordon the first node.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl uncordon kubernetes-node-pb41

node <span style="color:#b44">&#34;kubernetes-node-pb41&#34;</span> uncordoned</code></pre></div>
<p><code>zk-1</code> is rescheduled on this node. Wait until <code>zk-1</code> is Running and Ready.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -w -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>zk

NAME      READY     STATUS    RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">2</span>          1h
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
zk-2      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>          1h
NAME      READY     STATUS        RESTARTS   AGE
zk-0      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">2</span>          2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">2</span>         2h
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         0s
zk-0      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         51s
zk-0      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         1m
zk-1      <span style="color:#666">1</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Terminating   <span style="color:#666">0</span>         2h
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         0s
zk-1      <span style="color:#666">0</span>/1       Pending   <span style="color:#666">0</span>         12m
zk-1      <span style="color:#666">0</span>/1       ContainerCreating   <span style="color:#666">0</span>         12m
zk-1      <span style="color:#666">0</span>/1       Running   <span style="color:#666">0</span>         13m
zk-1      <span style="color:#666">1</span>/1       Running   <span style="color:#666">0</span>         13m</code></pre></div>
<p>Attempt to drain the node on which <code>zk-2</code> is scheduled.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl drain <span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod zk-2 --template <span style="color:#666">{{</span>.spec.nodeName<span style="color:#666">}}</span><span style="color:#a2f;font-weight:bold">)</span> --ignore-daemonsets --force --delete-local-data</code></pre></div>
<p>The output:</p>

<pre><code>node &quot;kubernetes-node-i4c4&quot; already cordoned
WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, or DaemonSet: fluentd-cloud-logging-kubernetes-node-i4c4, kube-proxy-kubernetes-node-i4c4; Ignoring DaemonSet-managed pods: node-problem-detector-v0.1-dyrog
pod &quot;heapster-v1.2.0-2604621511-wht1r&quot; deleted
pod &quot;zk-2&quot; deleted
node &quot;kubernetes-node-i4c4&quot; drained
</code></pre>

<p>This time <code>kubectl drain</code> succeeds.</p>

<p>Uncordon the second node to allow <code>zk-2</code> to be rescheduled.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl uncordon kubernetes-node-ixsl</code></pre></div>
<pre><code>node &quot;kubernetes-node-ixsl&quot; uncordoned
</code></pre>

<p>You can use <code>kubectl drain</code> in conjunction with <code>PodDisruptionBudgets</code> to ensure that your services remain available during maintenance. If drain is used to cordon nodes and evict pods prior to taking the node offline for maintenance, services that express a disruption budget will have that budget respected. You should always allocate additional capacity for critical services so that their Pods can be immediately rescheduled.</p>
















<h2 id="cleaning-up">Cleaning up</h2>
<ul>
<li>Use <code>kubectl uncordon</code> to uncordon all the nodes in your cluster.</li>
<li>You will need to delete the persistent storage media for the PersistentVolumes
used in this tutorial. Follow the necessary steps, based on your environment,
storage configuration, and provisioning method, to ensure that all storage is
reclaimed.</li>
</ul>











    
            
  <h2>Feedback</h2>
  <p class="feedback--prompt">Was this page helpful? </p>
  <button class="button feedback--yes">Yes</button>
  <button class="button feedback--no">No</button>
  <p class="feedback--response feedback--response__hidden">
    Thanks for the feedback. If you have a specific, answerable question about how to use Kubernetes, ask it on
    <a target="_blank" rel="noopener"
      href="https://stackoverflow.com/questions/tagged/kubernetes">
      Stack Overflow</a>.
    Open an issue in the GitHub repo if you want to 
    <a class="feedback--link" target="_blank" rel="noopener"
      href="https://github.com/kubernetes/website/issues/new?title=Issue%20with%20k8s.io">
      report a problem</a>
    or
    <a class="feedback--link" target="_blank" rel="noopener"
      href="https://github.com/kubernetes/website/issues/new?title=Improvement%20for%20k8s.io">
      suggest an improvement</a>.
  </p>
  <script>
    const yes = document.querySelector('.feedback--yes');
    const no = document.querySelector('.feedback--no');
    document.querySelectorAll('.feedback--link').forEach(link => {
      link.href = link.href + window.location.pathname;
    });
    const sendFeedback = (value) => {
      if (!gtag) { console.log('!gtag'); }
      gtag('event', 'click', {
        'event_category': 'Helpful',
        'event_label': window.location.pathname,
        value
      });
    };
    const disableButtons = () => {
      yes.disabled = true;
      yes.classList.add('feedback--button__disabled');
      no.disabled = true;
      no.classList.add('feedback--button__disabled');
    };
    yes.addEventListener('click', () => {
      sendFeedback(1);
      disableButtons();
      document.querySelector('.feedback--response').classList.remove('feedback--response__hidden');
    });
    no.addEventListener('click', () => {
      sendFeedback(0);
      disableButtons();
      document.querySelector('.feedback--response').classList.remove('feedback--response__hidden');
    });
  </script>


    
            <div id="pre-footer"> 
  <hr />

  <div class="issue-button-container">
    <p><a href=""><img src="https://kubernetes-site.appspot.com/UA-36037335-10/GitHub/docs/tutorials/stateful-application/zookeeper.md?pixel" alt="Analytics" /></a></p>
    
    
    <script type="text/javascript">
    PDRTJS_settings_8345992 = {
    "id" : "8345992",
    "unique_id" : "\/docs\/tutorials\/stateful-application\/zookeeper\/",
    "title" : "Running ZooKeeper, A Distributed System Coordinator",
    "permalink" : "https:\/\/kubernetes.io\/docs\/tutorials\/stateful-application\/zookeeper\/"
    };
    (function(d,c,j){if(!document.getElementById(j)){var pd=d.createElement(c),s;pd.id=j;pd.src=('https:'==document.location.protocol)?'https://polldaddy.com/js/rating/rating.js':'http://i0.poll.fm/js/rating/rating.js';s=document.getElementsByTagName(c)[0];s.parentNode.insertBefore(pd,s);}}(document,'script','pd-rating-js'));
    </script>
    <a href="" onclick="window.open('https://github.com/kubernetes/website/issues/new?template=bug-report.md&title=Issue%20with%20' +
    'k8s.io'+window.location.pathname)" class="button issue">Create an Issue</a>
    
    
    
    <a href="https://github.com/kubernetes/website/edit/master/content/en/docs/tutorials/stateful-application/zookeeper.md" class="button issue">Edit This Page</a>
    
  </div>
  

  <div id="lastedit" class="lastedit issue-button-container">
    Page last modified on June 18, 2019 at 10:49 PM PST by
    <a href="https://github.com/kubernetes/website/commit/82650353cb857239ee6b5a8ba4849d08b82fe66a/">Outdated terminology: “kubernetes-minion-group” (#14859)</a> (<a href="https://github.com/kubernetes/website/commits/master/content/en/docs/tutorials/stateful-application/zookeeper.md">Page History</a>)
  </div>
  
</div>

          </div>
        </section>
    </main>
		<footer>
    <div class="light-text main-section">
        <nav>
            
            
            
            <a href="/docs/home/">Home</a>
            
            <a href="/blog/">Blog</a>
            
            <a href="/training/">Training</a>
            
            <a href="/partners/">Partners</a>
            
            <a href="/community/">Community</a>
            
            <a href="/case-studies/">Case Studies</a>
            
        </nav>
        <div class="social" role="region" aria-label="Social hyperlinks">
            <div>
                <a href="https://twitter.com/kubernetesio" class="twitter"><span>Twitter</span></a>
                <a href="https://github.com/kubernetes/kubernetes" class="github"><span>GitHub</span></a>
                <a href="https://slack.k8s.io/" class="slack"><span>Slack</span></a>
            </div>
            <div>
                <a href="https://stackoverflow.com/questions/tagged/kubernetes" class="stack-overflow"><span>Stack Overflow</span></a>
                <a href="https://www.youtube.com/kubernetescommunity" class="youtube"><span>YouTube</span></a>
                <a href="https://discuss.kubernetes.io" class="mailing-list"><span>Forum</span></a>
                <a href="https://calendar.google.com/calendar/embed?src=nt2tcnbtbied3l6gi2h29slvc0%40group.calendar.google.com" class="calendar"><span>Events Calendar</span></a>
            </div>
            <div>
                
                <a href="https://git.k8s.io/community/contributors/guide" class="button">Contribute</a>
            </div>
        </div>
        <div class="miceType center">
            &copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href="https://git.k8s.io/website/LICENSE" class="light-text">CC BY 4.0</a></a>
        </div>
        <div class="miceType center">
            Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage" class="light-text">Trademark Usage page</a>
        </div>
        <div class="miceType center">
            ICP license: 京ICP备17074266号-3
        </div>
    </div>
</footer>

		<button class="flyout-button" onclick="kub.toggleToc()" aria-label="Toggle table of contents visibility"></button>

<script>

(function () {
    window.addEventListener('DOMContentLoaded', init)

        
        function init() {
            window.removeEventListener('DOMContentLoaded', init)
                hideNav()
        }

    function hideNav(toc){
        if (!toc) toc = document.querySelector('#docsToc')
        if (!toc) return
            var container = toc.querySelector('.container')

                
                if (container) {
                    if (container.childElementCount === 0 || toc.querySelectorAll('a.item').length === 1) {
                        toc.style.display = 'none'
                            document.getElementById('docsContent').style.width = '100%'
                    }
                } else {
                    requestAnimationFrame(function () {
                        hideNav(toc)
                    })
                }
    }
})();
</script>



    <script language="application/javascript">
      
      (function addHeadingLinks(){
        var article = document.getElementById('docsContent');
        var headings = article.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(function(heading){
          if(heading.id){
            var a = document.createElement('a');
            a.innerHTML = heading.innerHTML;
            a.href = '#'+heading.id;
            a.classList.add('inpage_heading');
            heading.innerHTML = '';
            heading.appendChild(a);
          }
        });
      })();
    </script>
	</body>
</html>
